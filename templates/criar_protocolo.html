{% extends "layout.html" %}

{% block content %}
<div class="container-fluid">
    <h3 class="page-header">Novo Protocolo</h3>
    <form class="formulario" method="POST" action="{{ url_for('criar_protocolo') }}" id="protocol-form" style="background-color: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <!-- Fields from the old form -->
        <div class="form-group span-3">
            <label for="numeroProtocolo">Número do Protocolo</label>
            <input type="text" id="numeroProtocolo" name="numero" readonly class="form-control">
        </div>
        <div class="form-group span-3">
            <label for="matricula">Matrícula</label>
            <input type="text" id="matricula" name="matricula" class="form-control">
        </div>
        <div class="form-group span-5">
            <label for="nome">Nome Completo</label>
            <input type="text" id="nome" name="nome" class="form-control">
        </div>
        <div class="form-group span-1" style="justify-content: flex-end; align-items: flex-end;">
            <button type="button" id="btnBuscarNome" class="btn btn-secondary" style="width: 100%; height: 38px;">Buscar</button>
        </div>
        <div class="form-group span-6">
            <label for="endereco">Endereço</label>
            <input type="text" id="endereco" name="endereco" class="form-control">
        </div>
        <div class="form-group span-3">
            <label for="municipio">Município</label>
            <input type="text" id="municipio" name="municipio" value="Morada Nova" class="form-control">
        </div>
        <div class="form-group span-3">
            <label for="bairro">Bairro</label>
            <select id="bairro" name="bairro" class="form-select">
                <option value="">Selecione um bairro</option>
            </select>
        </div>
        <div class="form-group span-3">
            <label for="cep">CEP</label>
            <input type="text" id="cep" name="cep" class="form-control">
        </div>
        <div class="form-group span-3">
            <label for="telefone">Telefone</label>
            <input type="text" id="telefone" name="telefone" class="form-control">
        </div>
        <div class="form-group span-3">
            <label for="cpf">CPF</label>
            <input type="text" id="cpf" name="cpf" class="form-control">
        </div>
        <div class="form-group span-3">
            <label for="rg">RG</label>
            <input type="text" id="rg" name="rg" class="form-control">
        </div>
        <div class="form-group span-3">
            <label for="cargo">Cargo/Função</label>
            <input type="text" id="cargo" name="cargo" class="form-control">
        </div>
        <div class="form-group span-6">
            <label for="lotacao">Lotação</label>
            <select id="lotacao" name="lotacao" class="form-select">
                <option value="">Selecione...</option>
            </select>
        </div>
        <div class="form-group span-6">
            <label for="unidade">Unidade de Exercício</label>
            <input type="text" id="unidade" name="unidade_exercicio" class="form-control">
        </div>
        <div class="form-group span-6">
            <label for="tipo">Tipo de Requerimento</label>
            <select id="tipo" name="tipo_requerimento" class="form-select">
                <option value="">Selecione...</option>
            </select>
        </div>
        <div class="form-group span-6">
            <label for="requerAo">Requer ao</label>
            <select id="requerAo" name="requer_ao" class="form-select">
                <option value="">Selecione...</option>
                <option value="SECRETÁRIO">SECRETÁRIO</option>
                <option value="COORDENADOR DE RH">COORDENADOR DE RH</option>
                <option value="PREFEITA">PREFEITA</option>
            </select>
        </div>
        <div class="form-group span-3">
            <label for="dataSolicitacao">Data Solicitação</label>
            <input type="date" id="dataSolicitacao" name="data_solicitacao" class="form-control">
        </div>
        <div class="form-group full-row">
            <label for="complemento">Informações Complementares</label>
            <textarea id="complemento" name="observacoes" rows="8" class="form-control"></textarea>
        </div>

        <!-- Anexos section can be added later if needed -->
        <!--
        <div class="form-group full-row">
            <label for="anexos">Anexar Documentos (limite de 10MB por arquivo)</label>
            <input type="file" id="anexos" multiple onchange="previewFiles(this)" class="form-control">
            <div id="filePreviewContainer" class="file-preview"></div>
        </div>
        -->

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Enviar Requerimento</button>
            <button type="button" id="imprimirBtn" class="btn btn-success">Imprimir</button>
            <a href="{{ url_for('home') }}" class="btn btn-secondary">Voltar</a>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/pdf_utils.js') }}"></script>
<script>
// This script is specific to the criar_protocolo.html page

// Helper function to populate dropdowns
async function populateDropdown(apiUrl, elementId) {
    const select = document.getElementById(elementId);
    if (!select) return;
    try {
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.json();
        const currentValue = select.value;
        select.innerHTML = '<option value="">Selecione...</option>';
        data.forEach(item => {
            const option = new Option(item, item);
            select.add(option);
        });
        if (currentValue) select.value = currentValue;
    } catch (error) {
        console.error(`Failed to populate dropdown ${elementId}:`, error);
    }
}

// Helper function to fetch server data by registration number
async function fetchServidorByMatricula() {
    const matricula = this.value.trim();
    if (!matricula) return;
    try {
        const response = await fetch(`/api/servidor/${matricula}`);
        if (response.ok) {
            const servidor = await response.json();
            preencherCamposServidor(servidor);
        }
    } catch (error) {
        console.error('Erro ao buscar servidor por matrícula:', error);
    }
}

// Helper function to fetch CEP data
async function fetchCep() {
    const cep = this.value.replace(/\D/g, '');
    if (cep.length !== 8) return;
    try {
        const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await response.json();
        if (!data.erro) {
            document.getElementById('endereco').value = data.logradouro || '';
            document.getElementById('municipio').value = data.localidade || '';
            document.getElementById('bairro').value = data.bairro || '';
        }
    } catch (error) {
        console.error('Erro ao buscar CEP:', error);
    }
}

// Helper function to fill form fields with server data
function preencherCamposServidor(servidor) {
    if(!servidor) return;
    document.getElementById('nome').value = servidor.nome || '';
    document.getElementById('lotacao').value = servidor.lotacao || '';
    document.getElementById('cargo').value = servidor.cargo || '';
    document.getElementById('unidade').value = servidor.unidade_de_exercicio || '';
}

// Helper function to show the server search modal
function openServidorSearchModal() {
    const modalElement = document.getElementById('modalBuscaServidor');
    if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        document.getElementById('buscaNomeInput').value = '';
        document.getElementById('buscaNomeResultados').innerHTML = '';
        modal.show();
    }
}

// Helper function to perform server search by name
async function searchServidorByName() {
    const searchTerm = this.value.trim();
    const resultadosDiv = document.getElementById('buscaNomeResultados');
    if (!resultadosDiv) return;
    if (searchTerm.length < 3) {
        resultadosDiv.innerHTML = '<p class="text-center text-muted">Digite ao menos 3 caracteres.</p>';
        return;
    }
    try {
        const response = await fetch(`/api/servidores/search?nome=${encodeURIComponent(searchTerm)}`);
        const servidores = await response.json();
        resultadosDiv.innerHTML = '';
        if (servidores.error) {
            resultadosDiv.innerHTML = `<p class="text-danger">${servidores.error}</p>`;
            return;
        }
        if (servidores.length > 0) {
            servidores.forEach(servidor => {
                const div = document.createElement('a');
                div.href = '#';
                div.className = 'list-group-item list-group-item-action';
                div.innerHTML = `<strong>${servidor.nome}</strong><br><small>Matrícula: ${servidor.matricula}</small>`;
                div.onclick = (e) => {
                    e.preventDefault();
                    preencherCamposServidor(servidor);
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalBuscaServidor'));
                    modal.hide();
                };
                resultadosDiv.appendChild(div);
            });
        } else {
            resultadosDiv.innerHTML = '<p class="text-center">Nenhum servidor encontrado.</p>';
        }
    } catch (error) {
        console.error('Erro ao buscar servidor por nome:', error);
        resultadosDiv.innerHTML = '<p class="text-danger text-center">Erro ao conectar com o servidor.</p>';
    }
}

// Helper function to generate the next protocol number
async function gerarNumeroProtocolo() {
    const anoAtual = new Date().getFullYear();
    try {
        const res = await fetch(`/protocolos/ultimoNumero/${anoAtual}`);
        if (!res.ok) throw new Error('Failed to fetch last protocol number');
        const data = await res.json();
        document.getElementById('numeroProtocolo').value = `${String((data.ultimo || 0) + 1).padStart(4, '0')}/${anoAtual}`;
    } catch (error) {
        console.error("Erro ao gerar número:", error);
        document.getElementById('numeroProtocolo').value = `0001/${anoAtual}`;
    }
}


// Main initialization logic for this page
document.addEventListener('DOMContentLoaded', function() {
    // Populate dropdowns
    populateDropdown('/api/lotacoes', 'lotacao');
    populateDropdown('/api/tipos_requerimento', 'tipo');
    populateDropdown('/api/bairros', 'bairro');

    // Add event listeners
    document.getElementById('matricula').addEventListener('blur', fetchServidorByMatricula);
    document.getElementById('cep').addEventListener('blur', fetchCep);
    document.getElementById('btnBuscarNome').addEventListener('click', openServidorSearchModal);
    document.getElementById('buscaNomeInput').addEventListener('input', searchServidorByName);
    document.getElementById('imprimirBtn').addEventListener('click', () => window.previsualizarPDF(null, true));

    // Generate protocol number and set current date
    gerarNumeroProtocolo();
    const dataSolicitacaoInput = document.getElementById('dataSolicitacao');
    if (dataSolicitacaoInput && !dataSolicitacaoInput.value) {
        dataSolicitacaoInput.value = new Date().toISOString().split('T')[0];
    }
});
</script>
{% endblock %}

<!-- Modal Busca Servidor -->
<div class="modal fade" id="modalBuscaServidor" tabindex="-1" aria-labelledby="modalBuscaServidorLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalBuscaServidorLabel">Buscar Servidor por Nome</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="buscaNomeInput" class="form-label">Nome do Servidor</label>
          <input type="text" class="form-control" id="buscaNomeInput" placeholder="Digite para buscar...">
        </div>
        <div id="buscaNomeResultados" class="list-group">
          <!-- Search results will appear here -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>
