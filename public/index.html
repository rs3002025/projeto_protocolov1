<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sistema de Protocolo</title>
<style>
    /* --- ESTILOS GERAIS --- */
    body { margin: 0; font-family: Arial, sans-serif; background: #f5f5f5; }
    body.loading { visibility: hidden; }
    .container { max-width: 1500px; margin: 40px auto; background: #fff; border-radius: 16px; box-shadow: 0 0 10px rgba(0,0,0,0.1); overflow: hidden; padding-bottom: 30px; }
    .header { background: #2e7d32; color: white; padding: 20px; text-align: center; border-radius: 0 0 15px 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); position: relative; }
    .header img { height: 60px; width: auto; }
    .header h2, .header h3 { margin: 5px 0; }
    .content { padding: 20px 30px; display: none; }
    .content.active { display: block; }
    .menu, .login-screen, .form-screen, .protocolos-screen, .config-screen, .meus-protocolos-screen, .relatorios-screen, .dashboard-screen { display: none; }
    .active { display: block; }
    .formulario { display: grid; grid-template-columns: repeat(12, 1fr); gap: 15px 20px; }
    .form-group { display: flex; flex-direction: column; }
    .full-row { grid-column: span 12; }
    .span-6 { grid-column: span 6; }
    .span-3 { grid-column: span 3; }
    label { margin-bottom: 5px; font-weight: 600; }
    input, select, textarea { border: 1px solid #ccc; border-radius: 6px; padding: 8px; font-size: 1em; }
    button { padding: 10px 12px; border: none; background: #2e7d32; color: white; border-radius: 8px; cursor: pointer; margin: 5px 10px 5px 0; transition: background-color 0.2s; }
    button:hover { background-color: #1b5e20; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; word-break: break-word; }
    th { background-color: #e0e0e0; }
    .filtros { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; background: #f5f5f5; padding: 15px; border-radius: 8px; }
    .filtros input, .filtros select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
    #modeloProtocolo, #modeloRelatorio { display: none; }

    /* --- ESTILOS DA TELA DE LOGIN --- */
    .login-screen.active { display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px 20px; }
    .login-form-container { width: 100%; max-width: 400px; padding: 30px; background-color: #ffffff; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); box-sizing: border-box; }
    .login-form-container h3 { text-align: center; color: #333; margin-top: 0; }
    .login-form-container label { width: 100%; text-align: left; margin-bottom: 8px; font-size: 0.9em; color: #555; }
    .login-form-container input { width: 100%; padding: 12px; margin-bottom: 20px; box-sizing: border-box; }
    .login-form-container button { width: 100%; padding: 12px; margin-top: 10px; margin-left: 0; font-size: 1.1em; font-weight: bold; }

    /* --- ESTILOS DO MENU PRINCIPAL --- */
    .menu.active { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; padding: 40px; }
    .menu button { margin: 0; min-height: 110px; font-size: 1.1em; font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; transition: transform 0.2s ease, box-shadow 0.2s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .menu button:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.15); }
    
    /* Pagina√ß√£o */
    #paginacaoProtocolos, #paginacaoMeusProtocolos { text-align: center; margin-top: 20px; }
    #paginacaoProtocolos span, #paginacaoMeusProtocolos span { margin: 0 5px; color: #888; }

    /* Notifica√ß√µes */
    #notification-bell { position: absolute; top: 25px; right: 30px; font-size: 24px; cursor: pointer; display: none; }
    #notification-count { position: absolute; top: -5px; right: -10px; background-color: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px; font-weight: bold; line-height: 1; }

    /* Dashboard */
    .dashboard-cards { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 40px; }
    .stat-card { flex: 1; min-width: 200px; background-color: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .stat-value { font-size: 3em; font-weight: bold; color: #2e7d32; }
    .stat-label { font-size: 1.1em; color: #6c757d; }
    .chart-container { max-width: 800px; margin: 0 auto; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="loading">
<div class="container">
  <div class="header">
    <img src="/img/logo.png" alt="Logo" class="logo">
    <h2>Prefeitura de Morada Nova</h2>
    <h3>Sistema de Protocolo</h3>
    <div id="notification-bell" onclick="mostrarTela('meusProtocolos')">
      <span>üîî</span>
      <span id="notification-count">0</span>
    </div>
  </div>

  <div id="login" class="login-screen content">
    <div class="login-form-container">
      <h3>Acesso ao Sistema</h3>
      <label for="usuario">Usu√°rio</label>
      <input type="text" id="usuario" />
      <label for="senha">Senha</label>
      <input type="password" id="senha" />
      <button onclick="logar()">Entrar</button>
      <p id="loginMsg" style="color:red;"></p>
    </div>
  </div>

  <div id="menu" class="menu content">
    <button id="btnDashboard" onclick="mostrarTela('dashboard')">üìà Dashboard</button>
    <button id="btnNovo" onclick="mostrarTela('form')">üìÑ Novo Protocolo</button>
    <button onclick="mostrarTela('protocolos')">üóÇÔ∏è Todos os Protocolos</button>
    <button onclick="mostrarTela('relatorios')" id="btnRelatorios">üìä Relat√≥rios</button>
    <button onclick="mostrarTela('meusProtocolos')">üìÇ Meus Protocolos</button>
    <button id="btnConfig" onclick="mostrarTela('config')">‚öôÔ∏è Configura√ß√µes</button>
    <button onclick="abrirModalAlterarSenha()">üîë Alterar Senha</button>
    <button onclick="sair()">üö™ Sair</button>
  </div>

  <div id="dashboard" class="dashboard-screen content">
    <h3>Dashboard Gerencial</h3>
    <div class="filtros">
        <input type="date" id="dashDataInicio" title="Data de In√≠cio">
        <input type="date" id="dashDataFim" title="Data Final">
        <select id="dashStatus"><option value="">Todos os Status</option></select>
        <select id="dashTipo"><option value="">Todo tipo de Requerimento</option></select>
        <select id="dashLotacao"><option value="">Todas as Lota√ß√µes</option></select>
        <button onclick="carregarDashboard()">Filtrar</button>
    </div>
    <div class="dashboard-cards">
        <div class="stat-card">
            <div class="stat-value" id="stat-novos">0</div>
            <div class="stat-label" id="stat-novos-label">Novos no Per√≠odo</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-pendentes">0</div>
            <div class="stat-label">Pendentes (> 15 dias)</div>
        </div>
    </div>
    <div class="chart-container">
        <h4>Top 5 Tipos de Requerimento (nos filtros)</h4>
        <canvas id="tiposChart"></canvas>
    </div>
    <button onclick="mostrarTela('menu')">üîô Voltar</button>
  </div>

  <div id="form" class="form-screen content">
      <form class="formulario" onsubmit="return false;">
        <div class="form-group span-3"><label>N√∫mero do Protocolo</label><input type="text" id="numeroProtocolo" readonly></div>
        <div class="form-group span-3"><label>Matr√≠cula</label><input type="text" id="matricula"></div>
        <div class="form-group span-6"><label>Nome Completo</label><input type="text" id="nome"></div>
        <div class="form-group span-6"><label>Endere√ßo</label><input type="text" id="endereco"></div>
        <div class="form-group span-3"><label>Munic√≠pio</label><input type="text" id="municipio" value="Morada Nova"></div>
        <div class="form-group span-3"><label for="bairro">Bairro</label><select id="bairro" name="bairro" class="form-control"><option value="">Selecione um bairro</option></select></div>
        <div class="form-group span-3"><label>CEP</label><input type="text" id="cep"></div>
        <div class="form-group span-3"><label>Telefone</label><input type="text" id="telefone"></div>
        <div class="form-group span-3"><label>CPF</label><input type="text" id="cpf"></div>
        <div class="form-group span-3"><label>RG</label><input type="text" id="rg"></div>
        <div class="form-group span-3"><label>Data de Expedi√ß√£o</label><input type="date" id="dataExpedicao"></div>
        <div class="form-group span-3"><label>Cargo/Fun√ß√£o</label><input type="text" id="cargo"></div>
        <div class="form-group span-6"><label>Lota√ß√£o</label><select id="lotacao"><option value="">Selecione...</option></select></div>
        <div class="form-group span-6"><label>Unidade de Exerc√≠cio</label><input type="text" id="unidade"></div>
        <div class="form-group span-6"><label>Tipo de Requerimento</label><select id="tipo"><option value="">Selecione...</option></select></div>
        <div class="form-group span-6"><label>Requer ao</label><select id="requerAo"><option value="">Selecione...</option><option value="SECRET√ÅRIO">SECRET√ÅRIO</option><option value="COORDENADOR DE RH">COORDENADOR DE RH</option><option value="PREFEITA">PREFEITA</option></select></div>
        <div class="form-group span-3"><label>Data Solicita√ß√£o</label><input type="date" id="dataSolicitacao"></div>
        <div class="form-group full-row"><label>Informa√ß√µes Complementares</label><textarea id="complemento" rows="8"></textarea></div>
      </form>
      <button onclick="enviarRequerimento()">Enviar Requerimento</button>
      <button onclick="previsualizarPDF(null, true)">Imprimir</button>
      <button onclick="mostrarTela('menu')">Voltar</button>
  </div>

  <div id="relatorios" class="relatorios-screen content">
    <h3>üîç Relat√≥rios e Pesquisa Avan√ßada</h3>
    <form class="filtros" onsubmit="return false;">
        <input type="text" id="filtroNumero" placeholder="N√∫mero do Protocolo">
        <input type="text" id="filtroNome" placeholder="Nome do Requerente">
        <select id="filtroStatus">
        <option value="">Todos os Status</option>
        <option value="Em an√°lise">Em an√°lise</option>
        <option value="Pendente de documento">Pendente de documento</option>
        <option value="Finalizado">Finalizado</option>
        <option value="Conclu√≠do">Conclu√≠do</option>
        <option value="Encaminhado">Encaminhado</option>
        </select>
        <input type="date" id="filtroDataInicio" title="Data de In√≠cio">
        <input type="date" id="filtroDataFim" title="Data Final">
        <select id="filtroTipo"><option value="">Todo tipo de Requerimento</option></select>
        <select id="filtroLotacao"><option value="">Todas as Lota√ß√µes</option></select>
    </form>
    <div>
        <button onclick="pesquisarProtocolos()">Pesquisar</button>
        <button onclick="previsualizarRelatorioPDF()">üìÑ Pr√©-visualizar PDF</button>
        <button onclick="exportarRelatorioExcel()">üìä Exportar para Excel</button>
        <button onclick="limparFiltrosRelatorio()">Limpar Filtros</button>
        <button onclick="mostrarTela('menu')">üîô Voltar</button>
    </div>
    <table id="tabelaRelatorios">
        <thead>
        <tr>
            <th>N√∫mero</th><th>Requerente</th><th>Matr√≠cula</th><th>Tipo de Requerimento</th><th>Data</th><th>Status</th><th>Respons√°vel</th>
        </tr>
        </thead>
        <tbody id="resultadosPesquisa"></tbody>
    </table>
  </div>

  <div id="protocolos" class="protocolos-screen content">
    <h3>üìã Lista de Protocolos Enviados</h3>
    <table>
      <thead>
        <tr>
            <th>N√∫mero</th><th>Matr√≠cula</th><th>Nome</th><th>Tipo</th><th>Status</th><th>Respons√°vel</th><th>A√ß√£o</th>
        </tr>
      </thead>
      <tbody id="tabelaProtocolos"></tbody>
    </table>
    <button onclick="mostrarTela('menu')">Voltar</button>
    <div id="paginacaoProtocolos"></div>
  </div>

  <div id="meusProtocolos" class="meus-protocolos-screen content">
      <h3>üìÇ Meus Protocolos</h3>
      <div class="filtros" style="padding: 10px 0;">
        <input type="text" id="filtroMeusProtocolosNumero" placeholder="Filtrar por N√∫mero">
        <input type="text" id="filtroMeusProtocolosNome" placeholder="Filtrar por Nome">
        <button onclick="listarMeusProtocolos()">Filtrar</button>
        <button onclick="limparFiltrosMeusProtocolos()">Limpar Filtros</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>N√∫mero</th><th>Nome</th><th>Status</th><th>A√ß√£o</th>
          </tr>
        </thead>
        <tbody id="meusProtocolosTabela"></tbody>
      </table>
      <button onclick="voltarDeMeusProtocolos()">Voltar</button>
      <div id="paginacaoMeusProtocolos"></div>
  </div>

  <div id="config" class="config-screen content">
    <h3>‚öôÔ∏è Configura√ß√µes</h3>
    <div class="form-group full-row">
      <label>Email do Sistema:</label>
      <input type="email" id="emailSistemaConfig" />
      <button onclick="salvarEmailSistema()">Salvar Email</button>
    </div>
    <hr style="margin: 20px 0;">
    <h4>Adicionar Novo Usu√°rio</h4>
    <div class="form-group full-row">
      <input type="text" id="nomeCompleto" placeholder="Nome completo" />
      <input type="text" id="novoUsuario" placeholder="Nome de usu√°rio" />
      <input type="text" id="cpfUsuario" placeholder="CPF (somente n√∫meros)" />
      <input type="password" id="novaSenha" placeholder="Senha" />
      <input type="email" id="novoEmail" placeholder="E-mail do usu√°rio" />
      <select id="nivelUsuario">
        <option value="usuario">Usu√°rio</option>
        <option value="comum">Comum</option>
        <option value="padrao">Padr√£o</option>
        <option value="admin">Administrador</option>
      </select>
      <button onclick="cadastrarUsuario()">Cadastrar Usu√°rio</button>
    </div>
    <hr style="margin: 20px 0;">
    <h4>Usu√°rios Cadastrados</h4>
    <table style="width:100%;">
      <thead>
        <tr>
          <th>Nome</th><th>Login</th><th>Email</th><th>Tipo</th><th>Status</th><th style="width: 280px;">A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tabelaUsuarios"></tbody>
    </table>
    <hr style="margin: 20px 0;">
    <h4>Gerenciar Listas</h4>
    <h5>Tipos de Requerimento</h5>
    <div class="form-group" style="flex-direction: row; gap: 10px; align-items: center;">
        <input type="text" id="novoTipoNome" placeholder="Nome do novo tipo" style="flex-grow: 1;">
        <button onclick="adicionarItem('tipos')">Adicionar</button>
    </div>
    <table style="width:100%;">
        <thead><tr><th>Nome</th><th>Status</th><th style="width: 120px;">A√ß√µes</th></tr></thead>
        <tbody id="tabelaTipos"></tbody>
    </table>
    <br>
    <h5>Lota√ß√µes</h5>
    <div class="form-group" style="flex-direction: row; gap: 10px; align-items: center;">
        <input type="text" id="novaLotacaoNome" placeholder="Nome da nova lota√ß√£o" style="flex-grow: 1;">
        <button onclick="adicionarItem('lotacoes')">Adicionar</button>
    </div>
    <table style="width:100%;">
        <thead><tr><th>Nome</th><th>Status</th><th style="width: 120px;">A√ß√µes</th></tr></thead>
        <tbody id="tabelaLotacoes"></tbody>
    </table>
    <hr style="margin: 20px 0;">
    <h4>Gerar Backup de Protocolos</h4>
    <label>Data In√≠cio:</label>
    <input type="date" id="backupDataInicio" />
    <label>Data Fim:</label>
    <input type="date" id="backupDataFim" />
    <button onclick="gerarBackup()">Gerar Backup</button>
    <br><br>
    <button onclick="mostrarTela('menu')">Voltar</button>
  </div>
</div>

<div id="modeloProtocolo" style="display: none;">
  <style>
    .pdf-body { font-family: "Segoe UI", "Open Sans", sans-serif; color: #000; margin: 0; padding: 0; box-sizing: border-box; }
    .doc-container { background: white; width: 100%; max-width: 800px; margin: 20px auto; padding: 40px 50px; border: 1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .pdf-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #ddd; padding-bottom: 15px; margin-bottom: 20px;}
    .logo-pdf img { height: 80px; }
    #qrcode-container { padding-left: 20px; }
    .titulo-principal-pdf { text-align: center; margin: 2px 0; font-size: 22px; }
    .titulo-central-pdf { text-align: center; margin-bottom: 20px; }
    .titulo-central-pdf span { background: #2e7d32; color: white; font-size: 16px; padding: 8px 20px; border-radius: 4px; display: inline-block; font-weight: bold; }
    .info-pdf { margin-bottom: 20px; display: flex; justify-content: space-between; gap: 20px; }
    .campo-destaque-pdf { font-weight: bold; font-size: 14px; background-color: #2e7d32; color: white; padding: 8px 12px; border-radius: 5px; margin: 4px 0; flex: 1; text-align: center; }
    .section-title-pdf { background: #f0f0f0; font-weight: bold; padding: 6px 10px; border-left: 4px solid #4caf50; margin-top: 20px; }
    .grid-pdf { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 30px; margin-top: 10px; }
    .grid-pdf div { font-size: 14px; }
    .box-pdf { border: 1px solid #ddd; padding: 10px; border-radius: 6px; background: #fafafa; margin-top: 10px; font-style: italic; }
    .assinaturas-pdf { display: flex; justify-content: space-between; margin-top: 100px; page-break-inside: avoid; }
    .assinatura-pdf { text-align: center; width: 45%; }
    .linha-pdf { border-top: 1px solid #000; margin-top: 40px; }
    .rodape-pdf { text-align: center; margin-top: 40px; page-break-inside: avoid; }
    .rodape-pdf img { max-width: 100%; height: auto; }
  </style>
  <div class="pdf-body doc-container">
    <div class="pdf-header">
      <div class="logo-pdf"><img src="/img/logo.png" alt="Logo Prefeitura" /></div>
      <div id="qrcode-container"></div>
    </div>
    <h1 class="titulo-principal-pdf">Secretaria da Administra√ß√£o</h1>
    <div class="titulo-central-pdf"><span>PROTOCOLO DE REQUERIMENTO</span></div>
    <div class="info-pdf">
      <p class="campo-destaque-pdf"><strong>N√∫mero do Protocolo:</strong> <span id="doc_numero"></span></p>
      <p class="campo-destaque-pdf"><strong>Data da Solicita√ß√£o:</strong> <span id="doc_dataSolicitacao"></span></p>
    </div>
    <div class="section-title-pdf">DADOS DO REQUERENTE</div>
    <div class="grid-pdf">
      <div><strong>Nome:</strong> <span id="doc_nome"></span></div><div><strong>Bairro:</strong> <span id="doc_bairro"></span></div>
      <div><strong>Matr√≠cula:</strong> <span id="doc_matricula"></span></div><div><strong>Munic√≠pio:</strong> <span id="doc_municipio"></span></div>
      <div><strong>CPF:</strong> <span id="doc_cpf"></span></div><div><strong>CEP:</strong> <span id="doc_cep"></span></div>
      <div><strong>RG:</strong> <span id="doc_rg"></span></div><div><strong>Lota√ß√£o:</strong> <span id="doc_lotacao"></span></div>
      <div><strong>Endere√ßo:</strong> <span id="doc_endereco"></span></div><div><strong>Unidade de Exerc√≠cio:</strong> <span id="doc_unidade"></span></div>
      <div><strong>Telefone:</strong> <span id="doc_telefone"></span></div><div><strong>Cargo/Fun√ß√£o:</strong> <span id="doc_cargo"></span></div>
    </div>
    <div class="section-title-pdf">DADOS DO REQUERIMENTO</div>
    <div style="margin-top: 10px;">
      <div style="margin-bottom: 6px;"><strong>Tipo de Requerimento:</strong> <span id="doc_tipo"></span></div>
      <div style="margin-bottom: 10px;"><strong>Requer ao:</strong> <span id="doc_requerAo"></span></div>
    </div>
    <div class="box-pdf" id="doc_complemento"></div>
    <div class="assinaturas-pdf">
      <div class="assinatura-pdf"><div class="linha-pdf"></div>Assinatura do Requerente</div>
      <div class="assinatura-pdf"><div class="linha-pdf"></div>Respons√°vel pelo Protocolo</div>
    </div>
    <div class="rodape-pdf"><img src="/img/rodape.jpg" alt="Rodap√©" /></div>
  </div>
</div>
<div id="pdfModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);">
  <div style="background-color: #fefefe; margin: 20px auto; padding: 0; border: 1px solid #888; width: 95%; max-width: 800px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);">
    <div style="text-align: right; background: #2e7d32; padding: 5px 15px;"><span style="color: white; font-size: 28px; font-weight: bold; cursor: pointer;" onclick="fecharModal('pdfModal')">&times;</span></div>
    <div id="pdfContent" style="padding: 20px;"></div>
    <div style="text-align: center; padding: 10px; border-top: 1px solid #ddd;"><button onclick="gerarPDF()">Gerar e Salvar PDF</button></div>
  </div>
</div>
<div id="relatorioModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);">
    <div style="background-color: #fefefe; margin: 20px auto; padding: 0; border: 1px solid #888; width: 95%; max-width: 900px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);">
      <div style="text-align: right; background: #2e7d32; padding: 5px 15px;"><span style="color: white; font-size: 28px; font-weight: bold; cursor: pointer;" onclick="fecharModal('relatorioModal')">&times;</span></div>
      <div id="relatorioContent" style="padding: 20px; max-height: 80vh; overflow-y: auto;"></div>
      <div style="text-align: center; padding: 10px; border-top: 1px solid #ddd;"><button onclick="salvarRelatorioPDF()">Salvar PDF</button></div>
    </div>
</div>
<div id="modalEncaminhar" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.3); width:300px; max-width:90%;">
    <h3>Encaminhar Protocolo</h3>
    <label for="selectUsuarioEncaminhar" style="display:block; text-align:left; margin-bottom:5px;">Para o usu√°rio:</label>
    <select id="selectUsuarioEncaminhar" style="width:100%; padding:8px; margin-bottom:10px;"></select>
    <label for="statusEncaminhamento" style="display:block; text-align:left; margin-bottom:5px;">Definir status como:</label>
    <input type="text" id="statusEncaminhamento" style="width:100%; padding:8px; margin-bottom:15px; box-sizing: border-box;">
    <div style="text-align:right;">
      <button onclick="confirmarEncaminhamento()" style="margin-right:10px;">Confirmar</button>
      <button onclick="fecharModal('modalEncaminhar')">Cancelar</button>
    </div>
  </div>
</div>
<div id="modalAtualizarStatus" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.3); width:400px; max-width:90%;">
    <h3>Atualizar Status do Protocolo</h3>
    <label for="statusSelect">Status:</label>
    <select id="statusSelect" onchange="handleStatusChange(this)" style="width:100%; padding:8px; margin-bottom:10px;">
      <option value="Em an√°lise">Em an√°lise</option>
      <option value="Pendente de documento">Pendente de documento</option>
      <option value="Finalizado">Finalizado</option>
      <option value="Conclu√≠do">Conclu√≠do</option>
      <option value="Outro">Outro (digitar)</option>
    </select>
    <input type="text" id="statusCustom" placeholder="Digite o status personalizado" style="display:none; width:100%; padding:8px; margin-bottom:10px; box-sizing: border-box;">
    <label for="observacaoAtualizacao">Observa√ß√£o (opcional):</label>
    <textarea id="observacaoAtualizacao" rows="4" style="width:100%; padding:8px; margin-bottom:15px; box-sizing: border-box;"></textarea>
    <div style="text-align:right;">
      <button onclick="confirmarAtualizacaoStatus()" style="margin-right:10px;">Confirmar</button>
      <button onclick="fecharModal('modalAtualizarStatus')">Cancelar</button>
    </div>
  </div>
</div>
<div id="modalEditarUsuario" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:20px; border-radius:8px; width:400px; max-width:90%;">
    <h3>Editar Usu√°rio</h3>
    <input type="hidden" id="editUserId">
    <div class="form-group"><label>Nome Completo</label><input type="text" id="editNomeCompleto"></div>
    <div class="form-group"><label>Login</label><input type="text" id="editLogin"></div>
    <div class="form-group"><label>Email</label><input type="email" id="editEmail"></div>
    <div class="form-group"><label>CPF</label><input type="text" id="editCpf"></div>
    <div class="form-group">
      <label>Tipo</label>
      <select id="editTipo">
        <option value="usuario">Usu√°rio</option>
        <option value="comum">Comum</option>
        <option value="padrao">Padr√£o</option>
        <option value="admin">Administrador</option>
      </select>
    </div>
    <div style="text-align:right; margin-top:15px;">
      <button onclick="confirmarEdicaoUsuario()">Salvar Altera√ß√µes</button>
      <button onclick="fecharModal('modalEditarUsuario')">Cancelar</button>
    </div>
  </div>
</div>
<div id="modalResetarSenha" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:20px; border-radius:8px; width:400px; max-width:90%;">
    <h3>Resetar Senha</h3>
    <input type="hidden" id="resetUserId">
    <div class="form-group">
      <label>Nova Senha</label>
      <input type="password" id="resetNovaSenha">
    </div>
    <div style="text-align:right; margin-top:15px;">
      <button onclick="confirmarResetSenha()">Confirmar Nova Senha</button>
      <button onclick="fecharModal('modalResetarSenha')">Cancelar</button>
    </div>
  </div>
</div>
<div id="modalAlterarSenha" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:20px; border-radius:8px; width:400px; max-width:90%;">
    <h3>Alterar Minha Senha</h3>
    <div class="form-group"><label>Senha Atual</label><input type="password" id="senhaAtual"></div>
    <div class="form-group"><label>Nova Senha</label><input type="password" id="alterarNovaSenha"></div>
    <div class="form-group"><label>Confirmar Nova Senha</label><input type="password" id="confirmarNovaSenha"></div>
    <div style="text-align:right; margin-top:15px;">
      <button onclick="confirmarAlteracaoSenha()">Salvar Nova Senha</button>
      <button onclick="fecharModal('modalAlterarSenha')">Cancelar</button>
    </div>
  </div>
</div>

<script defer>

// Vari√°veis Globais
const itensPorPagina = 10;
let paginaAtualTodos = 1;
let paginaAtualMeus = 1;
let tiposChartInstance = null;
window.opcoesTipos = [];
window.opcoesLotacoes = [];

// Fun√ß√µes de Inicializa√ß√£o (executadas quando o DOM estiver pronto)
document.addEventListener('DOMContentLoaded', () => {
    window.usuarioLogado = localStorage.getItem('usuarioLogado') || "";
    window.nivelUsuario = localStorage.getItem('nivelUsuario') || "";
    window.usuarioLogin = localStorage.getItem('usuarioLogin') || "";
    
    document.body.classList.remove('loading');

    if (window.usuarioLogado) {
        document.getElementById('btnDashboard').style.display = (window.nivelUsuario === 'admin' || window.nivelUsuario === 'padrao') ? 'flex' : 'none';
        document.getElementById('btnConfig').style.display = window.nivelUsuario === "admin" ? "flex" : "none";
        document.getElementById('btnNovo').style.display = (window.nivelUsuario === "admin" || window.nivelUsuario === "padrao" || window.nivelUsuario === "usuario") ? "flex" : "none";
        document.getElementById('btnRelatorios').style.display = (window.nivelUsuario === "admin" || window.nivelUsuario === "padrao") ? "flex" : "none";

        carregarOpcoesDropdowns().then(() => {
            if (window.nivelUsuario === "comum") {
                mostrarTela('meusProtocolos');
            } else {
                mostrarTela('menu');
            }
            verificarNotificacoes();
        });

    } else {
        mostrarTela('login');
    }

    document.getElementById('matricula').addEventListener('blur', async function() {
        const matricula = this.value.trim();
        if (!matricula) { preencherCamposServidor(null); return; }
        try {
            const response = await fetch(`/protocolos/servidor/${encodeURIComponent(matricula)}`);
            if (!response.ok) { return; }
            const servidor = await response.json();
            preencherCamposServidor(servidor);
        } catch (error) { console.error('Erro ao buscar servidor:', error); }
    });

    document.getElementById('cep').addEventListener('blur', async function () {
        const cep = this.value.replace(/\D/g, '');
        if (cep.length !== 8) {
            if(cep.length > 0) alert('CEP inv√°lido. Digite os 8 d√≠gitos.');
            return;
        }
        try {
            const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            const data = await response.json();
            if (data.erro) { alert('CEP n√£o encontrado!'); return; }
            document.getElementById('endereco').value = data.logradouro || '';
            document.getElementById('bairro').value = data.bairro || '';
            document.getElementById('municipio').value = data.localidade || '';
        } catch (error) { console.error('Erro ao buscar CEP:', error); alert('Erro ao buscar o CEP.'); }
    });
});

// Fun√ß√µes Globais (acess√≠veis via onclick)
window.logar = async function() {
    const user = document.getElementById('usuario').value;
    const senha = document.getElementById('senha').value;
    const msg = document.getElementById('loginMsg');
    try {
        const res = await fetch('/login', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ login: user, senha: senha })
        });
        const data = await res.json();
        if (data.sucesso && data.usuario) {
            localStorage.setItem('usuarioLogado', data.usuario.nome);
            localStorage.setItem('usuarioLogin', data.usuario.login);
            localStorage.setItem('nivelUsuario', data.usuario.tipo);
            window.location.reload();
        } else {
            msg.textContent = "Usu√°rio ou senha incorretos.";
        }
    } catch(err) { console.error("Erro no login:", err); msg.textContent = "Erro ao conectar ao servidor."; }
};
window.sair = function() {
    localStorage.clear();
    window.location.reload();
};
window.mostrarTela = async function(tela) {
    ['login','menu','dashboard','form','config','protocolos','meusProtocolos','relatorios'].forEach(id => {
        document.getElementById(id)?.classList.remove('active');
    });
    document.getElementById(tela).classList.add('active');

    if (tela === 'meusProtocolos') {
        const usuarioLogin = localStorage.getItem('usuarioLogin');
        if (usuarioLogin) {
            try {
                await fetch('/protocolos/notificacoes/ler', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ usuarioLogin })
                });
                await verificarNotificacoes();
            } catch (err) { console.error('Erro ao marcar notifica√ß√µes como lidas:', err); }
        }
    }
    
    if (tela === 'protocolos') listarProtocolos();
    if (tela === 'meusProtocolos') listarMeusProtocolos();
    if (tela === 'form') { popularDropdownsFormulario(); gerarNumeroProtocolo(); }
    if (tela === 'config') { atualizarListaUsuarios(); carregarTabelaGestao('tipos'); carregarTabelaGestao('lotacoes'); }
    if (tela === 'relatorios') { popularFiltrosRelatorio(); pesquisarProtocolos(); }
    if (tela === 'dashboard') { popularFiltrosDashboard(); carregarDashboard(); }
};
window.gerarNumeroProtocolo = async function() {
  const anoAtual = new Date().getFullYear();
  try {
    const res = await fetch(`/protocolos/ultimoNumero/${anoAtual}`);
    const data = await res.json();
    document.getElementById('numeroProtocolo').value = `${String((data.ultimo || 0) + 1).padStart(4, '0')}/${anoAtual}`;
  } catch (error) { console.error("Erro ao gerar n√∫mero:", error); document.getElementById('numeroProtocolo').value = `0001/${anoAtual}`; }
};
window.enviarRequerimento = async function() {
  let numeroProtocolo = document.getElementById('numeroProtocolo').value;
  if (!numeroProtocolo) { alert("‚ùóN√∫mero de protocolo n√£o gerado."); return; }
  
  const protocolo = {
    numero: numeroProtocolo, matricula: document.getElementById('matricula').value, nome: document.getElementById('nome').value,
    endereco: document.getElementById('endereco').value, municipio: document.getElementById('municipio').value, bairro: document.getElementById('bairro').value,
    cep: document.getElementById('cep').value, telefone: document.getElementById('telefone').value, cpf: document.getElementById('cpf').value,
    rg: document.getElementById('rg').value, dataExpedicao: document.getElementById('dataExpedicao').value, cargo: document.getElementById('cargo').value,
    lotacao: document.getElementById('lotacao').value, unidade: document.getElementById('unidade').value, tipo: document.getElementById('tipo').value,
    requerAo: document.getElementById('requerAo').value, dataSolicitacao: document.getElementById('dataSolicitacao').value, complemento: document.getElementById('complemento').value,
    status: "Enviado", responsavel: window.usuarioLogin,
  };

  try {
      const res = await fetch('/protocolos', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(protocolo) });
      const data = await res.json();
      if (res.ok && data.sucesso) {
          alert('‚úÖ Protocolo enviado e salvo com sucesso!');
          document.querySelector('#form .formulario').reset();
          gerarNumeroProtocolo();
      } else if (res.status === 400) {
          if (confirm("O n√∫mero deste protocolo j√° foi usado. Deseja tentar salvar novamente com um novo n√∫mero sem perder os dados?")) {
              const novoNumero = await gerarNumeroProtocolo();
              protocolo.numero = document.getElementById('numeroProtocolo').value;
              enviarRequerimento(); // Tenta novamente com o novo n√∫mero
          }
      } else {
          alert('‚ùå Erro ao enviar protocolo: ' + (data.mensagem || 'Erro desconhecido'));
      }
  } catch(err) { alert('‚ùå Erro na conex√£o: ' + err.message); }
};
window.listarProtocolos = async function(pagina = 1) { /* ... */ };
window.listarMeusProtocolos = async function(pagina = 1) { /* ... */ };
window.limparFiltrosMeusProtocolos = function() { /* ... */ };
window.fecharModal = function(modalId) { document.getElementById(modalId).style.display = 'none'; };
window.abrirModalEncaminhar = async function(idProtocolo) { /* ... */ };
window.confirmarEncaminhamento = async function() { /* ... */ };
window.abrirAtualizar = async function(id) { /* ... */ };
window.handleStatusChange = function(selectElement) { /* ... */ };
window.confirmarAtualizacaoStatus = async function() { /* ... */ };
window.previsualizarPDF = async function(id, isPrint = false) { /* ... */ };
window.gerarPDF = async function() { /* ... */ };
window.popularFiltrosRelatorio = function() { /* ... */ };
window.pesquisarProtocolos = async function() { /* ... */ };
window.previsualizarRelatorioPDF = async function() { /* ... */ };
window.salvarRelatorioPDF = async function() { /* ... */ };
window.exportarRelatorioExcel = function() { /* ... */ };
window.limparFiltrosRelatorio = function() { /* ... */ };
window.verificarNotificacoes = async function() { /* ... */ };
window.carregarDashboard = async function() { /* ... */ };
window.salvarEmailSistema = function() { /* ... */ };
window.cadastrarUsuario = async function() { /* ... */ };
window.atualizarListaUsuarios = async function() { /* ... */ };
window.abrirModalEditar = function(usuario) { /* ... */ };
window.confirmarEdicaoUsuario = async function() { /* ... */ };
window.abrirModalResetarSenha = function(id) { /* ... */ };
window.confirmarResetSenha = async function() { /* ... */ };
window.alterarStatusUsuario = async function(id, novoStatus) { /* ... */ };
window.carregarOpcoesDropdowns = async function() { /* ... */ };
window.popularDropdown = function(selectId, opcoes) { /* ... */ };
window.popularDropdownsFormulario = function() { /* ... */ };
window.popularFiltrosDashboard = function() { /* ... */ };
window.carregarTabelaGestao = async function(tipo) { /* ... */ };
window.adicionarItem = async function(tipo) { /* ... */ };
window.alterarStatusItem = async function(tipo, id, novoStatus) { /* ... */ };
window.gerarBackup = async function() { /* ... */ };
window.renderizarPaginacao = function(totalItens, paginaAtual, idContainer, callback) { /* ... */ };
window.voltarDeMeusProtocolos = function() { /* ... */ };
window.preencherCamposServidor = function(servidor) { /* ... */ };
window.abrirModalAlterarSenha = function() { /* ... */ };
window.confirmarAlteracaoSenha = async function() { /* ... */ };
// O c√≥digo acima √© s√≥ a estrutura, o conte√∫do completo est√° abaixo.

// Implementa√ß√£o COMPLETA das fun√ß√µes:
window.listarProtocolos = async function(pagina = 1) {
  const tbody = document.getElementById('tabelaProtocolos');
  tbody.innerHTML = "<tr><td colspan='7'>Carregando...</td></tr>";
  paginaAtualTodos = pagina;
  try {
    const res = await fetch('/protocolos');
    const data = await res.json();
    tbody.innerHTML = "";
    const inicio = (pagina - 1) * itensPorPagina;
    const fim = inicio + itensPorPagina;
    const paginaDados = data.protocolos.slice(inicio, fim);
    if (paginaDados.length === 0) tbody.innerHTML = "<tr><td colspan='7'>Nenhum protocolo encontrado.</td></tr>";
    paginaDados.forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="width: 120px; text-align: center;">${p.numero}</td> <td>${p.matricula}</td> <td>${p.nome}</td>
        <td>${p.tipo_requerimento}</td> <td>${p.status}</td> <td>${p.responsavel}</td>
        <td>
          <button onclick="abrirAtualizar(${p.id})">Atualizar</button>
          <button onclick="abrirModalEncaminhar(${p.id})">Encaminhar</button>
          <button onclick="previsualizarPDF(${p.id})">üìÑ Documento</button>
        </td>`;
      tbody.appendChild(tr);
    });
    renderizarPaginacao(data.protocolos.length, pagina, 'paginacaoProtocolos', listarProtocolos);
  } catch (error) { console.error("Erro ao listar protocolos:", error); tbody.innerHTML = "<tr><td colspan='7'>Erro ao carregar protocolos.</td></tr>"; }
};
window.listarMeusProtocolos = async function(pagina = 1) {
    const tbody = document.getElementById('meusProtocolosTabela');
    tbody.innerHTML = "<tr><td colspan='4'>Carregando...</td></tr>";
    paginaAtualMeus = pagina;
    const filtroNumero = document.getElementById('filtroMeusProtocolosNumero').value.trim().toLowerCase();
    const filtroNome = document.getElementById('filtroMeusProtocolosNome').value.trim().toLowerCase();
    try {
        const usuarioLogin = localStorage.getItem('usuarioLogin');
        if (!usuarioLogin) { tbody.innerHTML = "<tr><td colspan='4'>Usu√°rio n√£o identificado.</td></tr>"; return; }
        const res = await fetch(`/protocolos/meus/${usuarioLogin}`);
        let data = await res.json();
        tbody.innerHTML = "";
        if (filtroNumero || filtroNome) {
            data.protocolos = data.protocolos.filter(p => {
                const numeroMatch = !filtroNumero || (p.numero || "").toLowerCase().includes(filtroNumero);
                const nomeMatch = !filtroNome || (p.nome || "").toLowerCase().includes(filtroNome);
                return numeroMatch && nomeMatch;
            });
        }
        const inicio = (pagina - 1) * itensPorPagina;
        const fim = inicio + itensPorPagina;
        const paginaDados = data.protocolos.slice(inicio, fim);
        if (paginaDados.length === 0) tbody.innerHTML = "<tr><td colspan='4'>Nenhum protocolo encontrado.</td></tr>";
        paginaDados.forEach(p => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${p.numero}</td> <td>${p.nome}</td> <td>${p.status}</td>
                <td>
                  <button onclick="abrirAtualizar(${p.id})">Atualizar</button>
                  <button onclick="abrirModalEncaminhar(${p.id})">Encaminhar</button>
                  <button onclick="previsualizarPDF(${p.id})">üìÑ Documento</button>
                </td>`;
            tbody.appendChild(tr);
        });
        renderizarPaginacao(data.protocolos.length, pagina, 'paginacaoMeusProtocolos', listarMeusProtocolos);
    } catch (error) { console.error("Erro ao listar meus protocolos:", error); tbody.innerHTML = "<tr><td colspan='4'>Erro ao carregar protocolos.</td></tr>"; }
};
window.limparFiltrosMeusProtocolos = function() {
    document.getElementById('filtroMeusProtocolosNumero').value = '';
    document.getElementById('filtroMeusProtocolosNome').value = '';
    listarMeusProtocolos();
};
window.abrirModalEncaminhar = async function(idProtocolo) {
  try {
    const res = await fetch('/usuarios');
    const data = await res.json();
    const select = document.getElementById('selectUsuarioEncaminhar');
    select.innerHTML = '';
    data.usuarios.forEach(usuario => {
      if(usuario.status !== 'ativo') return;
      const option = document.createElement('option');
      option.value = usuario.login;
      option.textContent = `${usuario.nome} (${usuario.tipo})`;
      select.appendChild(option);
    });
    document.getElementById('statusEncaminhamento').value = 'Encaminhado';
    const modal = document.getElementById('modalEncaminhar');
    modal.dataset.protocoloId = idProtocolo;
    modal.style.display = 'flex';
  } catch (error) { alert('Erro ao carregar usu√°rios'); console.error(error); }
};
window.confirmarEncaminhamento = async function() {
  const modal = document.getElementById('modalEncaminhar');
  const idProtocolo = modal.dataset.protocoloId;
  const destino = document.getElementById('selectUsuarioEncaminhar').value;
  const novoStatus = document.getElementById('statusEncaminhamento').value.trim();
  if (!novoStatus) { alert('O campo de status n√£o pode ficar vazio.'); return; }
  try {
    const response = await fetch('/protocolos/atualizar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ protocoloId: idProtocolo, novoStatus: novoStatus, novoResponsavel: destino, observacao: `Encaminhado por ${window.usuarioLogado} para ${destino}`, usuarioLogado: window.usuarioLogado })
    });
    const data = await response.json();
    if (data.sucesso) {
      alert('‚úÖ Protocolo encaminhado com sucesso!');
      fecharModal('modalEncaminhar');
      if (document.getElementById('protocolos').classList.contains('active')) await listarProtocolos();
      if (document.getElementById('meusProtocolos').classList.contains('active')) await listarMeusProtocolos();
      await verificarNotificacoes();
    } else {
      alert('‚ùå Erro ao encaminhar protocolo: ' + (data.mensagem || ''));
    }
  } catch (err) { console.error(err); alert('‚ùå Erro ao encaminhar protocolo'); }
};
window.abrirAtualizar = async function(id) {
  const modal = document.getElementById('modalAtualizarStatus');
  document.getElementById('statusSelect').value = 'Em an√°lise';
  document.getElementById('statusCustom').style.display = 'none';
  document.getElementById('statusCustom').value = '';
  document.getElementById('observacaoAtualizacao').value = '';
  modal.dataset.protocoloId = id;
  modal.style.display = 'flex';
};
window.handleStatusChange = function(selectElement) {
  const customInput = document.getElementById('statusCustom');
  customInput.style.display = selectElement.value === 'Outro' ? 'block' : 'none';
};
window.confirmarAtualizacaoStatus = async function() {
  const modal = document.getElementById('modalAtualizarStatus');
  const protocoloId = modal.dataset.protocoloId;
  const statusSelect = document.getElementById('statusSelect');
  let novoStatus = statusSelect.value;
  if (novoStatus === 'Outro') {
    novoStatus = document.getElementById('statusCustom').value.trim();
    if (!novoStatus) { alert('Por favor, digite o status personalizado.'); return; }
  }
  const observacaoInput = document.getElementById('observacaoAtualizacao').value.trim();
  const observacaoFinal = `Status atualizado para "${novoStatus}". ${observacaoInput}`.trim();
  try {
    const response = await fetch(`/protocolos/atualizar`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ protocoloId: protocoloId, novoStatus: novoStatus, novoResponsavel: window.usuarioLogin, observacao: observacaoFinal, usuarioLogado: window.usuarioLogado })
    });
    const data = await response.json();
    if (data.sucesso) {
      alert("‚úÖ Status atualizado!");
      fecharModal('modalAtualizarStatus');
      if (document.getElementById('protocolos').classList.contains('active')) await listarProtocolos();
      if (document.getElementById('meusProtocolos').classList.contains('active')) await listarMeusProtocolos();
    } else {
      alert("Erro ao atualizar.");
    }
  } catch (error) { console.error("Erro na atualiza√ß√£o:", error); }
};
window.previsualizarPDF = async function(id, isPrint = false) {
  let protocolo;
  if(id === null && isPrint === true) {
      protocolo = {
          numero: document.getElementById('numeroProtocolo').value, data_solicitacao: document.getElementById('dataSolicitacao').value,
          nome: document.getElementById('nome').value, matricula: document.getElementById('matricula').value, cpf: document.getElementById('cpf').value,
          rg: document.getElementById('rg').value, endereco: document.getElementById('endereco').value, bairro: document.getElementById('bairro').value,
          municipio: document.getElementById('municipio').value, cep: document.getElementById('cep').value, telefone: document.getElementById('telefone').value,
          cargo: document.getElementById('cargo').value, lotacao: document.getElementById('lotacao').value, unidade_exercicio: document.getElementById('unidade').value,
          tipo_requerimento: document.getElementById('tipo').value, requer_ao: document.getElementById('requerAo').value, observacoes: document.getElementById('complemento').value,
      };
  } else {
      try {
          const res = await fetch(`/protocolos/${id}`);
          const data = await res.json();
          if(!data.protocolo) { alert("Protocolo n√£o encontrado"); return; }
          protocolo = data.protocolo;
      } catch (err) { console.error('Erro ao buscar protocolo:', err); alert('Erro ao buscar dados do protocolo.'); return; }
  }
  protocoloParaGerar = protocolo;
  const modeloOriginal = document.getElementById('modeloProtocolo');
  const pdfContentDiv = document.getElementById('pdfContent');
  pdfContentDiv.innerHTML = modeloOriginal.innerHTML; 
  const qrcodeContainer = pdfContentDiv.querySelector('#qrcode-container');
  if(qrcodeContainer && protocolo.numero) {
      qrcodeContainer.innerHTML = '';
      const numeroParts = protocolo.numero.split('/');
      if (numeroParts.length === 2) {
          const urlConsulta = `${window.location.origin}/consulta/${numeroParts[1]}/${numeroParts[0]}`;
          new QRCode(qrcodeContainer, { text: urlConsulta, width: 90, height: 90, correctLevel : QRCode.CorrectLevel.H });
      }
  }
  pdfContentDiv.querySelector('#doc_numero').textContent = protocolo.numero ?? 'A ser gerado';
  pdfContentDiv.querySelector('#doc_dataSolicitacao').textContent = protocolo.data_solicitacao ? new Date(protocolo.data_solicitacao).toLocaleDateString('pt-BR', {timeZone: 'UTC'}) : new Date().toLocaleDateString('pt-BR');
  pdfContentDiv.querySelector('#doc_nome').textContent = protocolo.nome ?? '';
  pdfContentDiv.querySelector('#doc_matricula').textContent = protocolo.matricula ?? '';
  pdfContentDiv.querySelector('#doc_cpf').textContent = protocolo.cpf ?? '';
  pdfContentDiv.querySelector('#doc_rg').textContent = protocolo.rg ?? '';
  pdfContentDiv.querySelector('#doc_endereco').textContent = protocolo.endereco ?? '';
  pdfContentDiv.querySelector('#doc_bairro').textContent = protocolo.bairro ?? '';
  pdfContentDiv.querySelector('#doc_municipio').textContent = protocolo.municipio ?? '';
  pdfContentDiv.querySelector('#doc_cep').textContent = protocolo.cep ?? '';
  pdfContentDiv.querySelector('#doc_telefone').textContent = protocolo.telefone ?? '';
  pdfContentDiv.querySelector('#doc_cargo').textContent = protocolo.cargo ?? '';
  pdfContentDiv.querySelector('#doc_lotacao').textContent = protocolo.lotacao ?? '';
  pdfContentDiv.querySelector('#doc_unidade').textContent = protocolo.unidade_exercicio ?? '';
  pdfContentDiv.querySelector('#doc_tipo').textContent = protocolo.tipo_requerimento ?? '';
  pdfContentDiv.querySelector('#doc_requerAo').textContent = protocolo.requer_ao ?? '';
  pdfContentDiv.querySelector('#doc_complemento').innerHTML = protocolo.observacoes ? protocolo.observacoes.replace(/\n/g, '<br>') : 'Nenhuma informa√ß√£o adicional.';
  document.getElementById('pdfModal').style.display = 'block';
};
window.gerarPDF = async function() {
  if (!protocoloParaGerar) { alert("Nenhum protocolo para gerar."); return; }
  const element = document.getElementById('pdfContent');
  const opt = { margin: [0, 0, 0, 0], filename: `Protocolo_${protocoloParaGerar.numero.replace('/', '-')}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, scrollY: 0, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
  try {
    await html2pdf().set(opt).from(element).save();
    fecharModal('pdfModal');
  } catch (error) { console.error("Erro ao gerar PDF:", error); alert("Ocorreu um erro ao gerar o PDF."); }
};
window.popularFiltrosRelatorio = function() {
    popularDropdown('filtroTipo', window.opcoesTipos);
    document.getElementById('filtroTipo').firstChild.textContent = "Todo tipo de Requerimento";
    popularDropdown('filtroLotacao', window.opcoesLotacoes);
    document.getElementById('filtroLotacao').firstChild.textContent = "Todas as Lota√ß√µes";
};
window.pesquisarProtocolos = async function() {
  const params = new URLSearchParams({ numero: document.getElementById('filtroNumero').value, nome: document.getElementById('filtroNome').value, status: document.getElementById('filtroStatus').value, dataInicio: document.getElementById('filtroDataInicio').value, dataFim: document.getElementById('filtroDataFim').value, tipo: document.getElementById('filtroTipo').value, lotacao: document.getElementById('filtroLotacao').value });
  const tbody = document.getElementById('resultadosPesquisa');
  tbody.innerHTML = '<tr><td colspan="7">Pesquisando...</td></tr>';
  try {
    const res = await fetch(`/protocolos/pesquisa?${params.toString()}`);
    const data = await res.json();
    tbody.innerHTML = '';
    if (data.protocolos && data.protocolos.length > 0) {
      data.protocolos.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.numero || ''}</td> <td>${p.nome || ''}</td> <td>${p.matricula || ''}</td>
          <td>${p.tipo_requerimento || ''}</td> <td>${p.data_solicitacao ? new Date(p.data_solicitacao).toLocaleDateString('pt-BR', {timeZone: 'UTC'}) : ''}</td>
          <td>${p.status || ''}</td> <td>${p.responsavel || ''}</td>
        `;
        tbody.appendChild(tr);
      });
    } else {
      tbody.innerHTML = '<tr><td colspan="7">Nenhum protocolo encontrado com os filtros informados.</td></tr>';
    }
  } catch (error) { console.error("Erro ao pesquisar protocolos:", error); }
};
window.previsualizarRelatorioPDF = async function() {
    const params = new URLSearchParams({ numero: document.getElementById('filtroNumero').value, nome: document.getElementById('filtroNome').value, status: document.getElementById('filtroStatus').value, dataInicio: document.getElementById('filtroDataInicio').value, dataFim: document.getElementById('filtroDataFim').value, tipo: document.getElementById('filtroTipo').value, lotacao: document.getElementById('filtroLotacao').value });
    try {
        const res = await fetch(`/protocolos/pesquisa?${params.toString()}`);
        const data = await res.json();
        if (!data.protocolos || data.protocolos.length === 0) {
            alert("Nenhum resultado encontrado para gerar o PDF.");
            return;
        }
        const templatePDF = document.getElementById('modeloProtocolo');
        let htmlContent = '';
        data.protocolos.forEach(p => {
            const tempNode = templatePDF.cloneNode(true);
            tempNode.style.display = 'block';
            tempNode.querySelector('#doc_numero').textContent = p.numero || '';
            tempNode.querySelector('#doc_dataSolicitacao').textContent = p.data_solicitacao ? new Date(p.data_solicitacao).toLocaleDateString('pt-BR', {timeZone: 'UTC'}) : '';
            tempNode.querySelector('#doc_nome').textContent = p.nome || '';
            tempNode.querySelector('#doc_matricula').textContent = p.matricula || '';
            tempNode.querySelector('#doc_tipo').textContent = p.tipo_requerimento || '';
            htmlContent += `<div style="page-break-after: always;">${tempNode.innerHTML}</div>`;
        });
        document.getElementById('relatorioContent').innerHTML = htmlContent;
        document.getElementById('relatorioModal').style.display = 'block';
    } catch(err) { console.error('Erro ao gerar relat√≥rio:', err); alert('Erro ao gerar relat√≥rio.'); }
};
window.salvarRelatorioPDF = async function() {
    const element = document.getElementById('relatorioContent');
    const opt = { margin: [0, 0, 0, 0], filename: `Relatorio_Protocolos.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
    try {
        await html2pdf().set(opt).from(element).save();
        fecharModal('relatorioModal');
    } catch(err) { console.error('Erro ao salvar PDF do relat√≥rio:', err); alert('Erro ao salvar PDF do relat√≥rio.'); }
};
window.exportarRelatorioExcel = function() {
  const params = new URLSearchParams({ numero: document.getElementById('filtroNumero').value, nome: document.getElementById('filtroNome').value, status: document.getElementById('filtroStatus').value, dataInicio: document.getElementById('filtroDataInicio').value, dataFim: document.getElementById('filtroDataFim').value, tipo: document.getElementById('filtroTipo').value, lotacao: document.getElementById('filtroLotacao').value });
  window.location.href = `/protocolos/backup?${params.toString()}`;
};
window.limparFiltrosRelatorio = function() {
    document.querySelector('#relatorios .filtros').reset();
    pesquisarProtocolos();
};
window.verificarNotificacoes = async function() {
  const usuarioLogin = localStorage.getItem('usuarioLogin');
  if (!usuarioLogin) return;
  try {
    const res = await fetch(`/protocolos/notificacoes/${usuarioLogin}`);
    const data = await res.json();
    const bell = document.getElementById('notification-bell');
    const countSpan = document.getElementById('notification-count');
    if (data.count > 0) {
      countSpan.textContent = data.count;
      bell.style.display = 'block';
    } else {
      bell.style.display = 'none';
    }
  } catch (err) { console.error('Erro ao verificar notifica√ß√µes:', err); }
};
window.popularFiltrosDashboard = function() {
    const statusOptions = '<option value="">Todos os Status</option><option value="Em an√°lise">Em an√°lise</option><option value="Pendente de documento">Pendente de documento</option><option value="Finalizado">Finalizado</option><option value="Conclu√≠do">Conclu√≠do</option><option value="Encaminhado">Encaminhado</option>';
    document.getElementById('dashStatus').innerHTML = statusOptions;
    popularDropdown('dashTipo', window.opcoesTipos);
    document.getElementById('dashTipo').firstChild.textContent = "Todo tipo de Requerimento";
    popularDropdown('dashLotacao', window.opcoesLotacoes);
    document.getElementById('dashLotacao').firstChild.textContent = "Todas as Lota√ß√µes";
};
window.carregarDashboard = async function() {
    const params = new URLSearchParams({
        dataInicio: document.getElementById('dashDataInicio').value, dataFim: document.getElementById('dashDataFim').value,
        status: document.getElementById('dashStatus').value, tipo: document.getElementById('dashTipo').value, lotacao: document.getElementById('dashLotacao').value
    });
    try {
        const res = await fetch(`/protocolos/dashboard-stats?${params.toString()}`);
        const stats = await res.json();
        document.getElementById('stat-novos').textContent = stats.novosNoPeriodo;
        document.getElementById('stat-pendentes').textContent = stats.pendentesAntigos;
        document.getElementById('stat-novos-label').textContent = (document.getElementById('dashDataInicio').value || document.getElementById('dashDataFim').value) ? 'Novos no Per√≠odo' : 'Novos na Semana';

        const labels = stats.topTipos.map(item => item.tipo_requerimento);
        const data = stats.topTipos.map(item => item.total);
        const ctx = document.getElementById('tiposChart').getContext('2d');
        if (tiposChartInstance) { tiposChartInstance.destroy(); }
        tiposChartInstance = new Chart(ctx, {
            type: 'bar', data: { labels: labels, datasets: [{
                    label: 'Total de Protocolos', data: data,
                    backgroundColor: ['rgba(46, 125, 50, 0.7)', 'rgba(76, 175, 80, 0.7)', 'rgba(139, 195, 74, 0.7)', 'rgba(205, 220, 57, 0.7)', 'rgba(255, 235, 59, 0.7)'],
                    borderWidth: 1 }]
            },
            options: { scales: { y: { beginAtZero: true } }, indexAxis: 'y', responsive: true, plugins: { legend: { display: false } } }
        });
    } catch (err) { console.error("Erro ao carregar dados do dashboard:", err); alert("N√£o foi poss√≠vel carregar os dados do dashboard."); }
};
window.salvarEmailSistema = function() {
  localStorage.setItem('emailSistema', document.getElementById('emailSistemaConfig').value);
  alert("Email salvo com sucesso!");
};
window.cadastrarUsuario = async function() {
  const nomeCompleto = document.getElementById('nomeCompleto').value.trim();
  const login = document.getElementById('novoUsuario').value.trim();
  const cpf = document.getElementById('cpfUsuario').value.trim();
  const senha = document.getElementById('novaSenha').value.trim();
  const email = document.getElementById('novoEmail').value.trim();
  const tipo = document.getElementById('nivelUsuario').value;
  if (!nomeCompleto || !login || !cpf || !senha || !email || !tipo) { alert('Por favor, preencha todos os campos.'); return; }
  try {
    const res = await fetch('/usuarios', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nome: nomeCompleto, login, cpf, senha, email, tipo }) });
    const data = await res.json();
    alert(data.mensagem || 'Usu√°rio cadastrado!');
    if (data.sucesso) {
        document.getElementById('nomeCompleto').value = ''; document.getElementById('novoUsuario').value = ''; document.getElementById('cpfUsuario').value = ''; document.getElementById('novaSenha').value = ''; document.getElementById('novoEmail').value = '';
        atualizarListaUsuarios();
    }
  } catch (error) { console.error('Erro ao cadastrar usu√°rio:', error); alert('Erro ao cadastrar usu√°rio.'); }
};
window.atualizarListaUsuarios = async function() {
  try {
    const response = await fetch('/usuarios');
    const data = await response.json();
    const tbody = document.getElementById('tabelaUsuarios');
    tbody.innerHTML = "";
    data.usuarios.forEach(u => {
      const tr = document.createElement('tr');
      const statusClasse = u.status === 'ativo' ? 'color:green;' : 'color:red;';
      tr.innerHTML = `
        <td>${u.nome}</td> <td>${u.login}</td> <td>${u.email}</td> <td>${u.tipo}</td> <td style="font-weight:bold; ${statusClasse}">${u.status}</td>
        <td>
          <button onclick='abrirModalEditar(${JSON.stringify(u)})'>Editar</button>
          <button onclick='abrirModalResetarSenha(${u.id})'>Resetar Senha</button>
          ${u.status === 'ativo' ? `<button onclick="alterarStatusUsuario(${u.id}, 'inativo')" style="background-color:#c82333;">Desativar</button>` : `<button onclick="alterarStatusUsuario(${u.id}, 'ativo')" style="background-color:#218838;">Reativar</button>`}
        </td>`;
      tbody.appendChild(tr);
    });
  } catch (error) { alert('Erro ao carregar usu√°rios: ' + error.message); }
};
window.abrirModalEditar = function(usuario) {
  document.getElementById('editUserId').value = usuario.id;
  document.getElementById('editNomeCompleto').value = usuario.nome;
  document.getElementById('editLogin').value = usuario.login;
  document.getElementById('editEmail').value = usuario.email;
  document.getElementById('editCpf').value = usuario.cpf;
  document.getElementById('editTipo').value = usuario.tipo;
  document.getElementById('modalEditarUsuario').style.display = 'flex';
};
window.confirmarEdicaoUsuario = async function() {
  const id = document.getElementById('editUserId').value;
  const usuario = { nome: document.getElementById('editNomeCompleto').value, login: document.getElementById('editLogin').value, email: document.getElementById('editEmail').value, cpf: document.getElementById('editCpf').value, tipo: document.getElementById('editTipo').value };
  try {
    const res = await fetch(`/usuarios/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(usuario) });
    const data = await res.json();
    alert(data.mensagem);
    if (data.sucesso) { fecharModal('modalEditarUsuario'); atualizarListaUsuarios(); }
  } catch(err) { alert('Erro ao salvar altera√ß√µes.'); }
};
window.abrirModalResetarSenha = function(id) {
  document.getElementById('resetUserId').value = id;
  document.getElementById('resetNovaSenha').value = '';
  document.getElementById('modalResetarSenha').style.display = 'flex';
};
window.confirmarResetSenha = async function() {
  const id = document.getElementById('resetUserId').value;
  const novaSenha = document.getElementById('resetNovaSenha').value;
  if (novaSenha.length < 4) { alert('A nova senha deve ter pelo menos 4 caracteres.'); return; }
  try {
    const res = await fetch(`/usuarios/${id}/senha`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ novaSenha }) });
    const data = await res.json();
    alert(data.mensagem);
    if (data.sucesso) { fecharModal('modalResetarSenha'); }
  } catch(err) { alert('Erro ao resetar senha.'); }
};
window.alterarStatusUsuario = async function(id, novoStatus) {
  const acao = novoStatus === 'inativo' ? 'desativar' : 'reativar';
  if (confirm(`Tem certeza que deseja ${acao} este usu√°rio?`)) {
    try {
      const res = await fetch(`/usuarios/${id}/status`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: novoStatus }) });
      const data = await res.json();
      alert(data.mensagem);
      if (data.sucesso) { atualizarListaUsuarios(); }
    } catch(err) { alert(`Erro ao ${acao} usu√°rio.`); }
  }
};
window.carregarOpcoesDropdowns = async function() {
    try {
        const [tiposRes, lotacoesRes] = await Promise.all([ fetch('/admin/tipos'), fetch('/admin/lotacoes') ]);
        window.opcoesTipos = await tiposRes.json();
        window.opcoesLotacoes = await lotacoesRes.json();
    } catch (err) { console.error("Erro ao carregar op√ß√µes de dropdowns:", err); alert("N√£o foi poss√≠vel carregar as listas de op√ß√µes."); }
};
window.popularDropdown = function(selectId, opcoes) {
    const select = document.getElementById(selectId);
    const primeiraOpcao = select.options[0];
    select.innerHTML = '';
    if(primeiraOpcao) select.appendChild(primeiraOpcao);
    opcoes.forEach(opcao => {
        const opt = document.createElement('option');
        opt.value = opcao;
        opt.textContent = opcao;
        select.appendChild(opt);
    });
};
window.popularDropdownsFormulario = function() {
    popularDropdown('tipo', window.opcoesTipos);
    popularDropdown('lotacao', window.opcoesLotacoes);
};
window.carregarTabelaGestao = async function(tipo) {
    const tbody = document.getElementById(tipo === 'tipos' ? 'tabelaTipos' : 'tabelaLotacoes');
    tbody.innerHTML = '';
    try {
        const res = await fetch(`/admin/${tipo}/all`);
        const data = await res.json();
        data.forEach(item => {
            const tr = document.createElement('tr');
            const statusStyle = item.ativo ? 'color:green;' : 'color:red;';
            tr.innerHTML = `
                <td>${item.nome}</td>
                <td style="${statusStyle}">${item.ativo ? 'Ativo' : 'Inativo'}</td>
                <td><button onclick="alterarStatusItem('${tipo}', ${item.id}, ${!item.ativo})">${item.ativo ? 'Desativar' : 'Reativar'}</button></td>
            `;
            tbody.appendChild(tr);
        });
    } catch (err) { console.error(`Erro ao carregar ${tipo}:`, err); }
};
window.adicionarItem = async function(tipo) {
    const nomeInput = document.getElementById(tipo === 'tipos' ? 'novoTipoNome' : 'novaLotacaoNome');
    const nome = nomeInput.value.trim();
    if (!nome) { alert('O nome n√£o pode ser vazio.'); return; }
    try {
        await fetch(`/admin/${tipo}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nome }) });
        nomeInput.value = '';
        carregarTabelaGestao(tipo);
        await carregarOpcoesDropdowns();
    } catch (err) { alert(`Erro ao adicionar item.`); }
};
window.alterarStatusItem = async function(tipo, id, novoStatus) {
    const acao = novoStatus ? 'reativar' : 'desativar';
    if (confirm(`Tem certeza que deseja ${acao} este item?`)) {
        try {
            await fetch(`/admin/${tipo}/${id}/status`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ativo: novoStatus }) });
            carregarTabelaGestao(tipo);
            await carregarOpcoesDropdowns();
        } catch (err) { alert(`Erro ao ${acao} o item.`); }
    }
};
window.gerarBackup = async function() {
  const dataInicio = document.getElementById('backupDataInicio').value;
  const dataFim = document.getElementById('backupDataFim').value;
  if (!dataInicio || !dataFim) { alert("Por favor, selecione o per√≠odo completo."); return; }
  try {
    const url = `/protocolos/backup?dataInicio=${dataInicio}&dataFim=${dataFim}`;
    const response = await fetch(url);
    if (!response.ok) { const textoErro = await response.text(); alert(`Erro ao gerar backup: ${textoErro || response.statusText}`); return; }
    const blob = await response.blob();
    const urlBlob = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = urlBlob;
    a.download = `backup_protocolos_${dataInicio}_a_${dataFim}.xlsx`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(urlBlob);
  } catch (error) { console.error("Erro ao gerar backup:", error); alert("Erro ao gerar backup."); }
};
window.renderizarPaginacao = function(totalItens, paginaAtual, idContainer, callback) {
    const container = document.getElementById(idContainer);
    container.innerHTML = '';
    const totalPaginas = Math.ceil(totalItens / itensPorPagina);
    if (totalPaginas <= 1) return;
    let maxPagesToShow = 5;
    let startPage, endPage;
    if (totalPaginas <= maxPagesToShow) { startPage = 1; endPage = totalPaginas; } 
    else {
        const maxPagesBeforeCurrent = Math.floor(maxPagesToShow / 2);
        const maxPagesAfterCurrent = Math.ceil(maxPagesToShow / 2) - 1;
        if (paginaAtual <= maxPagesBeforeCurrent) { startPage = 1; endPage = maxPagesToShow; } 
        else if (paginaAtual + maxPagesAfterCurrent >= totalPaginas) { startPage = totalPaginas - maxPagesToShow + 1; endPage = totalPaginas; } 
        else { startPage = paginaAtual - maxPagesBeforeCurrent; endPage = paginaAtual + maxPagesAfterCurrent; }
    }
    if (paginaAtual > 1) {
        const prevBtn = document.createElement('button'); prevBtn.textContent = '¬´'; prevBtn.onclick = () => callback(paginaAtual - 1); container.appendChild(prevBtn);
    }
    if (startPage > 1) {
        const firstBtn = document.createElement('button'); firstBtn.textContent = '1'; firstBtn.onclick = () => callback(1); container.appendChild(firstBtn);
        if (startPage > 2) { const ellipsis = document.createElement('span'); ellipsis.textContent = '...'; container.appendChild(ellipsis); }
    }
    for (let i = startPage; i <= endPage; i++) {
        const btn = document.createElement('button'); btn.textContent = i;
        if (i === paginaAtual) { btn.disabled = true; btn.style.fontWeight = 'bold'; btn.style.backgroundColor = '#ccc'; }
        btn.onclick = () => callback(i); container.appendChild(btn);
    }
    if (endPage < totalPaginas) {
        if (endPage < totalPaginas - 1) { const ellipsis = document.createElement('span'); ellipsis.textContent = '...'; container.appendChild(ellipsis); }
        const lastBtn = document.createElement('button'); lastBtn.textContent = totalPaginas; lastBtn.onclick = () => callback(totalPaginas); container.appendChild(lastBtn);
    }
    if (paginaAtual < totalPaginas) {
        const nextBtn = document.createElement('button'); nextBtn.textContent = '¬ª'; nextBtn.onclick = () => callback(paginaAtual + 1); container.appendChild(nextBtn);
    }
};
window.voltarDeMeusProtocolos = function() {
  if (window.nivelUsuario === 'comum') { sair(); } else { mostrarTela('menu'); }
};
window.preencherCamposServidor = function(servidor) {
    if (!servidor) {
      document.getElementById('nome').value = ''; document.getElementById('lotacao').value = ''; document.getElementById('cargo').value = ''; document.getElementById('unidade').value = '';
    } else {
      document.getElementById('nome').value = servidor.nome || ''; document.getElementById('lotacao').value = servidor.lotacao || ''; document.getElementById('cargo').value = servidor.cargo || ''; document.getElementById('unidade').value = servidor.unidade_de_exercicio || '';
    }
};
window.abrirModalAlterarSenha = function() {
    document.getElementById('senhaAtual').value = '';
    document.getElementById('alterarNovaSenha').value = '';
    document.getElementById('confirmarNovaSenha').value = '';
    document.getElementById('modalAlterarSenha').style.display = 'flex';
};
window.confirmarAlteracaoSenha = async function() {
    const senhaAtual = document.getElementById('senhaAtual').value;
    const novaSenha = document.getElementById('alterarNovaSenha').value;
    const confirmarSenha = document.getElementById('confirmarNovaSenha').value;

    if (novaSenha !== confirmarSenha) {
        alert('A nova senha e a confirma√ß√£o n√£o s√£o iguais.');
        return;
    }
    if (novaSenha.length < 4) {
        alert('A nova senha deve ter pelo menos 4 caracteres.');
        return;
    }

    try {
        const res = await fetch('/usuarios/minha-senha', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                usuarioLogin: window.usuarioLogin,
                senhaAtual: senhaAtual,
                novaSenha: novaSenha
            })
        });
        const data = await res.json();
        alert(data.mensagem);
        if (data.sucesso) {
            fecharModal('modalAlterarSenha');
        }
    } catch(err) {
        alert('Erro ao conectar com o servidor para alterar a senha.');
    }
};


    
</script>

</body>
</html>
