<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sistema de Protocolo</title>
<style>
    /* --- ESTILOS GERAIS --- */
    body { margin: 0; font-family: Arial, sans-serif; background: #f5f5f5; }
    .container { max-width: 1500px; margin: 40px auto; background: #fff; border-radius: 16px; box-shadow: 0 0 10px rgba(0,0,0,0.1); overflow: hidden; padding-bottom: 30px; }
    .header { background: #2e7d32; color: white; padding: 20px; text-align: center; border-radius: 0 0 15px 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); position: relative; }
    .logo { height: 80px; margin-bottom: 5px; }
    .header h2, .header h3 { margin: 5px 0; }
    .header img { height: 60px; width: auto; }
    .content { padding: 20px 30px; display: none; }
    .content.active { display: block; }
    .menu, .login-screen, .form-screen, .protocolos-screen, .config-screen, .meus-protocolos-screen, .relatorios-screen, .dashboard-screen { display: none; }
    .active { display: block; }
    .formulario { display: grid; grid-template-columns: repeat(12, 1fr); gap: 15px 20px; }
    .form-group { display: flex; flex-direction: column; }
    .full-row { grid-column: span 12; }
    .span-6 { grid-column: span 6; }
    .span-3 { grid-column: span 3; }
    label { margin-bottom: 5px; font-weight: 600; }
    input, select, textarea { border: 1px solid #ccc; border-radius: 6px; padding: 8px; font-size: 1em; }
    button { padding: 10px 12px; border: none; background: #2e7d32; color: white; border-radius: 8px; cursor: pointer; margin: 5px 10px 5px 0; transition: background-color 0.2s; }
    button:hover { background-color: #1b5e20; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; }
    th { background-color: #e0e0e0; }
    .filtros { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; background: #f5f5f5; padding: 15px; border-radius: 8px; }
    .filtros input, .filtros select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
    #modeloProtocolo { display: none; }

    /* --- ESTILOS DA TELA DE LOGIN --- */
    .login-screen.active { display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px 20px; }
    .login-form-container { width: 100%; max-width: 400px; padding: 30px; background-color: #ffffff; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); box-sizing: border-box; }
    .login-form-container h3 { text-align: center; color: #333; margin-top: 0; }
    .login-form-container label { width: 100%; text-align: left; margin-bottom: 8px; font-size: 0.9em; color: #555; }
    .login-form-container input { width: 100%; padding: 12px; margin-bottom: 20px; box-sizing: border-box; }
    .login-form-container button { width: 100%; padding: 12px; margin-top: 10px; margin-left: 0; font-size: 1.1em; font-weight: bold; }

    /* --- ESTILOS DO MENU PRINCIPAL --- */
    .menu.active { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; padding: 40px; }
    .menu button { margin: 0; min-height: 110px; font-size: 1.1em; font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; transition: transform 0.2s ease, box-shadow 0.2s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .menu button:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.15); }
    
    /* Pagina√ß√£o */
    #paginacaoProtocolos, #paginacaoMeusProtocolos { text-align: center; margin-top: 20px; }
    #paginacaoProtocolos span, #paginacaoMeusProtocolos span { margin: 0 5px; color: #888; }

    /* Notifica√ß√µes */
    #notification-bell { position: absolute; top: 25px; right: 30px; font-size: 24px; cursor: pointer; display: none; }
    #notification-count { position: absolute; top: -5px; right: -10px; background-color: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px; font-weight: bold; line-height: 1; }

    /* Dashboard */
    .dashboard-cards { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 40px; }
    .stat-card { flex: 1; min-width: 200px; background-color: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .stat-value { font-size: 3em; font-weight: bold; color: #2e7d32; }
    .stat-label { font-size: 1.1em; color: #6c757d; }
    .chart-container { max-width: 800px; margin: 0 auto; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container">
  <div class="header">
    <img src="/img/logo.png" alt="Logo" class="logo">
    <h2>Prefeitura de Morada Nova</h2>
    <h3>Sistema de Protocolo</h3>
    <div id="notification-bell" onclick="mostrarTela('meusProtocolos')">
      <span>üîî</span>
      <span id="notification-count">0</span>
    </div>
  </div>

  <div id="login" class="login-screen content active">
    <div class="login-form-container">
      <h3>Acesso ao Sistema</h3>
      <label for="usuario">Usu√°rio</label>
      <input type="text" id="usuario" />
      <label for="senha">Senha</label>
      <input type="password" id="senha" />
      <button onclick="logar()">Entrar</button>
      <p id="loginMsg" style="color:red;"></p>
    </div>
  </div>

  <div id="menu" class="menu content">
    <button id="btnDashboard" onclick="mostrarTela('dashboard')">üìà Dashboard</button>
    <button id="btnNovo" onclick="mostrarTela('form')">üìÑ Novo Protocolo</button>
    <button onclick="mostrarTela('protocolos')">üóÇÔ∏è Todos os Protocolos</button>
    <button onclick="mostrarTela('relatorios')" id="btnRelatorios">üìä Relat√≥rios</button>
    <button onclick="mostrarTela('meusProtocolos')">üìÇ Meus Protocolos</button>
    <button id="btnConfig" onclick="mostrarTela('config')">‚öôÔ∏è Configura√ß√µes</button>
    <button onclick="sair()">üö™ Sair</button>
  </div>

  <div id="dashboard" class="dashboard-screen content">
    <h3>Dashboard Gerencial</h3>
    <div class="dashboard-cards">
        <div class="stat-card">
            <div class="stat-value" id="stat-novos">0</div>
            <div class="stat-label">Protocolos na Semana</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-pendentes">0</div>
            <div class="stat-label">Pendentes (> 15 dias)</div>
        </div>
    </div>
    <div class="chart-container">
        <h4>Top 5 Tipos de Requerimento</h4>
        <canvas id="tiposChart"></canvas>
    </div>
    <button onclick="mostrarTela('menu')">üîô Voltar</button>
  </div>

  <div id="form" class="form-screen content">
      <form class="formulario" onsubmit="return false;">
        <div class="form-group span-3"><label>N√∫mero do Protocolo</label><input type="text" id="numeroProtocolo" readonly></div>
        <div class="form-group span-3"><label>Matr√≠cula</label><input type="text" id="matricula"></div>
        <div class="form-group span-6"><label>Nome Completo</label><input type="text" id="nome"></div>
        <div class="form-group span-6"><label>Endere√ßo</label><input type="text" id="endereco"></div>
        <div class="form-group span-3"><label>Munic√≠pio</label><input type="text" id="municipio" value="Morada Nova"></div>
       <div class="form-group span-3">
          <label for="bairro">Bairro</label>
          <select id="bairro" name="bairro" class="form-control">
            <option value="">Selecione um bairro</option>
            <option value="Centro">Centro</option>
            <option value="Giril√¢ndia">Giril√¢ndia</option>
            <option value="Padre Assis Monteiro">Padre Assis Monteiro</option>
            <option value="Herm√≥genes Henrique Gir√£o">Herm√≥genes Henrique Gir√£o</option>
            <option value="S√£o Jos√©">S√£o Jos√©</option>
            <option value="Nossa Senhora da Concei√ß√£o">Nossa Senhora da Concei√ß√£o</option>
            <option value="Planalto Aeroporto">Planalto Aeroporto</option>
            <option value="J√∫lia Santiago">J√∫lia Santiago</option>
            <option value="S√£o Francisco">S√£o Francisco</option>
            <option value="Nova Morada">Nova Morada</option>
            <option value="Divino Esp√≠rito Santo">Divino Esp√≠rito Santo</option>
            <option value="Alto Tiradentes">Alto Tiradentes</option>
            <option value="Capit√£o Dion√≠sio Matos de Fontes">Capit√£o Dion√≠sio Matos de Fontes</option>
            <option value="Irapuan Nobre">Irapuan Nobre</option>
            <option value="Dois de Agosto">Dois de Agosto</option>
            <option value="Cristo Rei">Cristo Rei</option>
            <option value="Sede Rural">Sede Rural</option>
            <option value="Outro">Outro</option>
          </select>
        </div>
        <div class="form-group span-3"><label>CEP</label><input type="text" id="cep"></div>
        <div class="form-group span-3"><label>Telefone</label><input type="text" id="telefone"></div>
        <div class="form-group span-3"><label>CPF</label><input type="text" id="cpf"></div>
        <div class="form-group span-3"><label>RG</label><input type="text" id="rg"></div>
        <div class="form-group span-3"><label>Data de Expedi√ß√£o</label><input type="date" id="dataExpedicao"></div>
        <div class="form-group span-3"><label>Cargo/Fun√ß√£o</label><input type="text" id="cargo"></div>
        <div class="form-group span-6">
          <label>Lota√ß√£o</label>
          <select id="lotacao"><option value="">Selecione...</option></select>
        </div>
        <div class="form-group span-6"><label>Unidade de Exerc√≠cio</label><input type="text" id="unidade"></div>
       <div class="form-group span-6">
          <label>Tipo de Requerimento</label>
          <select id="tipo"><option value="">Selecione...</option></select>
        </div>
        <div class="form-group span-6">
          <label>Requer ao</label>
          <select id="requerAo">
            <option value="">Selecione...</option>
            <option value="SECRET√ÅRIO">SECRET√ÅRIO</option>
            <option value="COORDENADOR DE RH">COORDENADOR DE RH</option>
            <option value="PREFEITA">PREFEITA</option>
          </select>
        </div>
        <div class="form-group span-3"><label>Data Solicita√ß√£o</label><input type="date" id="dataSolicitacao"></div>
       <div class="form-group full-row">
          <label>Informa√ß√µes Complementares</label>
          <textarea id="complemento" rows="8"></textarea>
        </div>
      </form>
      <button onclick="enviarRequerimento()">Enviar Requerimento</button>
      <button onclick="window.print()">Imprimir</button>
      <button onclick="mostrarTela('menu')">Voltar</button>
      <div id="log" class="log-area"></div>
  </div>

  <div id="relatorios" class="relatorios-screen content">
    <h3>üîç Relat√≥rios e Pesquisa Avan√ßada</h3>
    <div class="filtros">
        <input type="text" id="filtroNumero" placeholder="N√∫mero do Protocolo">
        <input type="text" id="filtroNome" placeholder="Nome do Requerente">
        <select id="filtroStatus">
        <option value="">Todos os Status</option>
        <option value="Em an√°lise">Em an√°lise</option>
        <option value="Pendente de documento">Pendente de documento</option>
        <option value="Finalizado">Finalizado</option>
        <option value="Encaminhado">Encaminhado</option>
        </select>
        <input type="date" id="filtroDataInicio" title="Data de In√≠cio">
        <input type="date" id="filtroDataFim" title="Data Final">
        <select id="filtroTipo">
        <option value="">Todo tipo de Requerimento</option>
        </select>
        <select id="filtroLotacao">
        <option value="">Todas as Lota√ß√µes</option>
        </select>
    </div>
    <div>
        <button onclick="pesquisarProtocolos()">Pesquisar</button>
        <button onclick="gerarRelatorioPDF()">üìÑ Gerar PDF</button>
        <button onclick="exportarRelatorioExcel()">üìä Exportar para Excel</button>
        <button onclick="limparFiltrosRelatorio()">Limpar Filtros</button>
        <button onclick="mostrarTela('menu')">üîô Voltar</button>
    </div>
    <table id="tabelaRelatorios">
        <thead>
        <tr>
            <th>N√∫mero</th>
            <th>Requerente</th>
            <th>Matr√≠cula</th>
            <th>Tipo de Requerimento</th>
            <th>Data</th>
            <th>Status</th>
            <th>Respons√°vel</th>
        </tr>
        </thead>
        <tbody id="resultadosPesquisa"></tbody>
    </table>
  </div>

  <div id="protocolos" class="protocolos-screen content">
    <h3>üìã Lista de Protocolos Enviados</h3>
    <table>
      <thead>
        <tr>
            <th>N√∫mero</th>
            <th>Matr√≠cula</th>
            <th>Nome</th>
            <th>Tipo</th>
            <th>Status</th>
            <th>Respons√°vel</th>
            <th>A√ß√£o</th>
        </tr>
      </thead>
      <tbody id="tabelaProtocolos"></tbody>
    </table>
    <button onclick="mostrarTela('menu')">Voltar</button>
    <div id="paginacaoProtocolos"></div>
  </div>

  <div id="meusProtocolos" class="meus-protocolos-screen content">
      <h3>üìÇ Meus Protocolos</h3>
      <div class="filtros" style="padding: 10px 0;">
        <input type="text" id="filtroMeusProtocolosNumero" placeholder="Filtrar por N√∫mero">
        <input type="text" id="filtroMeusProtocolosNome" placeholder="Filtrar por Nome">
        <button onclick="listarMeusProtocolos()">Filtrar</button>
        <button onclick="limparFiltrosMeusProtocolos()">Limpar Filtros</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>N√∫mero</th>
            <th>Nome</th>
            <th>Status</th>
            <th>A√ß√£o</th>
          </tr>
        </thead>
        <tbody id="meusProtocolosTabela"></tbody>
      </table>
      <button onclick="voltarDeMeusProtocolos()">Voltar</button>
      <div id="paginacaoMeusProtocolos"></div>
  </div>

  <div id="config" class="config-screen content">
    <h3>‚öôÔ∏è Configura√ß√µes</h3>
    <div class="form-group full-row">
      <label>Email do Sistema:</label>
      <input type="email" id="emailSistemaConfig" />
      <button onclick="salvarEmailSistema()">Salvar Email</button>
    </div>
    <hr style="margin: 20px 0;">
    <h4>Adicionar Novo Usu√°rio:</h4>
    <div class="form-group full-row">
      <input type="text" id="nomeCompleto" placeholder="Nome completo" />
      <input type="text" id="novoUsuario" placeholder="Nome de usu√°rio" />
      <input type="text" id="cpfUsuario" placeholder="CPF (somente n√∫meros)" />
      <input type="password" id="novaSenha" placeholder="Senha" />
      <input type="email" id="novoEmail" placeholder="E-mail do usu√°rio" />
      <select id="nivelUsuario">
        <option value="comum">Comum</option>
        <option value="padrao">Padr√£o</option>
        <option value="admin">Administrador</option>
      </select>
      <button onclick="cadastrarUsuario()">Cadastrar Usu√°rio</button>
    </div>
    <hr style="margin: 20px 0;">
    <h4>Usu√°rios Cadastrados:</h4>
    <table style="width:100%;">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Login</th>
          <th>Email</th>
          <th>Tipo</th>
          <th>Status</th>
          <th style="width: 280px;">A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tabelaUsuarios"></tbody>
    </table>
    <hr style="margin: 20px 0;">
    <h4>Gerenciar Listas</h4>
    <h5>Tipos de Requerimento</h5>
    <div class="form-group" style="flex-direction: row; gap: 10px; align-items: center;">
        <input type="text" id="novoTipoNome" placeholder="Nome do novo tipo" style="flex-grow: 1;">
        <button onclick="adicionarItem('tipos')">Adicionar</button>
    </div>
    <table style="width:100%;">
        <thead><tr><th>Nome</th><th>Status</th><th style="width: 120px;">A√ß√µes</th></tr></thead>
        <tbody id="tabelaTipos"></tbody>
    </table>
    <br>
    <h5>Lota√ß√µes</h5>
    <div class="form-group" style="flex-direction: row; gap: 10px; align-items: center;">
        <input type="text" id="novaLotacaoNome" placeholder="Nome da nova lota√ß√£o" style="flex-grow: 1;">
        <button onclick="adicionarItem('lotacoes')">Adicionar</button>
    </div>
    <table style="width:100%;">
        <thead><tr><th>Nome</th><th>Status</th><th style="width: 120px;">A√ß√µes</th></tr></thead>
        <tbody id="tabelaLotacoes"></tbody>
    </table>
    <hr style="margin: 20px 0;">
    <h4>Gerar Backup de Protocolos</h4>
    <label>Data In√≠cio:</label>
    <input type="date" id="backupDataInicio" />
    <label>Data Fim:</label>
    <input type="date" id="backupDataFim" />
    <button onclick="gerarBackup()">Gerar Backup</button>
    <br><br>
    <button onclick="mostrarTela('menu')">Voltar</button>
  </div>
</div>

<div id="modeloProtocolo" style="display: none;">
  <style>
    .pdf-body { font-family: "Segoe UI", "Open Sans", sans-serif; color: #000; margin: 0; padding: 0; box-sizing: border-box; }
    .doc-container { background: white; width: 100%; max-width: 800px; margin: 20px auto; padding: 40px 50px; border: 1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .pdf-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #ddd; padding-bottom: 15px; margin-bottom: 20px;}
    .logo-pdf img { height: 80px; }
    #qrcode-container { padding-left: 20px; }
    .titulo-principal-pdf { text-align: center; margin: 2px 0; font-size: 22px; }
    .titulo-central-pdf { text-align: center; margin-bottom: 20px; }
    .titulo-central-pdf span { background: #2e7d32; color: white; font-size: 16px; padding: 8px 20px; border-radius: 4px; display: inline-block; font-weight: bold; }
    .info-pdf { margin-bottom: 20px; display: flex; justify-content: space-between; gap: 20px; }
    .campo-destaque-pdf { font-weight: bold; font-size: 14px; background-color: #2e7d32; color: white; padding: 8px 12px; border-radius: 5px; margin: 4px 0; flex: 1; text-align: center; }
    .section-title-pdf { background: #f0f0f0; font-weight: bold; padding: 6px 10px; border-left: 4px solid #4caf50; margin-top: 20px; }
    .grid-pdf { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 30px; margin-top: 10px; }
    .grid-pdf div { font-size: 14px; }
    .box-pdf { border: 1px solid #ddd; padding: 10px; border-radius: 6px; background: #fafafa; margin-top: 10px; font-style: italic; }
    .assinaturas-pdf { display: flex; justify-content: space-between; margin-top: 100px; page-break-inside: avoid; }
    .assinatura-pdf { text-align: center; width: 45%; }
    .linha-pdf { border-top: 1px solid #000; margin-top: 40px; }
    .rodape-pdf { text-align: center; margin-top: 40px; page-break-inside: avoid; }
    .rodape-pdf img { max-width: 100%; height: auto; }
  </style>
  <div class="pdf-body doc-container">
    <div class="pdf-header">
      <div class="logo-pdf"><img src="/img/logo.png" alt="Logo Prefeitura" /></div>
      <div id="qrcode-container"></div>
    </div>
    <h1 class="titulo-principal-pdf">Secretaria da Administra√ß√£o</h1>
    <div class="titulo-central-pdf"><span>PROTOCOLO DE REQUERIMENTO</span></div>
    <div class="info-pdf">
      <p class="campo-destaque-pdf"><strong>N√∫mero do Protocolo:</strong> <span id="doc_numero"></span></p>
      <p class="campo-destaque-pdf"><strong>Data da Solicita√ß√£o:</strong> <span id="doc_dataSolicitacao"></span></p>
    </div>
    <div class="section-title-pdf">DADOS DO REQUERENTE</div>
    <div class="grid-pdf">
      <div><strong>Nome:</strong> <span id="doc_nome"></span></div>
      <div><strong>Bairro:</strong> <span id="doc_bairro"></span></div>
      <div><strong>Matr√≠cula:</strong> <span id="doc_matricula"></span></div>
      <div><strong>Munic√≠pio:</strong> <span id="doc_municipio"></span></div>
      <div><strong>CPF:</strong> <span id="doc_cpf"></span></div>
      <div><strong>CEP:</strong> <span id="doc_cep"></span></div>
      <div><strong>RG:</strong> <span id="doc_rg"></span></div>
      <div><strong>Lota√ß√£o:</strong> <span id="doc_lotacao"></span></div>
      <div><strong>Endere√ßo:</strong> <span id="doc_endereco"></span></div>
      <div><strong>Unidade de Exerc√≠cio:</strong> <span id="doc_unidade"></span></div>
      <div><strong>Telefone:</strong> <span id="doc_telefone"></span></div>
      <div><strong>Cargo/Fun√ß√£o:</strong> <span id="doc_cargo"></span></div>
    </div>
    <div class="section-title-pdf">DADOS DO REQUERIMENTO</div>
    <div style="margin-top: 10px;">
      <div style="margin-bottom: 6px;"><strong>Tipo de Requerimento:</strong> <span id="doc_tipo"></span></div>
      <div style="margin-bottom: 10px;"><strong>Requer ao:</strong> <span id="doc_requerAo"></span></div>
    </div>
    <div class="box-pdf" id="doc_complemento"></div>
    <div class="assinaturas-pdf">
      <div class="assinatura-pdf"><div class="linha-pdf"></div>Assinatura do Requerente</div>
      <div class="assinatura-pdf"><div class="linha-pdf"></div>Respons√°vel pelo Protocolo</div>
    </div>
    <div class="rodape-pdf"><img src="/img/rodape.jpg" alt="Rodap√©" /></div>
  </div>
</div>
<div id="pdfModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);">
  <div style="background-color: #fefefe; margin: 20px auto; padding: 0; border: 1px solid #888; width: 95%; max-width: 800px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);">
    <div style="text-align: right; background: #2e7d32; padding: 5px 15px;"><span style="color: white; font-size: 28px; font-weight: bold; cursor: pointer;" onclick="fecharModal('pdfModal')">&times;</span></div>
    <div id="pdfContent" style="padding: 20px;"></div>
    <div style="text-align: center; padding: 10px; border-top: 1px solid #ddd;"><button onclick="gerarPDF()">Gerar e Salvar PDF</button></div>
  </div>
</div>
<div id="modalEncaminhar" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.3); width:300px; max-width:90%;">
    <h3>Encaminhar Protocolo</h3>
    <label for="selectUsuarioEncaminhar" style="display:block; text-align:left; margin-bottom:5px;">Para o usu√°rio:</label>
    <select id="selectUsuarioEncaminhar" style="width:100%; padding:8px; margin-bottom:10px;"></select>
    <label for="statusEncaminhamento" style="display:block; text-align:left; margin-bottom:5px;">Definir status como:</label>
    <input type="text" id="statusEncaminhamento" style="width:100%; padding:8px; margin-bottom:15px; box-sizing: border-box;">
    <div style="text-align:right;">
      <button onclick="confirmarEncaminhamento()" style="margin-right:10px;">Confirmar</button>
      <button onclick="fecharModal('modalEncaminhar')">Cancelar</button>
    </div>
  </div>
</div>
<div id="modalAtualizarStatus" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.3); width:400px; max-width:90%;">
    <h3>Atualizar Status do Protocolo</h3>
    <label for="statusSelect">Status:</label>
    <select id="statusSelect" onchange="handleStatusChange(this)" style="width:100%; padding:8px; margin-bottom:10px;">
      <option value="Em an√°lise">Em an√°lise</option>
      <option value="Pendente de documento">Pendente de documento</option>
      <option value="Finalizado">Finalizado</option>
      <option value="Outro">Outro (digitar)</option>
    </select>
    <input type="text" id="statusCustom" placeholder="Digite o status personalizado" style="display:none; width:100%; padding:8px; margin-bottom:10px; box-sizing: border-box;">
    <label for="observacaoAtualizacao">Observa√ß√£o (opcional):</label>
    <textarea id="observacaoAtualizacao" rows="4" style="width:100%; padding:8px; margin-bottom:15px; box-sizing: border-box;"></textarea>
    <div style="text-align:right;">
      <button onclick="confirmarAtualizacaoStatus()" style="margin-right:10px;">Confirmar</button>
      <button onclick="fecharModal('modalAtualizarStatus')">Cancelar</button>
    </div>
  </div>
</div>
<div id="modalEditarUsuario" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:20px; border-radius:8px; width:400px; max-width:90%;">
    <h3>Editar Usu√°rio</h3>
    <input type="hidden" id="editUserId">
    <div class="form-group"><label>Nome Completo</label><input type="text" id="editNomeCompleto"></div>
    <div class="form-group"><label>Login</label><input type="text" id="editLogin"></div>
    <div class="form-group"><label>Email</label><input type="email" id="editEmail"></div>
    <div class="form-group"><label>CPF</label><input type="text" id="editCpf"></div>
    <div class="form-group">
      <label>Tipo</label>
      <select id="editTipo">
        <option value="comum">Comum</option>
        <option value="padrao">Padr√£o</option>
        <option value="admin">Administrador</option>
      </select>
    </div>
    <div style="text-align:right; margin-top:15px;">
      <button onclick="confirmarEdicaoUsuario()">Salvar Altera√ß√µes</button>
      <button onclick="fecharModal('modalEditarUsuario')">Cancelar</button>
    </div>
  </div>
</div>
<div id="modalResetarSenha" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:20px; border-radius:8px; width:400px; max-width:90%;">
    <h3>Resetar Senha</h3>
    <input type="hidden" id="resetUserId">
    <div class="form-group">
      <label>Nova Senha</label>
      <input type="password" id="resetNovaSenha">
    </div>
    <div style="text-align:right; margin-top:15px;">
      <button onclick="confirmarResetSenha()">Confirmar Nova Senha</button>
      <button onclick="fecharModal('modalResetarSenha')">Cancelar</button>
    </div>
  </div>
</div>

<script defer>
// Vari√°veis Globais
const itensPorPagina = 10;
let paginaAtualTodos = 1;
let paginaAtualMeus = 1;
let tiposChartInstance = null;
window.opcoesTipos = [];
window.opcoesLotacoes = [];

// Fun√ß√µes de Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', () => {
  window.usuarioLogado = localStorage.getItem('usuarioLogado') || "";
  window.nivelUsuario = localStorage.getItem('nivelUsuario') || "";
  window.usuarioLogin = localStorage.getItem('usuarioLogin') || "";
  if (window.usuarioLogado) {
    document.getElementById('btnDashboard').style.display = (window.nivelUsuario === 'admin' || window.nivelUsuario === 'padrao') ? 'flex' : 'none';
    document.getElementById('btnConfig').style.display = window.nivelUsuario === "admin" ? "flex" : "none";
    document.getElementById('btnNovo').style.display = (window.nivelUsuario === "admin" || window.nivelUsuario === "padrao") ? "flex" : "none";
    document.getElementById('btnRelatorios').style.display = (window.nivelUsuario === "admin" || window.nivelUsuario === "padrao") ? "flex" : "none";
    if (window.nivelUsuario === "comum") {
      mostrarTela('meusProtocolos');
    } else {
      mostrarTela('menu');
    }
  } else {
    mostrarTela('login');
  }
});

async function logar() {
  const user = document.getElementById('usuario').value;
  const senha = document.getElementById('senha').value;
  const msg = document.getElementById('loginMsg');
  try {
    const res = await fetch('/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ login: user, senha: senha })
    });
    const data = await res.json();
    if (data.sucesso && data.usuario) {
      localStorage.setItem('usuarioLogado', data.usuario.nome);
      localStorage.setItem('usuarioLogin', data.usuario.login);
      localStorage.setItem('nivelUsuario', data.usuario.tipo);
      window.usuarioLogado = data.usuario.nome;
      window.usuarioLogin = data.usuario.login;
      window.nivelUsuario = data.usuario.tipo;

      await carregarOpcoesDropdowns();
      verificarNotificacoes();

      document.getElementById('btnDashboard').style.display = (window.nivelUsuario === 'admin' || window.nivelUsuario === 'padrao') ? 'flex' : 'none';
      document.getElementById('btnConfig').style.display = window.nivelUsuario === "admin" ? "flex" : "none";
      document.getElementById('btnNovo').style.display = (window.nivelUsuario === "admin" || window.nivelUsuario === "padrao") ? "flex" : "none";
      document.getElementById('btnRelatorios').style.display = (window.nivelUsuario === "admin" || window.nivelUsuario === "padrao") ? "flex" : "none";

      if (window.nivelUsuario === "comum") {
        mostrarTela('meusProtocolos');
      } else {
        mostrarTela('menu');
      }
      msg.textContent = "";
    } else {
      msg.textContent = "Usu√°rio ou senha incorretos.";
    }
  } catch(err) {
    console.error("Erro no login:", err);
    msg.textContent = "Erro ao conectar ao servidor.";
  }
};

function sair() {
  localStorage.clear();
  window.usuarioLogado = "";
  window.nivelUsuario = "";
  window.usuarioLogin = "";
  document.getElementById('notification-bell').style.display = 'none';
  window.location.reload();
}

// Fun√ß√µes de Controle de Tela
async function mostrarTela(tela) {
  ['login','menu','dashboard','form','config','protocolos','meusProtocolos','relatorios'].forEach(id => {
    document.getElementById(id)?.classList.remove('active');
  });
  if (window.nivelUsuario && tela === 'relatorios' && window.nivelUsuario === 'comum') {
    alert('Acesso restrito!');
    return;
  }
  document.getElementById(tela).classList.add('active');

  if (tela === 'meusProtocolos') {
    const usuarioLogin = localStorage.getItem('usuarioLogin');
    if (usuarioLogin) {
      try {
        await fetch('/protocolos/notificacoes/ler', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ usuarioLogin })
        });
        document.getElementById('notification-bell').style.display = 'none';
      } catch (err) { console.error('Erro ao marcar notifica√ß√µes como lidas:', err); }
    }
  }
  
  // Carrega os dados espec√≠ficos da tela
  if (tela === 'protocolos') listarProtocolos();
  if (tela === 'meusProtocolos') listarMeusProtocolos();
  if (tela === 'form') { popularDropdownsFormulario(); gerarNumeroProtocolo(); }
  if (tela === 'config') { atualizarListaUsuarios(); carregarTabelaGestao('tipos'); carregarTabelaGestao('lotacoes'); }
  if (tela === 'relatorios') { popularFiltrosRelatorio(); pesquisarProtocolos(); }
  if (tela === 'dashboard') carregarDashboard();
}

// Fun√ß√µes de Protocolo
async function gerarNumeroProtocolo() { /* ... */ }
function enviarRequerimento() { /* ... */ }
async function listarProtocolos(pagina = 1) { /* ... */ }
async function listarMeusProtocolos(pagina = 1) { /* ... */ }
function limparFiltrosMeusProtocolos() { /* ... */ }
async function carregarHistorico(protocoloId) { /* ... */ }

// Fun√ß√µes de Modais
function fecharModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
async function abrirModalEncaminhar(idProtocolo) { /* ... */ }
async function confirmarEncaminhamento() { /* ... */ }
async function abrirAtualizar(id) { /* ... */ }
function handleStatusChange(selectElement) { /* ... */ }
async function confirmarAtualizacaoStatus() { /* ... */ }

// Fun√ß√µes de PDF e QR Code
let protocoloParaGerar = null;
async function previsualizarPDF(id) { /* ... */ }
async function gerarPDF() { /* ... */ }

// Fun√ß√µes de Relat√≥rios
function popularFiltrosRelatorio() { /* ... */ }
async function pesquisarProtocolos() { /* ... */ }
async function gerarRelatorioPDF() { /* ... */ }
function exportarRelatorioExcel() { /* ... */ }
function limparFiltrosRelatorio() { /* ... */ }

// Fun√ß√µes de Notifica√ß√£o
async function verificarNotificacoes() { /* ... */ }

// Fun√ß√µes de Dashboard
async function carregarDashboard() { /* ... */ }

// Fun√ß√µes de Configura√ß√£o e Usu√°rios
function salvarEmailSistema() { /* ... */ }
async function cadastrarUsuario() { /* ... */ }
async function atualizarListaUsuarios() { /* ... */ }
function abrirModalEditar(usuario) { /* ... */ }
async function confirmarEdicaoUsuario() { /* ... */ }
function abrirModalResetarSenha(id) { /* ... */ }
async function confirmarResetSenha() { /* ... */ }
async function alterarStatusUsuario(id, novoStatus) { /* ... */ }

// Fun√ß√µes de Gerenciamento de Listas
async function carregarOpcoesDropdowns() { /* ... */ }
function popularDropdown(selectId, opcoes) { /* ... */ }
async function carregarTabelaGestao(tipo) { /* ... */ }
async function adicionarItem(tipo) { /* ... */ }
async function alterarStatusItem(tipo, id, novoStatus) { /* ... */ }

// Fun√ß√µes Auxiliares
async function gerarBackup() { /* ... */ }
function renderizarPaginacao(totalItens, paginaAtual, idContainer, callback) { /* ... */ }
function voltarDeMeusProtocolos() { /* ... */ }
function preencherCamposServidor(servidor) { /* ... */ }

// Event Listeners
document.getElementById('matricula').addEventListener('blur', async function() { /* ... */ });
document.getElementById('cep').addEventListener('blur', async function () { /* ... */ });

</script>
</body>
</html>
