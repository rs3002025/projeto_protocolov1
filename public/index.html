<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sistema de Protocolo</title>
<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f5f5f5;
}
.container {
  max-width: 1500px;
  margin: 40px auto;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  overflow: hidden;
  padding-bottom: 30px;
}
.header {
  background: #2e7d32;
  color: white;
  padding: 20px;
  text-align: center;
  border-radius: 0 0 15px 15px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.logo {
  height: 80px;
  margin-bottom: 5px;
}
.header h2, .header h3 {
  margin: 5px 0;
}
.header img {
  height: 60px;
  width: auto;
}
.content {
  padding: 20px 30px;
  display: none;
}
.content.active {
  display: block;
}
.menu, .login-screen, .form-screen, .protocolos-screen, .config-screen, .meus-protocolos-screen, .relatorios-screen {
  display: none;
}
.active {
  display: block;
}
.formulario {
  display: grid;
  grid-template-columns: repeat(12, 1fr);
  gap: 15px 20px;
}
.form-group {
  display: flex;
  flex-direction: column;
}
.full-row { grid-column: span 12; }
.span-6 { grid-column: span 6; }
.span-4 { grid-column: span 4; }
.span-3 { grid-column: span 3; }
.span-2 { grid-column: span 2; }
label {
  margin-bottom: 5px;
  font-weight: 600;
}
input, select, textarea {
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 8px;
  font-size: 1em;
}
button {
  padding: 10px 12px;
  border: none;
  background: #2e7d32;
  color: white;
  border-radius: 8px;
  cursor: pointer;
  margin: 5px 10px 5px 0;
}
.log-area {
  margin-top: 20px;
  font-size: 0.9em;
  background: #eee;
  padding: 10px;
  border-radius: 6px;
  min-height: 24px;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}
th, td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: left;
  vertical-align: top;
}
th {
  background-color: #e0e0e0;
}
details {
  margin-top: 5px;
  font-size: 0.9em;
}
summary {
  cursor: pointer;
  font-weight: bold;
  color: #2e7d32;
}
.filtros {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
  background: #f5f5f5;
  padding: 15px;
  border-radius: 8px;
}
.filtros input, .filtros select {
  padding: 8px;
  border-radius: 4px;
  border: 1px solid #ccc;
}
#resultadosPesquisa {
  background: white;
}
.modal-encaminhar-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.modal-encaminhar-box {
  background-color: white;
  padding: 20px;
  border-radius: 10px;
  width: 300px;
  max-width: 90%;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
  text-align: center;
}
.modal-encaminhar-actions {
  margin-top: 15px;
  display: flex;
  justify-content: space-between;
}
#modeloProtocolo {
  width: 100%;
  max-width: 700px;
  margin: 0 auto;
  padding: 20px;
  font-family: Arial, sans-serif;
  font-size: 14px;
  line-height: 1.5;
  color: #000;
  box-sizing: border-box;
}
#modeloProtocolo h2,
#modeloProtocolo h3 {
  text-align: center;
  margin: 10px 0;
}
#modeloProtocolo p {
  margin: 8px 0;
  page-break-inside: avoid;
}
#modeloProtocolo span {
  display: inline-block;
  max-width: 100%;
  word-wrap: break-word;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
<div class="container">
  <div class="header">
    <img src="/img/logo.png" alt="Logo" class="logo">
    <h2>Prefeitura de Morada Nova</h2>
    <h3>Sistema de Protocolo</h3>
  </div>
  <div id="login" class="login-screen active content">
    <label>Usu√°rio</label>
    <input type="text" id="usuario" />
    <label>Senha</label>
    <input type="password" id="senha" />
    <button onclick="logar()">Entrar</button>
    <p id="loginMsg" style="color:red;"></p>
  </div>
  <div id="menu" class="menu content">
    <button id="btnNovo" onclick="mostrarTela('form')">Novo Protocolo</button>
    <button onclick="mostrarTela('protocolos')">Todos os Protocolos</button>
    <button onclick="mostrarTela('relatorios')" id="btnRelatorios">Relat√≥rios</button>
    <button onclick="mostrarTela('meusProtocolos')">Meus Protocolos</button>
    <button id="btnConfig" onclick="mostrarTela('config')">‚öôÔ∏è Configura√ß√µes</button>
    <button onclick="sair()">Sair</button>
  </div>
  <div id="form" class="form-screen content">
    <form class="formulario" onsubmit="return false;">
      <div class="form-group span-3"><label>N√∫mero do Protocolo</label><input type="text" id="numeroProtocolo" readonly></div>
      <div class="form-group span-3"><label>Matr√≠cula</label><input type="text" id="matricula"></div>
      <div class="form-group span-6"><label>Nome Completo</label><input type="text" id="nome"></div>
      <div class="form-group span-6"><label>Endere√ßo</label><input type="text" id="endereco"></div>
      <div class="form-group span-3"><label>Munic√≠pio</label><input type="text" id="municipio" value="Morada Nova"></div>
      <div class="form-group span-3">
        <label for="bairro">Bairro</label>
        <select id="bairro" name="bairro" class="form-control">
          <option value="">Selecione um bairro</option>
          <option value="Centro">Centro</option>
          <option value="Giril√¢ndia">Giril√¢ndia</option>
          <option value="Padre Assis Monteiro">Padre Assis Monteiro</option>
          <option value="Herm√≥genes Henrique Gir√£o">Herm√≥genes Henrique Gir√£o</option>
          <option value="S√£o Jos√©">S√£o Jos√©</option>
          <option value="Nossa Senhora da Concei√ß√£o">Nossa Senhora da Concei√ß√£o</option>
          <option value="Planalto Aeroporto">Planalto Aeroporto</option>
          <option value="J√∫lia Santiago">J√∫lia Santiago</option>
          <option value="S√£o Francisco">S√£o Francisco</option>
          <option value="Nova Morada">Nova Morada</option>
          <option value="Divino Esp√≠rito Santo">Divino Esp√≠rito Santo</option>
          <option value="Alto Tiradentes">Alto Tiradentes</option>
          <option value="Capit√£o Dion√≠sio Matos de Fontes">Capit√£o Dion√≠sio Matos de Fontes</option>
          <option value="Irapuan Nobre">Irapuan Nobre</option>
          <option value="Dois de Agosto">Dois de Agosto</option>
          <option value="Cristo Rei">Cristo Rei</option>
          <option value="Sede Rural">Sede Rural</option>
          <option value="Outro">Outro</option>
        </select>
      </div>
      <div class="form-group span-3"><label>CEP</label><input type="text" id="cep"></div>
      <div class="form-group span-3"><label>Telefone</label><input type="text" id="telefone"></div>
      <div class="form-group span-3"><label>CPF</label><input type="text" id="cpf"></div>
      <div class="form-group span-3"><label>RG</label><input type="text" id="rg"></div>
      <div class="form-group span-3"><label>Data de Expedi√ß√£o</label><input type="date" id="dataExpedicao"></div>
      <div class="form-group span-3"><label>Cargo/Fun√ß√£o</label><input type="text" id="cargo"></div>
      <div class="form-group span-6">
        <label>Lota√ß√£o</label>
        <select id="lotacao">
          <option value="">Selecione...</option>
          <option value="AMT">AMT</option>
          <option value="IPREMN">IPREMN</option>
          <option value="IMAMN">IMAMN</option>
          <option value="SAS">SAS</option>
          <option value="SEINFRA">SEINFRA</option>
          <option value="SESA">SESA</option>
          <option value="SEAD">SEAD</option>
          <option value="SEAGRI">SEAGRI</option>
          <option value="SEAI">SEAI</option>
          <option value="SECULT">SECULT</option>
          <option value="SEDEM">SEDEM</option>
          <option value="SEDUCTEC">SEDUCTEC</option>
          <option value="SEFIN">SEFIN</option>
          <option value="SSPDC">SSPDC</option>
          <option value="SEJUV">SEJUV</option>
          <option value="SAAE">SAAE</option>
        </select>
      </div>
      <div class="form-group span-6"><label>Unidade de Exerc√≠cio</label><input type="text" id="unidade"></div>
      <div class="form-group span-6">
        <label>Tipo de Requerimento</label>
        <select id="tipo">
          <option value="">Selecione...</option>
          <option value="Adicional de tempo de servi√ßos">Adicional de tempo de servi√ßos</option>
          <option value="Adicional de insalubridade">Adicional de insalubridade</option>
          <option value="Adicional de periculosidade">Adicional de periculosidade</option>
          <option value="Adicional de atividades penosas">Adicional de atividades penosas</option>
          <option value="Adicional por servi√ßos extraordin√°rios">Adicional por servi√ßos extraordin√°rios</option>
          <option value="Adicional noturno">Adicional noturno</option>
          <option value="Adicional de f√©rias">Adicional de f√©rias</option>
          <option value="Afastamento p. servir a outro √≥rg√£o ou entidade">Afastamento p. servir a outro √≥rg√£o ou entidade</option>
          <option value="Afastamento para exerc√≠cio de mandato eletivo">Afastamento para exerc√≠cio de mandato eletivo</option>
          <option value="Afastamento para estudo fora do munic√≠pio">Afastamento para estudo fora do munic√≠pio</option>
          <option value="Altera√ß√£o do cadastro funcional/pessoal">Altera√ß√£o do cadastro funcional/pessoal</option>
          <option value="Aposentadoria">Aposentadoria</option>
          <option value="Certid√£o por tempo de contribui√ß√£o">Certid√£o por tempo de contribui√ß√£o</option>
          <option value="C√≥pia de Documenta√ß√£o">C√≥pia de Documenta√ß√£o</option>
          <option value="Declara√ß√£o">Declara√ß√£o</option>
          <option value="Exonera√ß√£o de cargo/fun√ß√£o">Exonera√ß√£o de cargo/fun√ß√£o</option>
          <option value="F√©rias">F√©rias</option>
          <option value="Ficha financeira">Ficha financeira</option>
          <option value="Gratifica√ß√£o natalina">Gratifica√ß√£o natalina</option>
          <option value="Gratifica√ß√£o de incentivo profissional">Gratifica√ß√£o de incentivo profissional</option>
          <option value="Gratifica√ß√£o p√≥s-gradua√ß√£o">Gratifica√ß√£o p√≥s-gradua√ß√£o</option>
          <option value="Gratifica√ß√£o retribui√ß√£o pecuni√°ria">Gratifica√ß√£o retribui√ß√£o pecuni√°ria</option>
          <option value="Gratifica√ß√£o de dif√≠cil acesso">Gratifica√ß√£o de dif√≠cil acesso</option>
          <option value="Licen√ßa para atividades pol√≠ticas">Licen√ßa para atividades pol√≠ticas</option>
          <option value="Licen√ßa para capacita√ß√£o">Licen√ßa para capacita√ß√£o</option>
          <option value="Licen√ßa para desempenho de mandato classista">Licen√ßa para desempenho de mandato classista</option>
          <option value="Licen√ßa por motivo de doen√ßa na fam√≠lia">Licen√ßa por motivo de doen√ßa na fam√≠lia</option>
          <option value="Licen√ßa por motivo de afastamento do c√¥njuge">Licen√ßa por motivo de afastamento do c√¥njuge</option>
          <option value="Licen√ßa para servi√ßo militar">Licen√ßa para servi√ßo militar</option>
          <option value="Licen√ßa para tratar de interesse particular">Licen√ßa para tratar de interesse particular</option>
          <option value="Licen√ßa Especial">Licen√ßa Especial</option>
          <option value="Reposi√ß√£o de faltas">Reposi√ß√£o de faltas</option>
          <option value="Quebra de v√≠nculo">Quebra de v√≠nculo</option>
          <option value="CTC">CTC</option>
          <option value="Simula√ß√£o por tempo de servi√ßo">Simula√ß√£o por tempo de servi√ßo</option>
          <option value="Acerto de CNIS">Acerto de CNIS</option>
          <option value="Declara√ß√£o para o Bolsa Fam√≠lia">Declara√ß√£o para o Bolsa Fam√≠lia</option>
          <option value="Declara√ß√£o para sele√ß√£o">Declara√ß√£o para sele√ß√£o</option>
          <option value="Abono de perman√™ncia">Abono de perman√™ncia</option>
          <option value="Sal√°rio fam√≠lia">Sal√°rio fam√≠lia</option>
          <option value="Outros">Outros</option>
        </select>
      </div>
      <div class="form-group span-6">
        <label>Requer ao</label>
        <select id="requerAo">
          <option value="">Selecione...</option>
          <option value="SECRET√ÅRIO">SECRET√ÅRIO</option>
          <option value="COORDENADOR DE RH">COORDENADOR DE RH</option>
          <option value="PREFEITA">PREFEITA</option>
        </select>
      </div>
      <div class="form-group span-3"><label>Data Solicita√ß√£o</label><input type="date" id="dataSolicitacao"></div>
      <div class="form-group full-row">
        <label>Informa√ß√µes Complementares</label>
        <textarea id="complemento" rows="8"></textarea>
      </div>
    </form>
    <button onclick="enviarRequerimento()">Enviar Requerimento</button>
    <button onclick="window.print()">Imprimir</button>
    <button onclick="mostrarTela('menu')">Voltar</button>
    <div id="log" class="log-area"></div>
  </div>
  <div id="modalEncaminhar" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:#fff; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.3); width:300px; max-width:90%;">
      <h3>Encaminhar para:</h3>
      <select id="selectUsuarioEncaminhar" style="width:100%; margin-bottom:10px;"></select>
      <div style="text-align:right;">
        <button onclick="confirmarEncaminhamento()" style="margin-right:10px;">Confirmar</button>
        <button onclick="fecharModalEncaminhar()">Cancelar</button>
      </div>
    </div>
  </div>
  <div id="relatorios" class="relatorios-screen content">
    <h3>üîç Pesquisar Protocolos</h3>
    <div class="filtros">
      <input type="text" id="filtroNumero" placeholder="N√∫mero do Protocolo">
      <input type="text" id="filtroNome" placeholder="Nome do Requerente">
      <select id="filtroStatus">
        <option value="">Todos os status</option>
        <option value="Aberto">Aberto</option>
        <option value="Em an√°lise">Em an√°lise</option>
        <option value="Conclu√≠do">Conclu√≠do</option>
      </select>
      <button onclick="pesquisarProtocolos()">Pesquisar</button>
      <button onclick="gerarRelatorio()">üìä Gerar Relat√≥rio</button>
      <button onclick="voltarDeRelatorios()">üîô Voltar</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>N√∫mero</th>
          <th>Nome</th>
          <th>Status</th>
          <th>Data Solicita√ß√£o</th>
          <th>Tipo</th>
          <th>CPF</th>
        </tr>
      </thead>
      <tbody id="resultadosPesquisa"></tbody>
    </table>
  </div>
  <div id="protocolos" class="protocolos-screen content">
    <h3>üìã Lista de Protocolos Enviados</h3>
    <table>
      <thead>
        <tr>
          <th>N√∫mero</th>
          <th>Matr√≠cula</th>
          <th>Nome</th>
          <th>Tipo</th>
          <th>Status</th>
          <th>Respons√°vel</th>
          <th>A√ß√£o</th>
        </tr>
      </thead>
      <tbody id="tabelaProtocolos"></tbody>
    </table>
    <button onclick="mostrarTela('menu')">Voltar</button>
  </div>
  <div id="paginacaoProtocolos" style="margin-top: 10px;"></div>
  <div id="meusProtocolos" class="meus-protocolos-screen content">
    <h3>üìÇ Meus Protocolos</h3>
    <div class="filtros" style="padding: 10px 0;">
      <input type="text" id="filtroMeusProtocolosNumero" placeholder="Filtrar por N√∫mero">
      <input type="text" id="filtroMeusProtocolosNome" placeholder="Filtrar por Nome">
      <button onclick="listarMeusProtocolos()">Filtrar</button>
      <button onclick="limparFiltrosMeusProtocolos()">Limpar Filtros</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>N√∫mero</th>
          <th>Nome</th>
          <th>Status</th>
          <th>A√ß√£o</th>
        </tr>
      </thead>
      <tbody id="meusProtocolosTabela"></tbody>
    </table>
    <button onclick="voltarDeMeusProtocolos()">Voltar</button>
  </div>
  <div id="paginacaoMeusProtocolos" style="margin-top: 10px;"></div>
  <div id="config" class="config-screen content">
    <h3>‚öôÔ∏è Configura√ß√µes</h3>
    <div class="form-group full-row">
      <label>Email do Sistema:</label>
      <input type="email" id="emailSistemaConfig" />
      <button onclick="salvarEmailSistema()">Salvar Email</button>
    </div>
    <div class="form-group full-row">
      <label>Adicionar Novo Usu√°rio:</label>
      <input type="text" id="nomeCompleto" placeholder="Nome completo" />
      <input type="text" id="novoUsuario" placeholder="Nome de usu√°rio" />
      <input type="text" id="cpfUsuario" placeholder="CPF (somente n√∫meros)" />
      <input type="password" id="novaSenha" placeholder="Senha" />
      <input type="email" id="novoEmail" placeholder="E-mail do usu√°rio" />
      <select id="nivelUsuario">
        <option value="comum">Comum</option>
        <option value="padrao">Padr√£o</option>
        <option value="admin">Administrador</option>
      </select>
      <button onclick="cadastrarUsuario()">Cadastrar Usu√°rio</button>
    </div>
    <h4>Gerar Backup de Protocolos</h4>
    <label>Data In√≠cio:</label>
    <input type="date" id="backupDataInicio" />
    <label>Data Fim:</label>
    <input type="date" id="backupDataFim" />
    <button onclick="gerarBackup()">Gerar Backup</button>
    <h4>Usu√°rios Cadastrados:</h4>
    <ul id="listaUsuarios"></ul>
    <button onclick="mostrarTela('menu')">Voltar</button>
  </div>
</div>
<div id="modeloProtocolo" style="display: none;">
  <style>
  .pdf-body { font-family: "Segoe UI", "Open Sans", sans-serif; color: #000; margin: 0; padding: 0; box-sizing: border-box; }
  .doc-container { background: white; width: 100%; max-width: 800px; margin: 20px auto; padding: 40px 50px; border: 1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
  .logo-pdf { text-align: center; margin-bottom: 2px; }
  .logo-pdf img { height: 80px; }
  .titulo-principal-pdf { text-align: center; margin: 2px 0; font-size: 22px; }
  .titulo-central-pdf { text-align: center; margin-bottom: 20px; }
  .titulo-central-pdf span { background: #2e7d32; color: white; font-size: 16px; padding: 8px 20px; border-radius: 4px; display: inline-block; font-weight: bold; }
  .info-pdf { margin-bottom: 20px; display: flex; justify-content: space-between; gap: 20px; }
  .campo-destaque-pdf { font-weight: bold; font-size: 14px; background-color: #2e7d32; color: white; padding: 8px 12px; border-radius: 5px; margin: 4px 0; flex: 1; text-align: center; }
  .section-title-pdf { background: #f0f0f0; font-weight: bold; padding: 6px 10px; border-left: 4px solid #4caf50; margin-top: 20px; }
  .grid-pdf { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 30px; margin-top: 10px; }
  .grid-pdf div { font-size: 14px; }
  .box-pdf { border: 1px solid #ddd; padding: 10px; border-radius: 6px; background: #fafafa; margin-top: 10px; font-style: italic; }
  .assinaturas-pdf { display: flex; justify-content: space-between; margin-top: 100px; }
  .assinatura-pdf { text-align: center; width: 45%; }
  .linha-pdf { border-top: 1px solid #000; margin-top: 40px; }
  .rodape-pdf { text-align: center; margin-top: 40px; }
  .rodape-pdf img { max-width: 100%; height: auto; }
  </style>
  <div class="pdf-body doc-container">
    <div class="logo-pdf">
      <img src="/img/logo.png" alt="Logo Prefeitura" />
    </div>
    <h1 class="titulo-principal-pdf">Secretaria da Administra√ß√£o</h1>
    <div class="titulo-central-pdf">
      <span>PROTOCOLO DE REQUERIMENTO</span>
    </div>
    <div class="info-pdf">
      <p class="campo-destaque-pdf"><strong>N√∫mero do Protocolo:</strong> <span id="doc_numero"></span></p>
      <p class="campo-destaque-pdf"><strong>Data da Solicita√ß√£o:</strong> <span id="doc_dataSolicitacao"></span></p>
    </div>
    <div class="section-title-pdf">DADOS DO REQUERENTE</div>
    <div class="grid-pdf">
      <div><strong>Nome:</strong> <span id="doc_nome"></span></div>
      <div><strong>Bairro:</strong> <span id="doc_bairro"></span></div>
      <div><strong>Matr√≠cula:</strong> <span id="doc_matricula"></span></div>
      <div><strong>Munic√≠pio:</strong> <span id="doc_municipio"></span></div>
      <div><strong>CPF:</strong> <span id="doc_cpf"></span></div>
      <div><strong>CEP:</strong> <span id="doc_cep"></span></div>
      <div><strong>RG:</strong> <span id="doc_rg"></span></div>
      <div><strong>Lota√ß√£o:</strong> <span id="doc_lotacao"></span></div>
      <div><strong>Endere√ßo:</strong> <span id="doc_endereco"></span></div>
      <div><strong>Unidade de Exerc√≠cio:</strong> <span id="doc_unidade"></span></div>
      <div><strong>Telefone:</strong> <span id="doc_telefone"></span></div>
      <div><strong>Cargo/Fun√ß√£o:</strong> <span id="doc_cargo"></span></div>
    </div>
    <div class="section-title-pdf">DADOS DO REQUERIMENTO</div>
    <div style="margin-top: 10px;">
      <div style="margin-bottom: 6px;"><strong>Tipo de Requerimento:</strong> <span id="doc_tipo"></span></div>
      <div style="margin-bottom: 10px;"><strong>Requer ao:</strong> <span id="doc_requerAo"></span></div>
    </div>
    <div class="box-pdf" id="doc_complemento"></div>
    <div class="assinaturas-pdf">
      <div class="assinatura-pdf">
        <div class="linha-pdf"></div>
        Assinatura do Requerente
      </div>
      <div class="assinatura-pdf">
        <div class="linha-pdf"></div>
        Respons√°vel pelo Protocolo
      </div>
    </div>
    <div class="rodape-pdf">
      <img src="/img/rodape.jpg" alt="Rodap√©" />
    </div>
  </div>
</div>
<div id="pdfModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);">
  <div style="background-color: #fefefe; margin: 20px auto; padding: 0; border: 1px solid #888; width: 95%; max-width: 800px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);">
    <div style="text-align: right; background: #2e7d32; padding: 5px 15px;">
      <span style="color: white; font-size: 28px; font-weight: bold; cursor: pointer;" onclick="fecharModal()">&times;</span>
    </div>
    <div id="pdfContent" style="padding: 20px;">
    </div>
    <div style="text-align: center; padding: 10px; border-top: 1px solid #ddd;">
      <button onclick="gerarPDF()">Gerar e Salvar PDF</button>
    </div>
  </div>
</div>
<script defer>
const itensPorPagina = 10;
let paginaAtualTodos = 1;
let paginaAtualMeus = 1;

document.addEventListener('DOMContentLoaded', () => {
  window.usuarioLogado = localStorage.getItem('usuarioLogado') || "";
  window.nivelUsuario = localStorage.getItem('nivelUsuario') || "";
  console.log("Verificando sess√£o:", window.usuarioLogado, window.nivelUsuario);
  if (window.usuarioLogado) {
    document.getElementById('btnConfig').style.display = window.nivelUsuario === "admin" ? "inline-block" : "none";
    document.getElementById('btnNovo').style.display = (window.nivelUsuario === "admin" || window.nivelUsuario === "padrao") ? "inline-block" : "none";
    document.getElementById('btnRelatorios').style.display = (window.nivelUsuario === "admin" || window.nivelUsuario === "padrao") ? "inline-block" : "none";
    if (window.nivelUsuario === "comum") {
      mostrarTela('meusProtocolos');
    } else {
      mostrarTela('menu');
    }
  } else {
    mostrarTela('login');
  }
});

window.logar = function() {
  const user = document.getElementById('usuario').value;
  const senha = document.getElementById('senha').value;
  const msg = document.getElementById('loginMsg');
  fetch('/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ login: user, senha: senha })
  })
  .then(res => res.json())
  .then(data => {
    if (data.sucesso && data.usuario) {
      localStorage.setItem('usuarioLogado', data.usuario.nome);
      localStorage.setItem('usuarioLogin', data.usuario.login);
      localStorage.setItem('nivelUsuario', data.usuario.tipo);
      window.usuarioLogado = data.usuario.nome;
      window.usuarioLogin = data.usuario.login;
      window.nivelUsuario = data.usuario.tipo;
      document.getElementById('btnConfig').style.display = window.nivelUsuario === "admin" ? "inline-block" : "none";
      document.getElementById('btnNovo').style.display = (window.nivelUsuario === "admin" || window.nivelUsuario === "padrao") ? "inline-block" : "none";
      document.getElementById('btnRelatorios').style.display = (window.nivelUsuario === "admin" || window.nivelUsuario === "padrao") ? "inline-block" : "none";
      if (window.nivelUsuario === "comum") {
        mostrarTela('meusProtocolos');
      } else {
        mostrarTela('menu');
      }
      msg.textContent = "";
    } else {
      msg.textContent = "Usu√°rio ou senha incorretos.";
    }
  })
  .catch(err => {
    console.error("Erro no login:", err);
    msg.textContent = "Erro ao conectar ao servidor.";
  });
};

window.addEventListener('load', () => {
  const modal = document.getElementById('modalEncaminhar');
  modal.style.display = 'none';
});

function mostrarTela(tela) {
  ['login','menu','form','config','protocolos','meusProtocolos','relatorios'].forEach(id => {
    document.getElementById(id).classList.remove('active');
  });
  if (tela === 'relatorios' && nivelUsuario === 'comum') {
    alert('Acesso restrito!');
    return;
  }
  document.getElementById(tela).classList.add('active');
  if (tela === 'protocolos') listarProtocolos();
  if (tela === 'meusProtocolos') listarMeusProtocolos();
  if (tela === 'form') gerarNumeroProtocolo();
  if (tela === 'config') atualizarListaUsuarios();
  if (tela === 'relatorios') pesquisarProtocolos();
}

function sair() {
  localStorage.removeItem('usuarioLogado');
  localStorage.removeItem('nivelUsuario');
  localStorage.removeItem('usuarioLogin');
  usuarioLogado = "";
  nivelUsuario = "";
  document.getElementById('usuario').value = "";
  document.getElementById('senha').value = "";
  document.getElementById('btnConfig').style.display = 'none';
  document.getElementById('btnNovo').style.display = 'none';
  document.getElementById('btnRelatorios').style.display = 'none';
  mostrarTela('login');
  window.location.href = window.location.href.split('?')[0];
}

async function gerarNumeroProtocolo() {
  const anoAtual = new Date().getFullYear();
  try {
    const res = await fetch(`/protocolos/ultimoNumero/${anoAtual}`);
    const data = await res.json();
    const ultimo = data.ultimo || 0;
    const novoNumero = `${String(ultimo + 1).padStart(4, '0')}/${anoAtual}`;
    document.getElementById('numeroProtocolo').value = novoNumero;
    document.getElementById('log').innerText = 'üìÑ N√∫mero gerado: ' + novoNumero;
  } catch (error) {
    console.error("Erro ao gerar n√∫mero:", error);
    const fallbackNumero = `0001/${anoAtual}`;
    document.getElementById('numeroProtocolo').value = fallbackNumero;
    document.getElementById('log').innerText = '‚ö†Ô∏è N√∫mero gerado localmente: ' + fallbackNumero;
  }
}

function paginarProtocolos(lista, pagina, porPagina) {
  const inicio = (pagina - 1) * porPagina;
  const fim = inicio + porPagina;
  return lista.slice(inicio, fim);
}

function enviarRequerimento() {
  const numeroProtocolo = document.getElementById('numeroProtocolo').value;
  if (!numeroProtocolo) {
    alert("‚ùóN√∫mero de protocolo n√£o gerado.");
    return;
  }
  const dataAgora = new Date().toLocaleString();
  const protocolo = {
    numero: numeroProtocolo,
    matricula: document.getElementById('matricula').value,
    nome: document.getElementById('nome').value,
    endereco: document.getElementById('endereco').value,
    municipio: document.getElementById('municipio').value,
    bairro: document.getElementById('bairro').value,
    cep: document.getElementById('cep').value,
    telefone: document.getElementById('telefone').value,
    cpf: document.getElementById('cpf').value,
    rg: document.getElementById('rg').value,
    dataExpedicao: document.getElementById('dataExpedicao').value,
    cargo: document.getElementById('cargo').value,
    lotacao: document.getElementById('lotacao').value,
    unidade: document.getElementById('unidade').value,
    tipo: document.getElementById('tipo').value,
    requerAo: document.getElementById('requerAo').value,
    dataSolicitacao: document.getElementById('dataSolicitacao').value,
    complemento: document.getElementById('complemento').value,
    dataEnvio: dataAgora,
    status: "Enviado",
    responsavel: usuarioLogado,
    movimentacoes: [
      { data: dataAgora, acao: "Criado e enviado", autor: usuarioLogado }
    ]
  };
  fetch('/protocolos', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(protocolo)
  })
  .then(res => res.json())
  .then(data => {
    if (data.sucesso) {
      alert('‚úÖ Protocolo enviado e salvo no banco com sucesso!');
      document.querySelector('.formulario').reset();
      gerarNumeroProtocolo();
    } else {
      alert('‚ùå Erro ao enviar protocolo: ' + (data.mensagem || 'Erro desconhecido'));
    }
  })
  .catch(err => {
    alert('‚ùå Erro na conex√£o: ' + err.message);
  });
}

async function listarProtocolos(pagina = 1) {
  const tbody = document.getElementById('tabelaProtocolos');
  tbody.innerHTML = "";
  paginaAtualTodos = pagina;
  try {
    const res = await fetch('/protocolos');
    const data = await res.json();
    const inicio = (pagina - 1) * itensPorPagina;
    const fim = inicio + itensPorPagina;
    const paginaDados = data.protocolos.slice(inicio, fim);
    paginaDados.forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="width: 80px; text-align: center;">${p.numero}</td>
        <td>${p.matricula}</td>
        <td>${p.nome}</td>
        <td>${p.tipo_requerimento}</td>
        <td>${p.status}</td>
        <td>${p.responsavel}</td>
        <td>
          <button onclick="abrirAtualizar(${p.id})">Atualizar</button>
          <button onclick="abrirModalEncaminhar(${p.id}, event)">Encaminhar</button>
          <button onclick="verDetalhes(${p.id})">Ver Detalhes</button>
          <button onclick="previsualizarPDF(${p.id})">üìÑ Documento</button>
          <details id="hist_${p.id}">
            <summary>Hist√≥rico</summary>
          </details>
        </td>`;
      tbody.appendChild(tr);
      setTimeout(() => carregarHistorico(p.id), 100);
    });
    renderizarPaginacao(data.protocolos.length, pagina, 'paginacaoProtocolos', listarProtocolos);
  } catch (error) {
    console.error("Erro ao listar protocolos:", error);
    alert("Erro ao buscar protocolos do banco.");
  }
}

async function listarMeusProtocolos(pagina = 1) {
  const tbody = document.getElementById('meusProtocolosTabela');
  tbody.innerHTML = "";
  paginaAtualMeus = pagina;
  const filtroNumero = document.getElementById('filtroMeusProtocolosNumero').value.trim().toLowerCase();
  const filtroNome = document.getElementById('filtroMeusProtocolosNome').value.trim().toLowerCase();
  try {
    const res = await fetch('/protocolos');
    const data = await res.json();
    const usuarioLogin = localStorage.getItem('usuarioLogin');
    if (!usuarioLogin) {
      console.error("Login de usu√°rio n√£o encontrado no localStorage.");
      return;
    }
    const protocolosFiltrados = data.protocolos.filter(p => {
      const responsavelMatch = (p.responsavel || "").trim().toLowerCase() === usuarioLogin.trim().toLowerCase();
      if (!responsavelMatch) return false;
      const numeroMatch = !filtroNumero || (p.numero || "").toLowerCase().includes(filtroNumero);
      const nomeMatch = !filtroNome || (p.nome || "").toLowerCase().includes(filtroNome);
      return numeroMatch && nomeMatch;
    });
    const inicio = (pagina - 1) * itensPorPagina;
    const fim = inicio + itensPorPagina;
    const paginaDados = protocolosFiltrados.slice(inicio, fim);
    paginaDados.forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.numero}</td>
        <td>${p.nome}</td>
        <td>${p.status}</td>
        <td>
          <button onclick="abrirAtualizar(${p.id})">Atualizar</button>
          <button onclick="abrirModalEncaminhar(${p.id}, event)">Encaminhar</button>
          <button onclick="verDetalhes(${p.id})">Ver Detalhes</button>
          <button onclick="previsualizarPDF(${p.id})">üìÑ Documento</button>
          <details id="hist_${p.id}">
            <summary>Hist√≥rico</summary>
          </details>
        </td>`;
      tbody.appendChild(tr);
      setTimeout(() => carregarHistorico(p.id), 100);
    });
    renderizarPaginacao(protocolosFiltrados.length, pagina, 'paginacaoMeusProtocolos', listarMeusProtocolos);
  } catch (error) {
    console.error("Erro ao listar meus protocolos:", error);
    alert("Erro ao buscar dados.");
  }
}

function limparFiltrosMeusProtocolos() {
  document.getElementById('filtroMeusProtocolosNumero').value = '';
  document.getElementById('filtroMeusProtocolosNome').value = '';
  listarMeusProtocolos();
}

async function abrirEncaminhar(id) {
  const novoResp = prompt("Para qual usu√°rio deseja encaminhar?");
  if (novoResp) {
    try {
      const response = await fetch(`/protocolos/atualizar`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          protocoloId: id,
          novoStatus: "Encaminhado",
          novoResponsavel: novoResp,
          observacao: `Encaminhado por ${usuarioLogado} para ${novoResp}`,
          usuarioLogado: usuarioLogado
        })
      });
      const data = await response.json();
      if (data.sucesso) {
        alert("‚úÖ Protocolo encaminhado com sucesso!");
        await carregarHistorico(id);
        if (document.getElementById('protocolos').classList.contains('active')) {
          await listarProtocolos();
        }
        if (document.getElementById('meusProtocolos').classList.contains('active')) {
          await listarMeusProtocolos();
        }
      } else {
        alert("Erro ao encaminhar protocolo.");
      }
    } catch (error) {
      console.error("Erro no encaminhamento:", error);
    }
  }
}

async function abrirAtualizar(id) {
  const novoStatus = prompt("Digite o novo status:");
  if (novoStatus) {
    try {
      const response = await fetch(`/protocolos/atualizar`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          protocoloId: id,
          novoStatus,
          novoResponsavel: usuarioLogado,
          observacao: `Status atualizado por ${usuarioLogado} para ${novoStatus}`,
          usuarioLogado: usuarioLogado
        })
      });
      const data = await response.json();
      if (data.sucesso) {
        alert("‚úÖ Status atualizado!");
        await carregarHistorico(id);
        if (document.getElementById('protocolos').classList.contains('active')) {
          await listarProtocolos();
        }
        if (document.getElementById('meusProtocolos').classList.contains('active')) {
          await listarMeusProtocolos();
        }
      } else {
        alert("Erro ao atualizar.");
      }
    } catch (error) {
      console.error("Erro na atualiza√ß√£o:", error);
    }
  }
}

async function carregarHistorico(protocoloId) {
  try {
    const res = await fetch(`/protocolos/historico/${protocoloId}`);
    const data = await res.json();
    let details = document.getElementById('hist_' + protocoloId);
    if (!details) {
      const otherTable = document.getElementById('tabelaProtocolos') || document.getElementById('meusProtocolosTabela');
      if (otherTable) {
        details = otherTable.querySelector('#hist_' + protocoloId);
      }
    }
    if (details) {
      details.innerHTML = `<summary>Hist√≥rico</summary>`;
      data.historico.forEach(h => {
        const div = document.createElement('div');
        div.textContent = `üìå ${h.status} - üë§ ${h.responsavel} - üïí ${new Date(h.data_movimentacao).toLocaleString()}${h.observacao ? ` - üìù ${h.observacao}` : ''}`;
        details.appendChild(div);
      });
    }
  } catch (error) {
    console.error("Erro ao carregar hist√≥rico:", error);
  }
}

async function gerarDocumentoPorId(id) {
  try {
    const res = await fetch(`/protocolos/${id}`);
    const { protocolo } = await res.json();
    if (!protocolo) return alert("Protocolo n√£o encontrado");
    gerarDocumentoCompleto(protocolo);
  } catch (err) {
    console.error("Erro ao gerar documento:", err);
    alert("Erro ao gerar documento.");
  }
}

let protocoloParaGerar = null;

async function previsualizarPDF(id) {
  try {
    const res = await fetch(`/protocolos/${id}`);
    const { protocolo } = await res.json();
    if (!protocolo) {
      alert("Protocolo n√£o encontrado");
      return;
    }
    protocoloParaGerar = protocolo;
    const modeloOriginal = document.getElementById('modeloProtocolo');
    modeloOriginal.querySelector('#doc_numero').textContent = protocolo.numero ?? 'N√£o informado';
    modeloOriginal.querySelector('#doc_dataSolicitacao').textContent = protocolo.data_solicitacao ? new Date(protocolo.data_solicitacao).toLocaleDateString('pt-BR') : 'N√£o informada';
    modeloOriginal.querySelector('#doc_nome').textContent = protocolo.nome ?? 'N√£o informado';
    modeloOriginal.querySelector('#doc_matricula').textContent = protocolo.matricula ?? 'N√£o informada';
    modeloOriginal.querySelector('#doc_cpf').textContent = protocolo.cpf ?? 'N√£o informado';
    modeloOriginal.querySelector('#doc_rg').textContent = protocolo.rg ?? 'N√£o informado';
    modeloOriginal.querySelector('#doc_endereco').textContent = protocolo.endereco ?? 'N√£o informado';
    modeloOriginal.querySelector('#doc_bairro').textContent = protocolo.bairro ?? 'N√£o informado';
    modeloOriginal.querySelector('#doc_municipio').textContent = protocolo.municipio ?? 'N√£o informado';
    modeloOriginal.querySelector('#doc_cep').textContent = protocolo.cep ?? 'N√£o informado';
    modeloOriginal.querySelector('#doc_telefone').textContent = protocolo.telefone ?? 'N√£o informado';
    modeloOriginal.querySelector('#doc_cargo').textContent = protocolo.cargo ?? 'N√£o informado';
    modeloOriginal.querySelector('#doc_lotacao').textContent = protocolo.lotacao ?? 'N√£o informado';
    modeloOriginal.querySelector('#doc_unidade').textContent = protocolo.unidade_exercicio ?? 'N√£o informado';
    modeloOriginal.querySelector('#doc_tipo').textContent = protocolo.tipo_requerimento ?? 'N√£o informado';
    modeloOriginal.querySelector('#doc_requerAo').textContent = protocolo.requer_ao ?? 'N√£o informado';
    modeloOriginal.querySelector('#doc_complemento').innerHTML = protocolo.observacoes ? protocolo.observacoes.replace(/\n/g, '<br>') : 'Nenhuma informa√ß√£o adicional';
    const pdfContentDiv = document.getElementById('pdfContent');
    pdfContentDiv.innerHTML = modeloOriginal.innerHTML;
    document.getElementById('pdfModal').style.display = 'block';
  } catch (err) {
    console.error('Erro ao preparar PDF:', err);
    alert('Erro ao preparar a visualiza√ß√£o do PDF. Verifique o console.');
  }
}

function fecharModal() {
  document.getElementById('pdfModal').style.display = 'none';
  document.getElementById('pdfContent').innerHTML = '';
  protocoloParaGerar = null;
}

async function gerarPDF() {
  if (!protocoloParaGerar) {
    alert("Nenhum protocolo para gerar.");
    return;
  }
  const element = document.getElementById('pdfContent');
  const opt = {
    margin: [0, 0, 0, 0],
    filename: `Protocolo_${protocoloParaGerar.numero}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: {
      scale: 2,
      scrollY: 0,
      useCORS: true
    },
    jsPDF: {
      unit: 'mm',
      format: 'a4',
      orientation: 'portrait',
    }
  };
  try {
    await html2pdf().set(opt).from(element).save();
    fecharModal();
  } catch (error) {
    console.error("Erro ao gerar PDF:", error);
    alert("Ocorreu um erro ao gerar o PDF. Por favor, tente novamente.");
  }
}

async function gerarDocumentoPorId(id) {
  try {
    const res = await fetch(`/protocolos/${id}`);
    const { protocolo } = await res.json();
    if (!protocolo) return alert("Protocolo n√£o encontrado");
    previsualizarPDF(protocolo.id);
  } catch (err) {
    console.error("Erro ao gerar documento:", err);
    alert("Erro ao gerar documento.");
  }
}

async function pesquisarProtocolos() {
  try {
    const numero = document.getElementById('filtroNumero').value;
    const nome = document.getElementById('filtroNome').value;
    const status = document.getElementById('filtroStatus').value;
    const res = await fetch(`/protocolos/pesquisa?numero=${numero}&nome=${nome}&status=${status}`);
    const data = await res.json();
    const tbody = document.getElementById('resultadosPesquisa');
    tbody.innerHTML = '';
    if (data.protocolos && data.protocolos.length > 0) {
      data.protocolos.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.numero || ''}</td>
          <td>${p.nome || ''}</td>
          <td>${p.status || ''}</td>
          <td>${p.data_solicitacao ? new Date(p.data_solicitacao).toLocaleDateString() : ''}</td>
          <td>${p.tipo || ''}</td>
          <td>${p.cpf || ''}</td>
        `;
        tbody.appendChild(tr);
      });
    } else {
      tbody.innerHTML = '<tr><td colspan="6">Nenhum protocolo encontrado</td></tr>';
    }
  } catch (error) {
    console.error("Erro ao pesquisar protocolos:", error);
  }
}

async function gerarRelatorio() {
  try {
    const numero = document.getElementById('filtroNumero').value;
    const nome = document.getElementById('filtroNome').value;
    const status = document.getElementById('filtroStatus').value;
    const res = await fetch(`/protocolos/pesquisa?numero=${numero}&nome=${nome}&status=${status}`);
    const data = await res.json();
    if (!data.protocolos || data.protocolos.length === 0) {
      alert("Relat√≥rio n√£o encontrado!");
      return;
    }
    let html = `<h2>Relat√≥rio de Protocolos</h2>`;
    html += `<table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; width: 100%;">`;
    html += `<thead><tr>
      <th style="width: 80px;">N√∫mero</th>
      <th>Nome</th>
      <th>Status</th>
      <th>Data Solicita√ß√£o</th>
      <th>Tipo</th>
      <th>CPF</th>
    </tr></thead><tbody>`;
    data.protocolos.forEach(p => {
      html += `<tr>
        <td>${p.numero || ''}</td>
        <td>${p.nome || ''}</td>
        <td>${p.status || ''}</td>
        <td>${p.data_solicitacao ? new Date(p.data_solicitacao).toLocaleDateString() : ''}</td>
        <td>${p.tipo || ''}</td>
        <td>${p.cpf || ''}</td>
      </tr>`;
    });
    html += `</tbody></table>`;
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;
    document.body.appendChild(tempDiv);
    const opt = {
      margin: 1,
      filename: 'relatorio_protocolos.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
    };
    await html2pdf().set(opt).from(tempDiv).save();
    document.body.removeChild(tempDiv);
  } catch (err) {
    console.error("Erro ao gerar relat√≥rio:", err);
    alert("Erro ao gerar o relat√≥rio.");
  }
}

async function verDetalhes(id) {
  try {
    const res = await fetch(`/protocolos/${id}`);
    const { protocolo } = await res.json();
    if (!protocolo) return alert("Protocolo n√£o encontrado");
    let detalhes = "Detalhes do Protocolo:\n\n";
    const campos = [
      ['N√∫mero', protocolo.numero],
      ['Matr√≠cula', protocolo.matricula],
      ['Nome Completo', protocolo.nome],
      ['Endere√ßo', protocolo.endereco],
      ['Munic√≠pio', protocolo.municipio],
      ['Bairro', protocolo.bairro],
      ['CEP', protocolo.cep],
      ['Telefone', protocolo.telefone],
      ['CPF', protocolo.cpf],
      ['RG', protocolo.rg],
      ['Data de Expedi√ß√£o', protocolo.dataExpedicao],
      ['Cargo/Fun√ß√£o', protocolo.cargo],
      ['Lota√ß√£o', protocolo.lotacao],
      ['Unidade de Exerc√≠cio', protocolo.unidade],
      ['Tipo de Requerimento', protocolo.tipo],
      ['Requer ao', protocolo.requerAo],
      ['Data Solicita√ß√£o', protocolo.dataSolicitacao],
      ['Informa√ß√µes Complementares', protocolo.complemento]
    ];
    campos.forEach(c => detalhes += `${c[0]}: ${c[1] || ''}\n`);
    alert(detalhes);
  } catch (err) {
    alert("Erro ao buscar detalhes.");
    console.error(err);
  }
}

function salvarEmailSistema() {
  emailSistema = document.getElementById('emailSistemaConfig').value;
  localStorage.setItem('emailSistema', emailSistema);
  alert("Email salvo com sucesso!");
}

async function cadastrarUsuario() {
  const nomeCompleto = document.getElementById('nomeCompleto').value.trim();
  const login = document.getElementById('novoUsuario').value.trim();
  const cpf = document.getElementById('cpfUsuario').value.trim();
  const senha = document.getElementById('novaSenha').value.trim();
  const email = document.getElementById('novoEmail').value.trim();
  const tipo = document.getElementById('nivelUsuario').value;
  if (!nomeCompleto || !login || !cpf || !senha || !email || !tipo) {
    alert('Por favor, preencha todos os campos.');
    return;
  }
  try {
    const res = await fetch('/usuarios', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        nome: nomeCompleto,
        login,
        cpf,
        senha,
        email,
        tipo
      })
    });
    const data = await res.json();
    alert(data.mensagem || 'Usu√°rio cadastrado!');
    if (data.sucesso) carregarUsuarios();
  } catch (error) {
    console.error('Erro ao cadastrar usu√°rio:', error);
    alert('Erro ao cadastrar usu√°rio.');
  }
}

async function atualizarListaUsuarios() {
  try {
    const response = await fetch('/usuarios');
    if (!response.ok) throw new Error('Erro ao buscar usu√°rios');
    const data = await response.json();
    const ul = document.getElementById('listaUsuarios');
    ul.innerHTML = "";
    data.usuarios.forEach(u => {
      const li = document.createElement('li');
      li.textContent = `${u.nome} (${u.tipo}) - ${u.email}`;
      ul.appendChild(li);
    });
  } catch (error) {
    alert('Erro ao carregar usu√°rios: ' + error.message);
  }
}

function voltarDeRelatorios() {
  mostrarTela('menu');
}

async function gerarBackup() {
  const dataInicio = document.getElementById('backupDataInicio').value;
  const dataFim = document.getElementById('backupDataFim').value;
  if (!dataInicio || !dataFim) {
    alert("Por favor, selecione o per√≠odo completo (data in√≠cio e fim).");
    return;
  }
  try {
    const url = `/protocolos/backup?dataInicio=${dataInicio}&dataFim=${dataFim}`;
    const response = await fetch(url);
    if (!response.ok) {
      const textoErro = await response.text();
      alert(`Erro ao gerar backup: ${textoErro || response.statusText}`);
      return;
    }
    const blob = await response.blob();
    const urlBlob = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = urlBlob;
    a.download = `backup_protocolos_${dataInicio}_a_${dataFim}.xlsx`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(urlBlob);
  } catch (error) {
    console.error("Erro ao gerar backup:", error);
    alert("Erro ao gerar backup. Veja console.");
  }
}

async function abrirModalEncaminhar(idProtocolo, event) {
  try {
    const res = await fetch('/usuarios');
    const data = await res.json();
    const select = document.getElementById('selectUsuarioEncaminhar');
    select.innerHTML = '';
    data.usuarios.forEach(usuario => {
      const option = document.createElement('option');
      option.value = usuario.login;
      option.textContent = `${usuario.nome_completo || usuario.login} (${usuario.tipo})`;
      select.appendChild(option);
    });
    select.dataset.idProtocolo = idProtocolo;
    const modal = document.getElementById('modalEncaminhar');
    modal.style.position = 'fixed';
    modal.style.top = '50%';
    modal.style.left = '50%';
    modal.style.transform = 'translate(-50%, -50%)';
    modal.style.display = 'flex';
  } catch (error) {
    alert('Erro ao carregar usu√°rios');
    console.error(error);
  }
}

async function confirmarEncaminhamento() {
  const select = document.getElementById('selectUsuarioEncaminhar');
  const idProtocolo = select.dataset.idProtocolo;
  const destino = select.value;
  try {
    const response = await fetch('/protocolos/atualizar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        protocoloId: idProtocolo,
        novoStatus: 'Encaminhado',
        novoResponsavel: destino,
        observacao: `Encaminhado por ${usuarioLogado} para ${destino}`,
        usuarioLogado: usuarioLogado
      })
    });
    const data = await response.json();
    if (data.sucesso) {
      alert('‚úÖ Protocolo encaminhado com sucesso!');
      fecharModalEncaminhar();
      await listarProtocolos();
      await listarMeusProtocolos();
    } else {
      alert('‚ùå Erro ao encaminhar protocolo: ' + (data.mensagem || ''));
    }
  } catch (err) {
    console.error(err);
    alert('‚ùå Erro ao encaminhar protocolo');
  }
}

function fecharModalEncaminhar() {
  const modal = document.getElementById('modalEncaminhar');
  modal.style.display = 'none';
}

function renderizarPaginacao(totalItens, paginaAtual, idContainer, callback) {
  const container = document.getElementById(idContainer);
  container.innerHTML = '';
  const totalPaginas = Math.ceil(totalItens / itensPorPagina);
  if (totalPaginas <= 1) return;
  for (let i = 1; i <= totalPaginas; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.style.margin = '0 2px';
    if (i === paginaAtual) {
      btn.disabled = true;
    }
    btn.onclick = () => callback(i);
    container.appendChild(btn);
  }
}

function voltarDeMeusProtocolos() {
  if (nivelUsuario === 'comum') {
    sair();
  } else {
    mostrarTela('menu');
  }
}

function preencherCamposServidor(servidor) {
  if (!servidor) {
    document.getElementById('nome').value = '';
    document.getElementById('lotacao').value = '';
    document.getElementById('cargo').value = '';
    document.getElementById('unidade').value = '';
  } else {
    document.getElementById('nome').value = servidor.nome || '';
    document.getElementById('lotacao').value = servidor.lotacao || '';
    document.getElementById('cargo').value = servidor.cargo || '';
    document.getElementById('unidade').value = servidor.unidade_de_exercicio || '';
  }
}

document.getElementById('matricula').addEventListener('blur', async function() {
  const matricula = this.value.trim();
  if (!matricula) {
    preencherCamposServidor(null);
    return;
  }
  try {
    const response = await fetch(`/protocolos/servidor/${encodeURIComponent(matricula)}`);
    if (!response.ok) {
      return;
    }
    const servidor = await response.json();
    preencherCamposServidor(servidor);
  } catch (error) {
    console.error('Erro ao buscar servidor:', error);
  }
});

</script>
<script>
document.getElementById('cep').addEventListener('blur', async function () {
  const cep = this.value.replace(/\D/g, '');
  if (cep.length !== 8) {
    alert('CEP inv√°lido. Digite os 8 d√≠gitos.');
    return;
  }
  try {
    const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
    const data = await response.json();
    if (data.erro) {
      alert('CEP n√£o encontrado!');
      return;
    }
    document.getElementById('endereco').value = data.logradouro || '';
    document.getElementById('bairro').value = data.bairro || '';
    document.getElementById('municipio').value = data.localidade || '';
  } catch (error) {
    console.error('Erro ao buscar CEP:', error);
    alert('Erro ao buscar o CEP. Verifique sua conex√£o.');
  }
});
</script>
</body>
</html>
