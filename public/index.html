<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema de Protocolo</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
    }
    .container {
      max-width: 1500px;
      margin: 40px auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      overflow: hidden;
      padding-bottom: 30px;
    }
.header {
  background: #2e7d32;
  color: white;
  padding: 20px;
  text-align: center; /* Centraliza tudo */
}
.content {
  display: none;
}

.content.active {
  display: block;
}


.logo {
  height: 80px; /* Ajuste o tamanho da sua logo aqui */
  margin-bottom: 5 px; /* Espa√ßo entre a logo e os t√≠tulos */
}

.header h2, .header h3 {
  margin: 5px 0; /* Espa√ßamento entre os t√≠tulos */
}
.header {
  border-radius: 0 0 15px 15px; /* Bordas arredondadas na parte de baixo */
  box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Sombra sutil */
}
.header img {
  height: 60px; /* Altura fixa para a logo */
  width: auto;  /* Mant√©m a propor√ß√£o */
}
    .content {
      padding: 20px 30px;
    }
    .menu, .login-screen, .form-screen, .protocolos-screen, .config-screen, .meus-protocolos-screen {
      display: none;
    }
    .active {
      display: block;
    }
    .formulario {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 15px 20px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    .full-row { grid-column: span 12; }
    .span-6 { grid-column: span 6; }
    .span-4 { grid-column: span 4; }
    .span-3 { grid-column: span 3; }
    .span-2 { grid-column: span 2; }
    label { margin-bottom: 5px; font-weight: 600; }
    input, select, textarea {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 8px;
      font-size: 1em;
    }
    button {
      padding: 10px 12px;
      border: none;
      background: #2e7d32;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      margin: 5px 10px 5px 0;
    }
    .log-area {
      margin-top: 20px;
      font-size: 0.9em;
      background: #eee;
      padding: 10px;
      border-radius: 6px;
      min-height: 24px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      vertical-align: top;
    }
    th {
      background-color: #e0e0e0;
    }
    details {
      margin-top: 5px;
      font-size: 0.9em;
    }
    summary {
      cursor: pointer;
      font-weight: bold;
      color: #2e7d32;
    }
/* Estilo da tela de relat√≥rios */
.relatorios-screen {
  display: none;
}

.filtros {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.filtros input, .filtros select {
  padding: 8px;
  border-radius: 4px;
  border: 1px solid #ccc;
}

.relatorios-screen {
  display: none;
  padding: 20px;
}

.filtros {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
  background: #f5f5f5;
  padding: 15px;
  border-radius: 8px;
}

#resultadosPesquisa {
  background: white;
}

    /* Estilo para o documento PDF / impress√£o */
#modeloProtocolo {
  display: none;
  width: 794px;                    /* largura exata de uma folha A4 em 96dpi */
  font-family: 'Times New Roman', serif;
  color: #000;
  background: #fff;
  padding: 30px 40px;
  border: 1px solid #333;
  box-shadow: 0 0 15px rgba(0,0,0,0.3);
  box-sizing: border-box;
  margin: 0 auto;                  /* CENTRALIZA */
}



    #modeloProtocolo h2, #modeloProtocolo h3, #modeloProtocolo h4 {
      margin: 0;
      padding: 0;
    }
    #modeloProtocolo p {
      margin: 6px 0;
    }
  </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

</head>
<body>
  <div class="container">
<div class="header">
  <img src="/img/logo.png" alt="Logo" class="logo">
  <h2>Prefeitura de Morada Nova</h2>
  <h3>Sistema de Protocolo</h3>
</div>

    <div id="login" class="login-screen active content">
      <label>Usu√°rio</label>
      <input type="text" id="usuario" />
      <label>Senha</label>
      <input type="password" id="senha" />
      <button onclick="logar()">Entrar</button>
      <p id="loginMsg" style="color:red;"></p>
    </div>

    <div id="menu" class="menu content">
      <button id="btnNovo" onclick="mostrarTela('form')">Novo Protocolo</button>
      <button onclick="mostrarTela('protocolos')">Todos os Protocolos</button>
<button onclick="mostrarTela('relatorios')" id="btnRelatorios">Relat√≥rios</button>
      <button onclick="mostrarTela('meusProtocolos')">Meus Protocolos</button>
      <button id="btnConfig" onclick="mostrarTela('config')">‚öôÔ∏è Configura√ß√µes</button>
      <button onclick="sair()">Sair</button>
    </div>

    <div id="form" class="form-screen content">
      <form class="formulario" onsubmit="return false;">
        <div class="form-group span-3"><label>N√∫mero do Protocolo</label><input type="text" id="numeroProtocolo" readonly></div>
        <div class="form-group span-3"><label>Matr√≠cula</label><input type="text" id="matricula"></div>
        <div class="form-group span-6"><label>Nome Completo</label><input type="text" id="nome"></div>
        <div class="form-group span-6"><label>Endere√ßo</label><input type="text" id="endereco"></div>
        <div class="form-group span-3"><label>Munic√≠pio</label><input type="text" id="municipio"></div>
        <div class="form-group span-3"><label>Bairro</label><input type="text" id="bairro"></div>
        <div class="form-group span-3"><label>CEP</label><input type="text" id="cep"></div>
        <div class="form-group span-3"><label>Telefone</label><input type="text" id="telefone"></div>
        <div class="form-group span-3"><label>CPF</label><input type="text" id="cpf"></div>
        <div class="form-group span-3"><label>RG</label><input type="text" id="rg"></div>
        <div class="form-group span-3"><label>Data de Expedi√ß√£o</label><input type="date" id="dataExpedicao"></div>
        <div class="form-group span-3"><label>Cargo/Fun√ß√£o</label><input type="text" id="cargo"></div>
        <div class="form-group span-6"><label>Lota√ß√£o</label><input type="text" id="lotacao"></div>
        <div class="form-group span-6"><label>Unidade de Exerc√≠cio</label><input type="text" id="unidade"></div>
       <div class="form-group span-6">
  <label>Tipo de Requerimento</label>
  <select id="tipo">
    <option value="">Selecione...</option>
    <option value="Adicional de tempo de servi√ßos">Adicional de tempo de servi√ßos</option>
    <option value="Adicional de insalubridade">Adicional de insalubridade</option>
    <option value="Adicional de periculosidade">Adicional de periculosidade</option>
    <option value="Adicional de atividades penosas">Adicional de atividades penosas</option>
    <option value="Adicional por servi√ßos extraordin√°rios">Adicional por servi√ßos extraordin√°rios</option>
    <option value="Adicional noturno">Adicional noturno</option>
    <option value="Adicional de f√©rias">Adicional de f√©rias</option>
    <option value="Afastamento p. servir a outro √≥rg√£o ou entidade">Afastamento p. servir a outro √≥rg√£o ou entidade</option>
    <option value="Afastamento para exerc√≠cio de mandato eletivo">Afastamento para exerc√≠cio de mandato eletivo</option>
    <option value="Afastamento para estudo fora do munic√≠pio">Afastamento para estudo fora do munic√≠pio</option>
    <option value="Altera√ß√£o do cadastro funcional/pessoal">Altera√ß√£o do cadastro funcional/pessoal</option>
    <option value="Aposentadoria">Aposentadoria</option>
    <option value="Certid√£o por tempo de contribui√ß√£o">Certid√£o por tempo de contribui√ß√£o</option>
    <option value="C√≥pia de Documenta√ß√£o">C√≥pia de Documenta√ß√£o</option>
    <option value="Declara√ß√£o">Declara√ß√£o</option>
    <option value="Exonera√ß√£o de cargo/fun√ß√£o">Exonera√ß√£o de cargo/fun√ß√£o</option>
    <option value="F√©rias">F√©rias</option>
    <option value="Ficha financeira">Ficha financeira</option>
    <option value="Gratifica√ß√£o natalina">Gratifica√ß√£o natalina</option>
    <option value="Gratifica√ß√£o de incentivo profissional">Gratifica√ß√£o de incentivo profissional</option>
    <option value="Gratifica√ß√£o p√≥s-gradua√ß√£o">Gratifica√ß√£o p√≥s-gradua√ß√£o</option>
    <option value="Gratifica√ß√£o retribui√ß√£o pecuni√°ria">Gratifica√ß√£o retribui√ß√£o pecuni√°ria</option>
    <option value="Gratifica√ß√£o de dif√≠cil acesso">Gratifica√ß√£o de dif√≠cil acesso</option>
    <option value="Licen√ßa para atividades pol√≠ticas">Licen√ßa para atividades pol√≠ticas</option>
    <option value="Licen√ßa para capacita√ß√£o">Licen√ßa para capacita√ß√£o</option>
    <option value="Licen√ßa para desempenho de mandato classista">Licen√ßa para desempenho de mandato classista</option>
    <option value="Licen√ßa por motivo de doen√ßa na fam√≠lia">Licen√ßa por motivo de doen√ßa na fam√≠lia</option>
    <option value="Licen√ßa por motivo de afastamento do c√¥njuge">Licen√ßa por motivo de afastamento do c√¥njuge</option>
    <option value="Licen√ßa para servi√ßo militar">Licen√ßa para servi√ßo militar</option>
    <option value="Licen√ßa para tratar de interesse particular">Licen√ßa para tratar de interesse particular</option>
    <option value="Licen√ßa Especial">Licen√ßa Especial</option>
    <option value="Reposi√ß√£o de faltas">Reposi√ß√£o de faltas</option>
    <option value="Outros">Outros</option>
  </select>
</div>

        <div class="form-group span-6"><label>Requer ao</label><input type="text" id="requerAo"></div>
        <div class="form-group span-3"><label>Data Solicita√ß√£o</label><input type="date" id="dataSolicitacao"></div>
       <div class="form-group full-row">
  <label>Informa√ß√µes Complementares</label>
  <textarea id="complemento" rows="8"></textarea>
</div>

      </form>
      <button onclick="enviarRequerimento()">Enviar Requerimento</button>
      <button onclick="window.print()">Imprimir</button>
      <button onclick="mostrarTela('menu')">Voltar</button>
      <div id="log" class="log-area"></div>
    </div>




<!-- Adicione isso junto com as outras telas (perto de <div id="protocolos">) -->
<div id="relatorios" class="relatorios-screen content">
  <h3>üîç Pesquisar Protocolos</h3>
  
  <!-- Filtros de Pesquisa -->
  <div class="filtros">
    <input type="text" id="filtroNumero" placeholder="N√∫mero do Protocolo">
    <input type="text" id="filtroNome" placeholder="Nome do Requerente">
    <select id="filtroStatus">
      <option value="">Todos os status</option>
      <option value="Aberto">Aberto</option>
      <option value="Em an√°lise">Em an√°lise</option>
      <option value="Conclu√≠do">Conclu√≠do</option>
    </select>
    <button onclick="pesquisarProtocolos()">Pesquisar</button>
    <button onclick="gerarRelatorio()">üìä Gerar Relat√≥rio</button>
    <button onclick="voltarDeRelatorios()">üîô Voltar</button>
  </div>

  <!-- Resultados -->
  <table>
    <thead>
      <tr>
        <th>N√∫mero</th>
        <th>Nome</th>
        <th>Status</th>
        <th>Data Solicita√ß√£o</th>
        <th>Tipo</th>
        <th>CPF</th>
      </tr>
    </thead>
    <tbody id="resultadosPesquisa"></tbody>
  </table>
</div>




    <div id="protocolos" class="protocolos-screen content">
      <h3>üìã Lista de Protocolos Enviados</h3>
      <table>
        <thead>
          <tr>
	    <th>N√∫mero</th>
            <th>Matr√≠cula</th>
            <th>Nome</th>
            <th>Tipo</th>
            <th>Status</th>
            <th>Respons√°vel</th>
            <th>A√ß√£o</th>
          </tr>
        </thead>
        <tbody id="tabelaProtocolos"></tbody>
      </table>
      <button onclick="mostrarTela('menu')">Voltar</button>
    </div>

    <div id="meusProtocolos" class="meus-protocolos-screen content">
      <h3>üìÇ Meus Protocolos</h3>
      <table>
        <thead>
          <tr>
            <th>N√∫mero</th>
            <th>Nome</th>
            <th>Status</th>
            <th>A√ß√£o</th>
          </tr>
        </thead>
        <tbody id="meusProtocolosTabela"></tbody>
      </table>
      <button onclick="voltarDeMeusProtocolos()">Voltar</button>
    </div>

    <div id="config" class="config-screen content">
      <h3>‚öôÔ∏è Configura√ß√µes</h3>
      <div class="form-group full-row">
        <label>Email do Sistema:</label>
        <input type="email" id="emailSistemaConfig" />
        <button onclick="salvarEmailSistema()">Salvar Email</button>
      </div>
      <div class="form-group full-row">
  <label>Adicionar Novo Usu√°rio:</label>
  <input type="text" id="novoUsuario" placeholder="Nome do usu√°rio" />
  <input type="password" id="novaSenha" placeholder="Senha" />
  <input type="email" id="novoEmail" placeholder="E-mail do usu√°rio" />
  <select id="nivelUsuario">
    <option value="comum">Comum</option>
    <option value="padrao">Padr√£o</option>
    <option value="admin">Administrador</option>
  </select>
  <button onclick="cadastrarUsuario()">Cadastrar Usu√°rio</button>
</div>

	<h4>Gerar Backup de Protocolos</h4>
<label>Data In√≠cio:</label>
<input type="date" id="backupDataInicio" />
<label>Data Fim:</label>
<input type="date" id="backupDataFim" />
<button onclick="gerarBackup()">Gerar Backup</button>

      <h4>Usu√°rios Cadastrados:</h4>
      <ul id="listaUsuarios"></ul>
      <button onclick="mostrarTela('menu')">Voltar</button>
    </div>
  </div>

 <!-- Modelo padr√£o do protocolo para impress√£o/PDF -->
<!-- Modelo completo do PDF -->
<div id="modeloProtocolo" style="display: none;">
  <style>
    .doc-container {
      width: 100%;
      max-width: 700px;
      margin: 0 auto;
      font-family: 'Arial', sans-serif;
      padding: 20px;
      color: #000;
    }
    .header-pdf {
      text-align: center;
      margin-bottom: 20px;
      border-bottom: 3px solid #2e7d32;
      padding-bottom: 15px;
    }
    .header-pdf img {
      height: 80px;
      margin-bottom: 10px;
    }
    .titulo-pdf {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
      color: #2e7d32;
    }
    .dados-protocolo p {
      margin: 8px 0;
    }
    .dados-section {
      margin: 20px 0;
    }
    .dados-section h4 {
      color: #2e7d32;
      border-bottom: 1px solid #2e7d32;
      padding-bottom: 5px;
      margin-bottom: 10px;
    }
    .assinaturas {
      display: flex;
      justify-content: space-between;
      margin-top: 80px;
    }
    .assinatura {
      text-align: center;
      width: 45%;
      border-top: 1px solid #000;
      padding-top: 10px;
      font-size: 14px;
    }
    #doc_complemento {
      background: #f9f9f9;
      border: 1px solid #ddd;
      padding: 10px;
      margin-top: 5px;
    }
  </style>

  <div class="doc-container">
    <!-- Cabe√ßalho com Logo -->
    <div class="header-pdf">
      <img src="/img/logo.png" alt="Logo">
      <h2>Secretaria da Administra√ß√£o</h2>
      <h3 class="titulo-pdf">PROTOCOLO DE REQUERIMENTO</h3>
    </div>

    <!-- Dados B√°sicos -->
    <div class="dados-protocolo">
      <p><strong>N√∫mero do Protocolo:</strong> <span id="doc_numero"></span></p>
      <p><strong>Data de Solicita√ß√£o:</strong> <span id="doc_dataSolicitacao"></span></p>
    </div>

    <!-- Dados do Requerente -->
    <div class="dados-section">
      <h4>DADOS DO REQUERENTE</h4>
      <div class="dados-protocolo">
        <p><strong>Nome:</strong> <span id="doc_nome"></span></p>
        <p><strong>Matr√≠cula:</strong> <span id="doc_matricula"></span></p>
        <p><strong>CPF:</strong> <span id="doc_cpf"></span></p>
        <p><strong>RG:</strong> <span id="doc_rg"></span></p>
        <p><strong>Endere√ßo:</strong> <span id="doc_endereco"></span></p>
        <p><strong>Bairro:</strong> <span id="doc_bairro"></span></p>
        <p><strong>Munic√≠pio:</strong> <span id="doc_municipio"></span></p>
        <p><strong>CEP:</strong> <span id="doc_cep"></span></p>
        <p><strong>Telefone:</strong> <span id="doc_telefone"></span></p>
        <p><strong>Cargo/Fun√ß√£o:</strong> <span id="doc_cargo"></span></p>
        <p><strong>Lota√ß√£o:</strong> <span id="doc_lotacao"></span></p>
        <p><strong>Unidade de Exerc√≠cio:</strong> <span id="doc_unidade"></span></p>
      </div>
    </div>

    <!-- Dados do Requerimento -->
    <div class="dados-section">
      <h4>DADOS DO REQUERIMENTO</h4>
      <div class="dados-protocolo">
        <p><strong>Tipo de Requerimento:</strong> <span id="doc_tipo"></span></p>
        <p><strong>Requer ao:</strong> <span id="doc_requerAo"></span></p>
        <p><strong>Informa√ß√µes Complementares:</strong></p>
        <div id="doc_complemento"></div>
      </div>
    </div>

    <!-- Assinaturas -->
    <div class="assinaturas">
      <div class="assinatura">
        Assinatura do Requerente
      </div>
      <div class="assinatura">
        Respons√°vel pelo Protocolo
      </div>
    </div>
  </div>
</div>


 <script defer>
    let usuarios = []; // N√£o usa mais localStorage, os usu√°rios v√™m do backend


    let emailSistema = localStorage.getItem('emailSistema') || "";
    
    let usuarioLogado = "";
    let nivelUsuario = "";

 document.addEventListener('DOMContentLoaded', () => {
    usuarioLogado = localStorage.getItem('usuarioLogado') || "";
    nivelUsuario = localStorage.getItem('nivelUsuario') || "";
    
    console.log("Verificando sess√£o:", usuarioLogado, nivelUsuario); // Debug
    
    if (usuarioLogado) {
      // Atualiza a interface
      document.getElementById('btnConfig').style.display = nivelUsuario === "admin" ? "inline-block" : "none";
      document.getElementById('btnNovo').style.display = (nivelUsuario === "admin" || nivelUsuario === "padrao") ? "inline-block" : "none";
      document.getElementById('btnRelatorios').style.display = (nivelUsuario === "admin" || nivelUsuario === "padrao") ? "inline-block" : "none";
      
      // Redireciona
      if (nivelUsuario === "comum") {
        mostrarTela('meusProtocolos');
      } else {
        mostrarTela('menu');
      }
    } else {
      mostrarTela('login');
    }
  });

  window.logar = function() {
  const user = document.getElementById('usuario').value;
  const senha = document.getElementById('senha').value;
  const msg = document.getElementById('loginMsg');

  fetch('/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ login: user, senha: senha })
  })
  .then(res => res.json())
  .then(data => {
    if (data.sucesso && data.usuario) {
      // Armazena no localStorage
      localStorage.setItem('usuarioLogado', data.usuario.nome);
      localStorage.setItem('nivelUsuario', data.usuario.tipo);
      
      // Atualiza as vari√°veis
      usuarioLogado = data.usuario.nome;
      nivelUsuario = data.usuario.tipo;

      // Atualiza a interface
      document.getElementById('btnConfig').style.display = nivelUsuario === "admin" ? "inline-block" : "none";
      document.getElementById('btnNovo').style.display = (nivelUsuario === "admin" || nivelUsuario === "padrao") ? "inline-block" : "none";
      document.getElementById('btnRelatorios').style.display = (nivelUsuario === "admin" || nivelUsuario === "padrao") ? "inline-block" : "none";

      // Redireciona
      if (nivelUsuario === "comum") {
        mostrarTela('meusProtocolos');
      } else {
        mostrarTela('menu');
      }

      msg.textContent = "";
    } else {
      msg.textContent = "Usu√°rio ou senha incorretos.";
    }
  })
  .catch(err => {
    console.error("Erro no login:", err);
    msg.textContent = "Erro ao conectar ao servidor.";
  });
}


  function mostrarTela(tela) {
  ['login','menu','form','config','protocolos','meusProtocolos','relatorios'].forEach(id => {
    document.getElementById(id).classList.remove('active');
  });

  if (tela === 'relatorios' && nivelUsuario === 'comum') {
    alert('Acesso restrito!');
    return;
  }

  document.getElementById(tela).classList.add('active');

  // Executa as a√ß√µes espec√≠ficas de cada tela
  if (tela === 'protocolos') listarProtocolos();
  if (tela === 'meusProtocolos') listarMeusProtocolos();
  if (tela === 'form') gerarNumeroProtocolo();
  if (tela === 'config') atualizarListaUsuarios();
  if (tela === 'relatorios') pesquisarProtocolos();
}


function sair() {
  // Limpa tudo
  localStorage.removeItem('usuarioLogado');
  localStorage.removeItem('nivelUsuario');
  usuarioLogado = "";
  nivelUsuario = "";
  
  // Reseta a interface
  document.getElementById('usuario').value = "";
  document.getElementById('senha').value = "";
  
  // Esconde todos os bot√µes restritos
  document.getElementById('btnConfig').style.display = 'none';
  document.getElementById('btnNovo').style.display = 'none';
  document.getElementById('btnRelatorios').style.display = 'none';
  
  // For√ßa mostrar a tela de login
  mostrarTela('login');
  
  // Adicione este redirecionamento para garantir
  window.location.href = window.location.href.split('?')[0];
}

  async function gerarNumeroProtocolo() {
  const anoAtual = new Date().getFullYear();

  try {
    const res = await fetch(`/protocolos/ultimoNumero/${anoAtual}`);
    const data = await res.json();
    const ultimo = data.ultimo || 0;

    const novoNumero = `${anoAtual}-${String(ultimo + 1).padStart(4, '0')}`;
    document.getElementById('numeroProtocolo').value = novoNumero;
    document.getElementById('log').innerText = 'üìÑ N√∫mero gerado: ' + novoNumero;
  } catch (error) {
    console.error("Erro ao gerar n√∫mero:", error);
    document.getElementById('numeroProtocolo').value = `${anoAtual}-0001`;
    document.getElementById('log').innerText = '‚ö†Ô∏è N√∫mero gerado localmente: ' + `${anoAtual}-0001`;
  }
}





   function enviarRequerimento() {
  const numeroProtocolo = document.getElementById('numeroProtocolo').value;
  if (!numeroProtocolo) {
    alert("‚ùóN√∫mero de protocolo n√£o gerado.");
    return;
  }

  const dataAgora = new Date().toLocaleString();
  const protocolo = {
    numero: numeroProtocolo,
    matricula: document.getElementById('matricula').value,
    nome: document.getElementById('nome').value,
    endereco: document.getElementById('endereco').value,
    municipio: document.getElementById('municipio').value,
    bairro: document.getElementById('bairro').value,
    cep: document.getElementById('cep').value,
    telefone: document.getElementById('telefone').value,
    cpf: document.getElementById('cpf').value,
    rg: document.getElementById('rg').value,
    dataExpedicao: document.getElementById('dataExpedicao').value,
    cargo: document.getElementById('cargo').value,
    lotacao: document.getElementById('lotacao').value,
    unidade: document.getElementById('unidade').value,
    tipo: document.getElementById('tipo').value,
    requerAo: document.getElementById('requerAo').value,
    dataSolicitacao: document.getElementById('dataSolicitacao').value,
    complemento: document.getElementById('complemento').value,
    dataEnvio: dataAgora,
    status: "Enviado",
    responsavel: usuarioLogado,
    movimentacoes: [
      { data: dataAgora, acao: "Criado e enviado", autor: usuarioLogado }
    ]
  };

  fetch('/protocolos', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(protocolo)
  })
  .then(res => res.json())
  .then(data => {
    if (data.sucesso) {
      alert('‚úÖ Protocolo enviado e salvo no banco com sucesso!');
      document.querySelector('.formulario').reset();
      gerarNumeroProtocolo(); // Gera o pr√≥ximo n√∫mero para novo envio
    } else {
      alert('‚ùå Erro ao enviar protocolo: ' + (data.mensagem || 'Erro desconhecido'));
    }
  })
  .catch(err => {
    alert('‚ùå Erro na conex√£o: ' + err.message);
  });
}


  

async function listarProtocolos() {
  const tbody = document.getElementById('tabelaProtocolos');
  tbody.innerHTML = "";

  try {
    const res = await fetch('/protocolos');
    const data = await res.json();

    data.protocolos.forEach((p, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <tr>
  	<td style="width: 80px; text-align: center;">${p.numero}</td>
	<td>${p.matricula}</td>
        <td>${p.nome}</td>
        <td>${p.tipo_requerimento}</td>
        <td>${p.status}</td>
        <td>${p.responsavel}</td>
        <td>
          <button onclick="abrirAtualizar(${p.id})">Atualizar</button>
          <button onclick="abrirEncaminhar(${p.id})">Encaminhar</button>
          <button onclick="verDetalhes(${p.id})">Ver Detalhes</button>
          <button onclick="gerarPDFPorId(${p.id})">üìÑ Documento</button>

          <details id="hist_${p.id}">
            <summary>Hist√≥rico</summary>
          </details>
        </td>`;
      tbody.appendChild(tr);

      setTimeout(() => {
        carregarHistorico(p.id);
      }, 100);
    });
  } catch (error) {
    console.error("Erro ao listar protocolos:", error);
    alert("Erro ao buscar protocolos do banco.");
  }
}




async function listarMeusProtocolos() {
  const tbody = document.getElementById('meusProtocolosTabela');
  tbody.innerHTML = "";

  try {
    const res = await fetch('/protocolos');
    const data = await res.json();

    const protocolosFiltrados = data.protocolos.filter(p => p.responsavel === usuarioLogado);

    for (const p of protocolosFiltrados) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.numero}</td>
        <td>${p.nome}</td>
        <td>${p.status}</td>
        <td>
          <button onclick="abrirAtualizar(${p.id})">Atualizar</button>
          <button onclick="abrirEncaminhar(${p.id})">Encaminhar</button>
          <button onclick="verDetalhes(${p.id})">Ver Detalhes</button>
          <button onclick="gerarPDFPorId(${p.id})">üìÑ Documento</button>
          <details id="hist_${p.id}">
            <summary>Hist√≥rico</summary>
          </details>
        </td>`;
      
      tbody.appendChild(tr);

      // ‚úÖ D√° tempo do banco salvar o hist√≥rico antes de tentar busc√°-lo
      setTimeout(() => {
        carregarHistorico(p.id);
      }, 100);
    }

  } catch (error) {
    console.error("Erro ao listar meus protocolos:", error);
    alert("Erro ao buscar dados.");
  }
}




  async function abrirEncaminhar(id) {
  const novoResp = prompt("Para qual usu√°rio deseja encaminhar?");
  if (novoResp) {
    try {
      const response = await fetch(`/protocolos/atualizar`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          protocoloId: id,
          novoStatus: "Encaminhado",
          novoResponsavel: novoResp,
          observacao: `Encaminhado por ${usuarioLogado} para ${novoResp}`, // üëà Mostra QUEM encaminhou
          usuarioLogado: usuarioLogado // üëà Envia quem est√° fazendo a a√ß√£o
        })
      });
      
      const data = await response.json();
      
      if (data.sucesso) {
        alert("‚úÖ Protocolo encaminhado com sucesso!");
        await carregarHistorico(id);
        
        // Atualiza as listas se estiverem vis√≠veis
        if (document.getElementById('protocolos').classList.contains('active')) {
          await listarProtocolos();
        }
        if (document.getElementById('meusProtocolos').classList.contains('active')) {
          await listarMeusProtocolos();
        }
      } else {
        alert("Erro ao encaminhar protocolo.");
      }
    } catch (error) {
      console.error("Erro no encaminhamento:", error);
    }
  }
}




async function abrirAtualizar(id) {
  const novoStatus = prompt("Digite o novo status:");
  if (novoStatus) {
    try {
      const response = await fetch(`/protocolos/atualizar`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          protocoloId: id,
          novoStatus,
          novoResponsavel: usuarioLogado, // Garante que o respons√°vel √© o usu√°rio atual
          observacao: `Status atualizado por ${usuarioLogado} para ${novoStatus}`,
          usuarioLogado: usuarioLogado
        })
      });
      
        const data = await response.json();
      
      if (data.sucesso) {
        alert("‚úÖ Status atualizado!");
        // Recarrega o hist√≥rico imediatamente ap√≥s a atualiza√ß√£o
        await carregarHistorico(id);
        
        // Atualiza ambas as listas
        if (document.getElementById('protocolos').classList.contains('active')) {
          await listarProtocolos();
        }
        if (document.getElementById('meusProtocolos').classList.contains('active')) {
          await listarMeusProtocolos();
        }
      } else {
        alert("Erro ao atualizar.");
      }
    } catch (error) {
      console.error("Erro na atualiza√ß√£o:", error);
      }
  }
}



async function carregarHistorico(protocoloId) {
  try {
    const res = await fetch(`/protocolos/historico/${protocoloId}`);
    const data = await res.json();

    // Tenta encontrar o elemento em ambas as telas
    let details = document.getElementById('hist_' + protocoloId);
    if (!details) {
      // Se n√£o encontrou na tela atual, tenta na outra tabela
      const otherTable = document.getElementById('tabelaProtocolos') || 
                         document.getElementById('meusProtocolosTabela');
      if (otherTable) {
        details = otherTable.querySelector('#hist_' + protocoloId);
      }
    }

    if (details) {
      details.innerHTML = `<summary>Hist√≥rico</summary>`;
      data.historico.forEach(h => {
        const div = document.createElement('div');
        div.textContent = `üìå ${h.status} - üë§ ${h.responsavel} - üïí ${new Date(h.data_movimentacao).toLocaleString()}${h.observacao ? ` - üìù ${h.observacao}` : ''}`;
        details.appendChild(div);
      });
    }
  } catch (error) {
    console.error("Erro ao carregar hist√≥rico:", error);
  }
}


async function gerarDocumentoPorId(id) {
  try {
    const res = await fetch(`/protocolos/${id}`);
    const { protocolo } = await res.json();
    if (!protocolo) return alert("Protocolo n√£o encontrado");

    gerarDocumentoCompleto(protocolo); // sua fun√ß√£o j√° existente para gerar o documento
  } catch (err) {
    console.error("Erro ao gerar documento:", err);
    alert("Erro ao gerar documento.");
  }
}

async function gerarPDFPorId(id) {
  try {
    // 1. Busca o protocolo
    const res = await fetch(`/protocolos/${id}`);
    const { protocolo } = await res.json();
    if (!protocolo) {
      alert("Protocolo n√£o encontrado");
      return;
    }

    // 2. Preenche o modelo
    document.getElementById('doc_numero').textContent         = protocolo.numero              ?? 'N√£o informado';
    document.getElementById('doc_dataSolicitacao').textContent= protocolo.data_solicitacao    ?? 'N√£o informada';
    document.getElementById('doc_nome').textContent           = protocolo.nome                ?? 'N√£o informado';
    document.getElementById('doc_matricula').textContent      = protocolo.matricula           ?? 'N√£o informada';
    document.getElementById('doc_cpf').textContent            = protocolo.cpf                 ?? 'N√£o informado';
    document.getElementById('doc_rg').textContent             = protocolo.rg                  ?? 'N√£o informado';
    document.getElementById('doc_endereco').textContent       = protocolo.endereco            ?? 'N√£o informado';
    document.getElementById('doc_bairro').textContent         = protocolo.bairro              ?? 'N√£o informado';
    document.getElementById('doc_municipio').textContent      = protocolo.municipio           ?? 'N√£o informado';
    document.getElementById('doc_cep').textContent            = protocolo.cep                 ?? 'N√£o informado';
    document.getElementById('doc_telefone').textContent       = protocolo.telefone            ?? 'N√£o informado';
    document.getElementById('doc_cargo').textContent          = protocolo.cargo               ?? 'N√£o informado';
    document.getElementById('doc_lotacao').textContent        = protocolo.lotacao             ?? 'N√£o informado';
    document.getElementById('doc_unidade').textContent        = protocolo.unidade_exercicio   ?? 'N√£o informado';
    document.getElementById('doc_tipo').textContent           = protocolo.tipo_requerimento   ?? 'N√£o informado';
    document.getElementById('doc_requerAo').textContent       = protocolo.requer_ao           ?? 'N√£o informado';
    document.getElementById('doc_complemento').innerHTML      = protocolo.observacoes
      ? protocolo.observacoes.replace(/\n/g, '<br>')
      : 'Nenhuma informa√ß√£o adicional';

    // 3. Op√ß√µes do PDF (ajuste principal: margem esquerda maior)
  const opt = {
  margin: 10, // uniforme em todos os lados
  filename: `Protocolo_${protocolo.numero}.pdf`,
  image: { type: 'jpeg', quality: 1 },
  html2canvas: {
    scale: 2,                      // 2 j√° √© mais que suficiente
    useCORS: true
  },
  jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
};


    // 4. Gera√ß√£o do PDF
    const element = document.getElementById('modeloProtocolo');
    element.style.display = 'block';    // torna o modelo vis√≠vel
    await html2pdf().set(opt).from(element).save();
    element.style.display = 'none';     // esconde de novo
  } catch (err) {
    console.error('Erro ao gerar PDF:', err);
    alert('Erro ao gerar PDF. Verifique o console para detalhes.');
  }
}



async function pesquisarProtocolos() {
  try {
    const numero = document.getElementById('filtroNumero').value;
    const nome = document.getElementById('filtroNome').value;
    const status = document.getElementById('filtroStatus').value;

    const res = await fetch(`/protocolos/pesquisa?numero=${numero}&nome=${nome}&status=${status}`);
    const data = await res.json();

    const tbody = document.getElementById('resultadosPesquisa');
    tbody.innerHTML = '';

    if (data.protocolos && data.protocolos.length > 0) {
      data.protocolos.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.numero || ''}</td>
          <td>${p.nome || ''}</td>
          <td>${p.status || ''}</td>
          <td>${p.data_solicitacao ? new Date(p.data_solicitacao).toLocaleDateString() : ''}</td>
          <td>${p.tipo || ''}</td>
          <td>${p.cpf || ''}</td>
        `;
        tbody.appendChild(tr);
      });
    } else {
      tbody.innerHTML = '<tr><td colspan="6">Nenhum protocolo encontrado</td></tr>';
    }
  } catch (error) {
    console.error("Erro ao pesquisar protocolos:", error);
  }
}



// Fun√ß√£o para gerar relat√≥rio em PDF
async function gerarRelatorio() {
  try {
    const numero = document.getElementById('filtroNumero').value;
    const nome = document.getElementById('filtroNome').value;
    const status = document.getElementById('filtroStatus').value;

    const res = await fetch(`/protocolos/pesquisa?numero=${numero}&nome=${nome}&status=${status}`);
    const data = await res.json();

    if (!data.protocolos || data.protocolos.length === 0) {
      alert("Relat√≥rio n√£o encontrado!");
      return;
    }

    let html = `<h2>Relat√≥rio de Protocolos</h2>`;
    html += `<table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; width: 100%;">`;
    html += `<thead><tr>
      <th style="width: 80px;">N√∫mero</th>
      <th>Nome</th>
      <th>Status</th>
      <th>Data Solicita√ß√£o</th>
      <th>Tipo</th>
      <th>CPF</th>
    </tr></thead><tbody>`;

    data.protocolos.forEach(p => {
      html += `<tr>
        <td>${p.numero || ''}</td>
        <td>${p.nome || ''}</td>
        <td>${p.status || ''}</td>
        <td>${p.data_solicitacao ? new Date(p.data_solicitacao).toLocaleDateString() : ''}</td>
        <td>${p.tipo || ''}</td>
        <td>${p.cpf || ''}</td>
      </tr>`;
    });

    html += `</tbody></table>`;

    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;
    document.body.appendChild(tempDiv);

    const opt = {
      margin: 1,
      filename: 'relatorio_protocolos.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
    };

    await html2pdf().set(opt).from(tempDiv).save();
    document.body.removeChild(tempDiv);

  } catch (err) {
    console.error("Erro ao gerar relat√≥rio:", err);
    alert("Erro ao gerar o relat√≥rio.");
  }
}




	async function verDetalhes(id) {
  try {
    const res = await fetch(`/protocolos/${id}`);
    const { protocolo } = await res.json();
    if (!protocolo) return alert("Protocolo n√£o encontrado");

    let detalhes = "Detalhes do Protocolo:\n\n";
    const campos = [
      ['N√∫mero', protocolo.numero],
      ['Matr√≠cula', protocolo.matricula],
      ['Nome Completo', protocolo.nome],
      ['Endere√ßo', protocolo.endereco],
      ['Munic√≠pio', protocolo.municipio],
      ['Bairro', protocolo.bairro],
      ['CEP', protocolo.cep],
      ['Telefone', protocolo.telefone],
      ['CPF', protocolo.cpf],
      ['RG', protocolo.rg],
      ['Data de Expedi√ß√£o', protocolo.dataExpedicao],
      ['Cargo/Fun√ß√£o', protocolo.cargo],
      ['Lota√ß√£o', protocolo.lotacao],
      ['Unidade de Exerc√≠cio', protocolo.unidade],
      ['Tipo de Requerimento', protocolo.tipo],
      ['Requer ao', protocolo.requerAo],
      ['Data Solicita√ß√£o', protocolo.dataSolicitacao],
      ['Informa√ß√µes Complementares', protocolo.complemento]
    ];
    campos.forEach(c => detalhes += `${c[0]}: ${c[1] || ''}\n`);
    alert(detalhes);

  } catch (err) {
    alert("Erro ao buscar detalhes.");
    console.error(err);
  }
}



    
    function salvarEmailSistema() {
      emailSistema = document.getElementById('emailSistemaConfig').value;
      localStorage.setItem('emailSistema', emailSistema);
      alert("Email salvo com sucesso!");
    }

function cadastrarUsuario() {
  const nome = document.getElementById('novoUsuario').value.trim();
  const senha = document.getElementById('novaSenha').value.trim();
  const tipo = document.getElementById('nivelUsuario').value;
  const email = document.getElementById('novoEmail').value.trim();

  if (!nome || !senha || !tipo || !email) {
    alert("Preencha todos os campos, incluindo o e-mail.");
    return;
  }

  fetch('/usuarios', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      nome: nome,
      login: nome.toLowerCase(),
      senha: senha,
      tipo: tipo,
      email: email
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.sucesso) {
      alert("‚úÖ Usu√°rio cadastrado com sucesso!");
      document.getElementById('novoUsuario').value = "";
      document.getElementById('novaSenha').value = "";
      document.getElementById('novoEmail').value = "";
      atualizarListaUsuarios();
    } else {
      alert("‚ùå Erro ao cadastrar: " + (data.mensagem || "Erro desconhecido"));
    }
  })
  .catch(err => {
    console.error("Erro ao cadastrar usu√°rio:", err);
    alert("‚ùå Erro ao conectar ao servidor.");
  });
}



async function atualizarListaUsuarios() {
  try {
    const response = await fetch('/usuarios');
    if (!response.ok) throw new Error('Erro ao buscar usu√°rios');
    const data = await response.json();

    const ul = document.getElementById('listaUsuarios');
    ul.innerHTML = "";

    data.usuarios.forEach(u => {
      const li = document.createElement('li');
      li.textContent = `${u.nome} (${u.tipo}) - ${u.email}`;
      ul.appendChild(li);
    });
  } catch (error) {
    alert('Erro ao carregar usu√°rios: ' + error.message);
  }
}

function voltarDeRelatorios() {
  mostrarTela('menu'); // ou outra tela que desejar
}

async function gerarBackup() {
  const dataInicio = document.getElementById('backupDataInicio').value;
  const dataFim = document.getElementById('backupDataFim').value;

  if (!dataInicio || !dataFim) {
    alert("Por favor, selecione o per√≠odo completo (data in√≠cio e fim).");
    return;
  }

  try {
    const url = `/protocolos/backup?dataInicio=${dataInicio}&dataFim=${dataFim}`;
    const response = await fetch(url);

    if (!response.ok) {
      const textoErro = await response.text();
      alert(`Erro ao gerar backup: ${textoErro || response.statusText}`);
      return;
    }

    const blob = await response.blob();
    const urlBlob = window.URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = urlBlob;
    a.download = `backup_protocolos_${dataInicio}_a_${dataFim}.xlsx`;
    document.body.appendChild(a);
    a.click();
    a.remove();

    window.URL.revokeObjectURL(urlBlob);

  } catch (error) {
    console.error("Erro ao gerar backup:", error);
    alert("Erro ao gerar backup. Veja console.");
  }
}


    function voltarDeMeusProtocolos() {
      if (nivelUsuario === 'comum') {
        sair();
      } else {
        mostrarTela('menu');
      }
    }



  </script>

<script>
  document.getElementById('cep').addEventListener('blur', async function () {
    const cep = this.value.replace(/\D/g, '');

    if (cep.length !== 8) {
      alert('CEP inv√°lido. Digite os 8 d√≠gitos.');
      return;
    }

    try {
      const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
      const data = await response.json();

      if (data.erro) {
        alert('CEP n√£o encontrado!');
        return;
      }

      document.getElementById('endereco').value = data.logradouro || '';
      document.getElementById('bairro').value = data.bairro || '';
      document.getElementById('municipio').value = data.localidade || '';
    } catch (error) {
      console.error('Erro ao buscar CEP:', error);
      alert('Erro ao buscar o CEP. Verifique sua conex√£o.');
    }
  });
</script>

</body>
</html>
